<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© â€” Ù†Ø³Ø®Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© Ù…Ø¶ØºÙˆØ·Ø©</title><meta name="theme-color" content="#58a8ff"/><style>
:root{--b:#58a8ff;--bs:#eaf3ff;--ln:#e5e7eb;--card:#fff;--d:#dc3545;--ok:#16a34a;--m:#64748b;--ink:#0f172a}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:Tahoma,Arial,sans-serif;background:var(--bs);color:var(--ink)}
header{position:sticky;top:0;z-index:5;background:var(--b);color:#fff;padding:10px 12px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
header h1{margin:0 0 2px;font-size:18px}
.owner{margin-top:6px;font-size:13px;background:rgba(255,255,255,.15);display:inline-block;padding:6px 10px;border-radius:10px}
main{padding:10px;max-width:1200px;margin:auto;padding-bottom:140px}
.card{background:var(--card);border:1px solid var(--ln);border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 1px 6px rgba(0,0,0,.04)}
h3{margin:6px 0 10px}
.row{display:flex;flex-wrap:wrap;gap:8px}.col{flex:1;min-width:190px}
label{font-size:12px;color:#111}
input,select,textarea,button{width:100%;padding:8px 10px;border:1px solid var(--ln);border-radius:12px;font-size:14px;background:#fff}
textarea{min-height:70px;resize:vertical}
button{border:none;cursor:pointer}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border-radius:12px;padding:9px 12px;font-size:13px}
.p{background:var(--b);color:#fff}.o{background:#fff;border:1px solid var(--ln)}.g{background:var(--ok);color:#fff}.r{background:var(--d);color:#fff}
.hint{font-size:12px;color:var(--m)}
.list .it{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 0;border-bottom:1px dashed var(--ln)}
.list .it:last-child{border-bottom:none}
.badge{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:11px}
.kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
.kpi .box{background:#f3f7ff;border:1px solid #e3ecff;border-radius:12px;padding:10px;text-align:center}.kpi .box b{display:block;font-size:16px}
table{width:100%;border-collapse:collapse;margin-top:8px}th,td{border:1px solid var(--ln);padding:6px;text-align:center;font-size:13px}th{background:#f8fbff}
.tabs{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--ln);display:flex}.tab{flex:1}.tab button{width:100%;background:#fff;border:none;padding:12px 0}.tab.active{background:#f0f6ff}
.subtle{background:#f9fbff;border:1px solid #eef2ff;border-radius:12px;padding:10px;margin-top:8px}
.sep{height:1px;background:var(--ln);margin:8px 0}
@media print{header,nav.tabs,.pr{display:none!important}body{background:#fff}.card{box-shadow:none;border:none;padding:0;margin:0}.page{page-break-after:always;margin-bottom:30px}}
</style></head><body>
<header class="pr"><h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©</h1><div>Ø§Ù„Ù…Ø§Ù„Ùƒ: <b>Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶</b></div><div class="owner">Ø±ØµÙŠØ¯ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ: <b id="ownerBal">0</b></div></header>
<main>
<div class="card pr"><div class="row">
  <div class="col"><label>Ø§Ù„Ù…Ø­Ù„</label><select id="storeSel" onchange="chgStore()"><option value="s1">Ø±ÙˆØ§Ù† Ø¨ÙŠØ¨ÙŠ</option><option value="s2">Ø¬Ù†ØªÙ„ Ø¨ÙŠØ¨ÙŠ Ø¹Ø¨ÙˆØ¯</option><option value="s3">Ø¨Ø³Ø·Ø©</option></select></div>
  <div class="col"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</label><input type="date" id="today"></div>
  <div class="col"><label>&nbsp;</label><button class="btn p" onclick="settleOne()">ØªØ³ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ… (Ø§Ù„Ù…Ø­Ù„)</button></div>
  <div class="col"><label>&nbsp;</label><button class="btn g" onclick="settleAll()">ØªØ³ÙˆÙŠØ© Ù…Ø¬Ù…Ù‘Ø¹Ø© (ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª)</button></div>
</div>
<div class="row"><div class="col"><label>Ù…Ø¹Ø§ÙŠÙ†Ø© ÙŠÙˆÙ…</label><input type="date" id="aggDay"></div><div class="col"><label>&nbsp;</label><button class="btn o" onclick="previewAgg()">Ù…Ø¹Ø§ÙŠÙ†Ø© ØªØ­ØµÙŠÙ„ ÙƒÙ„ Ù…Ø­Ù„</button></div></div>
<div id="aggWrap"></div><div class="hint">Ø§Ù„Ø¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ† â€” Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø­Ù„ÙŠÙ‹Ø§ + Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯/Ø§Ù„ØªØµØ¯ÙŠØ± Ù…Ù† ØªØ¨ÙˆÙŠØ¨ â€œØ§Ù„Ù…Ø§Ù„Ùƒâ€.</div></div>

<section class="card" data-tab="input">
  <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3><div class="row">
    <div class="col"><input type="number" id="saleAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
    <div class="col"><select id="saleType"><option>ÙƒØ§Ø´</option><option>Ø¨Ù†Ùƒ</option></select></div>
    <div class="col"><input id="saleNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø³Ù…/ØµÙ†Ù/Ø¬ÙˆØ§Ù„)"></div>
    <div class="col"><button class="btn g" onclick="addSale()">â• Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ¹</button></div>
  </div><div id="recentSales" class="list"></div>

  <h3 style="margin-top:14px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„)</h3><div class="row">
    <div class="col"><input id="expDesc" placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ"></div>
    <div class="col"><input type="number" id="expAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
    <div class="col"><input id="expNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
    <div class="col"><select id="expBind"><option value="">â€” Ø¬Ù‡Ø© Ù…Ø³ØªÙÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€”</option><option value="supplier">ØªØ§Ø¬Ø±</option><option value="loan">Ù…Ø³Ù„Ù</option></select></div>
    <div class="col"><input id="expBindName" list="allList" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… (Ø§Ù‚ØªØ±Ø§Ø­)"><datalist id="allList"></datalist></div>
    <div class="col"><button class="btn g" onclick="addExpense()">â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button></div>
  </div><div id="recentExp" class="list"></div>
</section>

<section class="card" data-tab="daily">
  <h3>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3><div class="row pr">
    <div class="col"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="rDate"></div>
    <div class="col"><label>Ø§Ù„Ù…Ø­Ù„</label><select id="rStore"><option value="s1">Ø±ÙˆØ§Ù† Ø¨ÙŠØ¨ÙŠ</option><option value="s2">Ø¬Ù†ØªÙ„ Ø¨ÙŠØ¨ÙŠ Ø¹Ø¨ÙˆØ¯</option><option value="s3">Ø¨Ø³Ø·Ø©</option></select></div>
    <div class="col"><label>&nbsp;</label><button class="btn p" onclick="reportDaily()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div>
    <div class="col"><label>&nbsp;</label><button class="btn o" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button></div>
  </div><div id="dailyWrap"></div>
</section>

<section class="card" data-tab="range">
  <h3>ØªÙ‚Ø±ÙŠØ± ÙØªØ±Ø© / Ù…Ø¬Ù…Ù‘Ø¹</h3><div class="row pr">
    <div class="col"><label>Ù…Ù†</label><input type="date" id="fFrom"></div>
    <div class="col"><label>Ø¥Ù„Ù‰</label><input type="date" id="fTo"></div>
    <div class="col"><label>Ø§Ù„Ù†Ù…Ø·</label><select id="fMode"><option value="per">Ù…Ù†ÙØµÙ„ Ù„ÙƒÙ„ Ù…Ø­Ù„</option><option value="all">Ù…Ø¬Ù…Ù‘Ø¹ Ù„Ù„Ù…Ø­Ù„Ø§Øª</option></select></div>
    <div class="col"><label>&nbsp;</label><button class="btn p" onclick="reportRange()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div>
    <div class="col"><label>&nbsp;</label><button class="btn o" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button></div>
  </div><div id="rangeWrap"></div>
</section>

<section class="card" data-tab="loans">
  <h3>Ø§Ù„Ø³ÙÙ„Ù (ØªÙØ§ØµÙŠÙ„ + ÙƒØ´Ù)</h3>
  <div class="row"><div class="col"><input id="loanName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙØ³Ù„Ù"></div><div class="col"><input type="number" id="loanIn" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù„ÙØ© (+)"></div><div class="col"><button class="btn g" onclick="addLoan()">â• Ø¥Ø¶Ø§ÙØ© Ø³Ù„ÙØ© (ØªØ²ÙŠØ¯ ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„)</button></div></div>
  <div class="row"><div class="col"><input id="loanPayName" list="loanList" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙØ³Ù„Ù â€” Ø³Ø¯Ø§Ø¯"></div><datalist id="loanList"></datalist><div class="col"><input type="number" id="loanOut" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø¯Ø§Ø¯ (âˆ’)"></div><div class="col"><select id="loanSrc"><option value="store">Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„</option><option value="owner">Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</option></select></div><div class="col"><button class="btn p" onclick="payLoan()">ğŸ’¸ ØªØ³Ø¬ÙŠÙ„ Ø³Ø¯Ø§Ø¯</button></div></div>
  <div class="row pr"><div class="col"><input id="loanStmtName" list="loanList" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ù„Ù â€” ÙƒØ´Ù"></div><div class="col"><input type="date" id="loanFrom"></div><div class="col"><input type="date" id="loanTo"></div><div class="col"><button class="btn o" onclick="renderLoanStmt()">Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ù…Ø³Ù„Ù</button></div><div class="col"><button class="btn o" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù</button></div></div>
  <div id="loansWrap" class="subtle"></div><div id="loanStmtWrap"></div>
</section>

<section class="card" data-tab="suppliers">
  <h3>Ø§Ù„ØªÙØ¬Ø§Ø± (ØªÙØ§ØµÙŠÙ„ + ÙƒØ´Ù)</h3>
  <div class="row"><div class="col"><input id="supName" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±"></div><div class="col"><input type="number" id="supInv" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (+)"></div><div class="col"><button class="btn g" onclick="addInv()">â• ØªØ³Ø¬ÙŠÙ„ ÙØ§ØªÙˆØ±Ø©</button></div></div>
  <div class="row"><div class="col"><input id="supPayName" list="supList" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± â€” Ø³Ø¯Ø§Ø¯"></div><datalist id="supList"></datalist><div class="col"><input type="number" id="supPayAmt" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø© (âˆ’)"></div><div class="col"><select id="supSrc"><option value="store">Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„</option><option value="owner">Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</option><option value="bank">Ù…Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ</option></select></div><div class="col"><button class="btn p" onclick="paySup()">ğŸ’³ ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©</button></div></div>
  <div class="row pr"><div class="col"><input id="supStmtName" list="supList" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± â€” ÙƒØ´Ù"></div><div class="col"><input type="date" id="supFrom"></div><div class="col"><input type="date" id="supTo"></div><div class="col"><button class="btn o" onclick="renderSupStmt()">Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„ØªØ§Ø¬Ø±</button></div><div class="col"><button class="btn o" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù</button></div></div>
  <div id="supWrap" class="subtle"></div><div id="supStmtWrap"></div>
</section>

<section class="card" data-tab="debts">
  <h3>Ø§Ù„Ø¯ÙŠÙˆÙ† (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡)</h3>
  <div class="row"><div class="col"><input id="debtName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"></div><div class="col"><input type="number" id="debtAmt" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙŠÙ† (+)"></div><div class="col"><input id="debtNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div><div class="col"><button class="btn g" onclick="addDebt()">â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ†</button></div></div>
  <div class="row"><div class="col"><input id="debtPayName" list="debtList" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ â€” Ø³Ø¯Ø§Ø¯ Ø¯ÙŠÙ†"></div><datalist id="debtList"></datalist><div class="col"><input type="number" id="debtPayAmt" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø¯Ø§Ø¯ (âˆ’)"></div><div class="col"><select id="debtMethod"><option>ÙƒØ§Ø´</option><option>Ø¨Ù†Ùƒ</option></select></div><div class="col"><button class="btn p" onclick="payDebt()">âœ… ØªØ³Ø¬ÙŠÙ„ Ø³Ø¯Ø§Ø¯ Ø¯ÙŠÙ†</button></div></div>
  <div id="debtsWrap" class="subtle"></div>
</section>

<section class="card" data-tab="owner">
  <h3>ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ â€” Ù…Ø¬Ù…Ù‘Ø¹/ÙƒØ´Ù/ØªØ³ÙˆÙŠØ©/Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3>
  <div class="subtle">
    <h4 style="margin:6px 0">Ø¥ÙŠØ¯Ø§Ø¹/Ø³Ø­Ø¨</h4>
    <div class="row"><div class="col"><input type="number" id="ownIn" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹"></div><div class="col"><input id="ownInNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div><div class="col"><button class="btn g" onclick="ownerDeposit()">â¬†ï¸ Ø¥ÙŠØ¯Ø§Ø¹</button></div></div>
    <div class="row"><div class="col"><input type="number" id="ownOut" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨"></div>
      <div class="col"><select id="ownBind"><option value="">â€” Ø±Ø¨Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€”</option><option value="supplier">Ø³Ø¯Ø§Ø¯ ØªØ§Ø¬Ø±</option><option value="loan">Ø³Ø¯Ø§Ø¯ Ù…Ø³Ù„Ù</option></select></div>
      <div class="col"><input id="ownWho" list="ownBindList" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… (Ø§Ù‚ØªØ±Ø§Ø­)"><datalist id="ownBindList"></datalist></div>
      <div class="col"><input id="ownOutNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
      <div class="col"><button class="btn r" onclick="ownerWithdraw()">â¬‡ï¸ Ø³Ø­Ø¨</button></div>
    </div>
  </div>
  <div class="subtle"><h4 style="margin:6px 0">ÙƒØ´Ù Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Ù…Ø¹ Ø§Ù„Ø­Ø°Ù)</h4><div class="row pr"><div class="col"><label>Ù…Ù†</label><input type="date" id="ofFrom"></div><div class="col"><label>Ø¥Ù„Ù‰</label><input type="date" id="ofTo"></div><div class="col"><label>&nbsp;</label><button class="btn p" onclick="renderOwner()">Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ´Ù</button></div><div class="col"><label>&nbsp;</label><button class="btn o" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button></div></div><div id="ownerWrap"></div></div>
  <div class="subtle"><h4 style="margin:6px 0">ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ Ù…Ø¬Ù…Ù‘Ø¹</h4><div class="row pr"><div class="col"><input type="month" id="mMonth"></div><div class="col"><button class="btn p" onclick="reportMonthly()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div><div class="col"><button class="btn o" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button></div></div><div id="monthlyWrap"></div></div>
  <div class="subtle pr"><h4 style="margin:6px 0">Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h4><div class="row"><div class="col"><button class="btn o" onclick="exportBackup()">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button></div><div class="col"><label for="imp" class="btn g" style="display:inline-block;cursor:pointer;text-align:center">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯</label><input id="imp" type="file" accept="application/json" style="display:none" onchange="importBackup(this.files[0])"/></div></div><div class="hint">ÙŠØ´Ù…Ù„ Ø§Ù„Ù…Ø­Ù„Ø§Øª ÙˆØ§Ù„Ø³Ù„Ù ÙˆØ§Ù„ØªØ¬Ø§Ø± ÙˆØ§Ù„Ø¯ÙŠÙˆÙ† ÙˆØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ.</div></div>
  <div class="subtle"><h4 style="margin:6px 0">ØªØ¬Ù…ÙŠØ¹ ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ (ØªÙØµÙŠÙ„ ÙƒÙ„ Ù…Ø­Ù„)</h4><div id="ownerAggWrap"></div></div>
</section>
</main>

<nav class="tabs pr">
  <div class="tab active"><button onclick="tab('input')">Ø¥Ø¯Ø®Ø§Ù„</button></div>
  <div class="tab"><button onclick="tab('daily')">ÙŠÙˆÙ…ÙŠ</button></div>
  <div class="tab"><button onclick="tab('range')">ÙØªØ±Ø©/Ù…Ø¬Ù…Ù‘Ø¹</button></div>
  <div class="tab"><button onclick="tab('loans')">Ø³ÙÙ„Ù</button></div>
  <div class="tab"><button onclick="tab('suppliers')">ØªÙØ¬Ø§Ø±</button></div>
  <div class="tab"><button onclick="tab('debts')">Ø¯ÙŠÙˆÙ†</button></div>
  <div class="tab"><button onclick="tab('owner')">Ø§Ù„Ù…Ø§Ù„Ùƒ</button></div>
</nav>

<script>
/* Ø£Ø³Ø§Ø³ÙŠØ§Øª */
const stores={s1:"Ø±ÙˆØ§Ù† Ø¨ÙŠØ¨ÙŠ",s2:"Ø¬Ù†ØªÙ„ Ø¨ÙŠØ¨ÙŠ Ø¹Ø¨ÙˆØ¯",s3:"Ø¨Ø³Ø·Ø©"};let cur="s1";
const qs=s=>document.querySelector(s),qsa=s=>Array.from(document.querySelectorAll(s));
const today=()=>new Date().toISOString().slice(0,10),uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,7);
const inR=(iso,a,b)=>{if(!iso)return false;const d=new Date(iso+"T00:00:00");return(!a||d>=new Date(a+"T00:00:00"))&&(!b||d<=new Date(b+"T00:00:00"));};
const sum=(a,f)=>a.reduce((x,y)=>x+f(y),0),p2=n=>String(n).padStart(2,"0");
function fmt(iso){if(!iso)return"";const d=new Date(iso+"T00:00:00"),days=["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];return `${days[d.getDay()]} ${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`}

/* ØªØ®Ø²ÙŠÙ† */
const getS=(s=cur)=>JSON.parse(localStorage.getItem(s)||'{"sales":[],"expenses":[]}'), setS=(v,s=cur)=>localStorage.setItem(s,JSON.stringify(v));
const getO=()=>JSON.parse(localStorage.getItem("owner_fund")||'{"ledger":[]}'), setO=v=>localStorage.setItem("owner_fund",JSON.stringify(v));
const getL=()=>JSON.parse(localStorage.getItem("loans")||'{"people":{}}'), setL=v=>localStorage.setItem("loans",JSON.stringify(v));
const getSup=()=>JSON.parse(localStorage.getItem("suppliers")||'{"people":{}}'), setSup=v=>localStorage.setItem("suppliers",JSON.stringify(v));
const getD=()=>JSON.parse(localStorage.getItem("debts")||'{"people":{}}'), setD=v=>localStorage.setItem("debts",JSON.stringify(v));

/* Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø£Ø³Ù…Ø§Ø¡ */
function namesSup(){const S=getSup();return S.people?Object.keys(S.people):[]}
function namesLoan(){const L=getL();return L.people?Object.keys(L.people):[]}
function namesDebt(){const D=getD();return D.people?Object.keys(D.people):[]}
function refillLists(){
  const dl=qs("#allList"); if(dl){dl.innerHTML=[...new Set([...namesSup(),...namesLoan()])].map(n=>`<option value="${n}">`).join("")}
  const l1=qs("#loanList"); if(l1){l1.innerHTML=namesLoan().map(n=>`<option value="${n}">`).join("")}
  const l2=qs("#supList"); if(l2){l2.innerHTML=namesSup().map(n=>`<option value="${n}">`).join("")}
  const l3=qs("#debtList"); if(l3){l3.innerHTML=namesDebt().map(n=>`<option value="${n}">`).join("")}
  const l4=qs("#ownBindList"); if(l4){l4.innerHTML=[...namesSup(),...namesLoan()].map(n=>`<option value="${n}">`).join("")}
}
qs("#expBind").addEventListener("change",()=>{const t=qs("#expBind").value,dl=qs("#allList");if(!dl)return;let ns=[];if(t==="supplier")ns=namesSup();else if(t==="loan")ns=namesLoan();else ns=[...new Set([...namesSup(),...namesLoan()])];dl.innerHTML=ns.map(n=>`<option value="${n}">`).join("")});

/* ØªØ¨ÙˆÙŠØ¨Ø§Øª */
function chgStore(){cur=qs("#storeSel").value;renderLists()}
function tab(name){qsa("[data-tab]").forEach(el=>el.style.display=(el.getAttribute("data-tab")==name?"block":"none"));const order=["input","daily","range","loans","suppliers","debts","owner"];qsa(".tabs .tab").forEach((t,i)=>t.classList.toggle("active",order[i]===name));if(name==="input"){renderLists();refillLists()}if(name==="owner"){renderOwner();refillLists()}if(name==="loans"){renderLoans()}if(name==="suppliers"){renderSup()}if(name==="debts"){renderDebts()}}

/* Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨ÙŠØ¹Ø§Øª */
function addSale(){const a=+qs("#saleAmt").value||0,t=qs("#saleType").value,n=(qs("#saleNote").value||"").trim();if(!a){alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");return}const d=getS();d.sales.push({id:uid(),date:today(),type:t,amount:a,note:n,meta:{}});setS(d);qs("#saleAmt").value="";qs("#saleNote").value="";renderLists()}

/* Ù…ØµØ§Ø±ÙŠÙ + Ø±Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠ */
function addExpense(){const desc=(qs("#expDesc").value||"").trim(),a=+qs("#expAmt").value||0,n=(qs("#expNote").value||"").trim(),bt=qs("#expBind").value,bn=(qs("#expBindName").value||"").trim();if(!desc||!a){alert("Ø£Ø¯Ø®Ù„ ÙˆØµÙ ÙˆÙ…Ø¨Ù„Øº");return}const d=getS();const exp={id:uid(),date:today(),type:"ÙƒØ§Ø´",desc,amount:a,note:n,benefType:bt||null,benefName:bn||null};d.expenses.push(exp);setS(d);
 if(bt&&bn){if(bt==="supplier"){const S=getSup();S.people=S.people||{};S.people[bn]=S.people[bn]||{balance:0,history:[]};S.people[bn].balance-=a;S.people[bn].history.push({id:uid(),date:today(),type:"pay",amount:a,source:"ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„",note:"Ø¯ÙØ¹Ø© (Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡)",linkedExpenseId:exp.id});setSup(S);renderSup()}else if(bt==="loan"){const L=getL();L.people=L.people||{};L.people[bn]=L.people[bn]||{balance:0,history:[]};L.people[bn].balance-=a;L.people[bn].history.push({id:uid(),date:today(),type:"out",amount:a,source:"ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„",note:"Ø³Ø¯Ø§Ø¯ (Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡)",linkedExpenseId:exp.id});setL(L);renderLoans()}}
 qs("#expDesc").value="";qs("#expAmt").value="";qs("#expNote").value="";qs("#expBind").value="";qs("#expBindName").value="";renderLists()}
function delSale(id){if(!confirm("Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ØŸ"))return;const d=getS();const i=d.sales.findIndex(x=>x.id===id);if(i>-1){d.sales.splice(i,1);setS(d);renderLists()}}
function delExp(id){if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ Ø³ÙŠØªÙ… Ø¹ÙƒØ³ Ø§Ù„Ø±Ø¨Ø· Ø¥Ù† ÙˆØ¬Ø¯."))return;const d=getS();const i=d.expenses.findIndex(x=>x.id===id);if(i===-1)return;const r=d.expenses[i];if(r.benefType&&r.benefName){if(r.benefType==="supplier"){const S=getSup();if(S.people&&S.people[r.benefName]){S.people[r.benefName].balance+=+r.amount;S.people[r.benefName].history.push({id:uid(),date:today(),type:"revert",amount:r.amount,note:"Ø¥Ù„ØºØ§Ø¡ Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡"});setSup(S);renderSup()}}else if(r.benefType==="loan"){const L=getL();if(L.people&&L.people[r.benefName]){L.people[r.benefName].balance+=+r.amount;L.people[r.benefName].history.push({id:uid(),date:today(),type:"revert",amount:r.amount,note:"Ø¥Ù„ØºØ§Ø¡ Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡"});setL(L);renderLoans()}}}d.expenses.splice(i,1);setS(d);renderLists()}
function renderLists(){const d=getS(),rs=d.sales.slice(-40).reverse(),re=d.expenses.slice(-40).reverse();qs("#recentSales").innerHTML=rs.length?rs.map(v=>`<div class="it"><div class="m">${v.date} â€” <span class="badge">${v.type}</span> ${v.note?("â€” <i>"+v.note+"</i>"):""}</div><div><b>${v.amount}</b></div><div><button class="btn r" onclick="delSale('${v.id}')">Ø­Ø°Ù</button></div></div>`).join(""):'<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª</div>';qs("#recentExp").innerHTML=re.length?re.map(v=>{const link=(v.benefType&&v.benefName)?` â€” <b>Ù…ÙˆØ¬Ù‘Ù‡: ${v.benefType==="supplier"?"ØªØ§Ø¬Ø±":"Ù…Ø³Ù„Ù"} (${v.benefName})</b>`:"";return `<div class="it"><div class="m">${v.date} â€” <span class="badge">${v.type}</span> â€” ${v.desc}${link} ${v.note?("â€” <i>"+v.note+"</i>"):""}</div><div><b>${v.amount}</b></div><div><button class="btn r" onclick="delExp('${v.id}')">Ø­Ø°Ù</button></div></div>`}).join(""):'<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ</div>';refillLists()}

/* ØªÙ‚Ø§Ø±ÙŠØ± */
function totals(arr,key='type'){return{cs:sum(arr,x=>x[key]==="ÙƒØ§Ø´"?+x.amount:0),bn:sum(arr,x=>x[key]==="Ø¨Ù†Ùƒ"?+x.amount:0)}}
function reportDaily(){const date=qs("#rDate").value||today(),st=qs("#rStore").value||cur,d=JSON.parse(localStorage.getItem(st)||'{"sales":[],"expenses":[]}'),s=d.sales.filter(x=>x.date===date),e=d.expenses.filter(x=>x.date===date),ts=totals(s),te=totals(e);const nc=ts.cs-te.cs,nb=ts.bn-te.bn;const r1=s.map(x=>`<tr><td>${x.date}</td><td>${x.type}</td><td>${x.amount}</td><td>${x.note||""}</td></tr>`).join("")||'<tr><td colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª</td></tr>';const r2=e.map(x=>`<tr><td>${x.date}</td><td>${x.type}</td><td>${x.desc}</td><td>${x.amount}</td><td>${(x.benefType&&x.benefName)?(x.benefType==='supplier'?'ØªØ§Ø¬Ø±: ':'Ù…Ø³Ù„Ù: ')+x.benefName:(x.note||'')}</td></tr>`).join("")||'<tr><td colspan="5">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ</td></tr>';qs("#dailyWrap").innerHTML=`<div class="page"><h2 style="margin:0 0 6px">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ â€” ${stores[st]}</h2><div class="hint">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: <b>${fmt(date)}</b> â€” Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <b>${fmt(today())}</b></div><div class="sep"></div><div class="kpi"><div class="box"><b>${ts.cs}</b>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</div><div class="box"><b>${ts.bn}</b>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</div><div class="box"><b>${te.cs}</b>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</div><div class="box"><b>${te.bn}</b>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</div></div><h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead><tbody>${r1}</tbody></table><h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª/Ø±Ø¨Ø·</th></tr></thead><tbody>${r2}</tbody></table><div style="margin-top:10px;display:flex;gap:14px;justify-content:flex-end"><div><b>ØµØ§ÙÙŠ Ø§Ù„ÙƒØ§Ø´:</b> ${nc}</div><div><b>ØµØ§ÙÙŠ Ø§Ù„Ø¨Ù†Ùƒ:</b> ${nb}</div><div><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ§ÙÙŠ:</b> ${nc+nb}</div></div><div style="margin-top:28px;display:flex;justify-content:space-between"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ _________</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: _________</div></div></div>`}
function reportRange(){const f=qs("#fFrom").value||today().slice(0,8)+"01",t=qs("#fTo").value||today(),m=qs("#fMode").value||"per",shops=Object.keys(stores);if(m==="all"){let SS=[],EE=[];shops.forEach(s=>{const d=getS(s);SS=SS.concat(d.sales.filter(x=>inR(x.date,f,t)));EE=EE.concat(d.expenses.filter(x=>inR(x.date,f,t)))});const ts=totals(SS),te=totals(EE),nc=ts.cs-te.cs,nb=ts.bn-te.bn;qs("#rangeWrap").innerHTML=`<div class="page"><h2 style="margin:0 0 6px">ØªÙ‚Ø±ÙŠØ± Ù…Ø¬Ù…Ù‘Ø¹ â€” ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª</h2><div class="hint">Ø§Ù„ÙØªØ±Ø©: <b>${f}</b> â†’ <b>${t}</b> â€” Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <b>${fmt(today())}</b></div><div class="sep"></div><table><thead><tr><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead><tbody><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</td><td>${ts.cs}</td></tr><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</td><td>${ts.bn}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</td><td>${te.cs}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</td><td>${te.bn}</td></tr><tr><td><b>ØµØ§ÙÙŠ Ø§Ù„ÙƒØ§Ø´</b></td><td><b>${nc}</b></td></tr><tr><td><b>ØµØ§ÙÙŠ Ø§Ù„Ø¨Ù†Ùƒ</b></td><td><b>${nb}</b></td></tr><tr><td><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ§ÙÙŠ</b></td><td><b>${nc+nb}</b></td></tr></tbody></table><div style="margin-top:28px;display:flex;justify-content:space-between"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ _________</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: _________</div></div></div>`}else{let H='';shops.forEach(s=>{const d=getS(s),S=d.sales.filter(x=>inR(x.date,f,t)),E=d.expenses.filter(x=>inR(x.date,f,t)),ts=totals(S),te=totals(E),nc=ts.cs-te.cs,nb=ts.bn-te.bn;H+=`<div class="page"><h2 style="margin:0 0 6px">ØªÙ‚Ø±ÙŠØ± ÙØªØ±Ø© â€” ${stores[s]}</h2><div class="hint">Ø§Ù„ÙØªØ±Ø©: <b>${f}</b> â†’ <b>${t}</b> â€” Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <b>${fmt(today())}</b></div><div class="sep"></div><table><thead><tr><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead><tbody><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</td><td>${ts.cs}</td></tr><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</td><td>${ts.bn}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</td><td>${te.cs}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</td><td>${te.bn}</td></tr><tr><td><b>ØµØ§ÙÙŠ Ø§Ù„ÙƒØ§Ø´</b></td><td><b>${nc}</b></td></tr><tr><td><b>ØµØ§ÙÙŠ Ø§Ù„Ø¨Ù†Ùƒ</b></td><td><b>${nb}</b></td></tr><tr><td><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ§ÙÙŠ</b></td><td><b>${nc+nb}</b></td></tr></tbody></table><div style="margin-top:28px;display:flex;justify-content:space-between"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ _________</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: _________</div></div></div>`});qs("#rangeWrap").innerHTML=H}}
/* Ù…Ø¹Ø§ÙŠÙ†Ø© ØªØ¬Ù…ÙŠØ¹ ÙŠÙˆÙ… Ù„ÙƒÙ„ Ù…Ø­Ù„ */
function previewAgg(){const day=qs("#aggDay").value||today(),shops=Object.keys(stores);let rows='',TC=0,TB=0;shops.forEach(s=>{const d=getS(s),cs=sum(d.sales.filter(x=>x.date===day&&x.type==="ÙƒØ§Ø´"),x=>+x.amount),bs=sum(d.sales.filter(x=>x.date===day&&x.type==="Ø¨Ù†Ùƒ"),x=>+x.amount),ce=sum(d.expenses.filter(x=>x.date===day&&x.type==="ÙƒØ§Ø´"),x=>+x.amount),be=sum(d.expenses.filter(x=>x.date===day&&x.type==="Ø¨Ù†Ùƒ"),x=>+x.amount),nc=cs-ce,nb=bs-be;TC+=Math.max(0,nc);TB+=Math.max(0,nb);rows+=`<tr><td>${stores[s]}</td><td>${cs}</td><td>${ce}</td><td><b>${nc}</b></td><td>${bs}</td><td>${be}</td><td><b>${nb}</b></td></tr>`});qs("#aggWrap").innerHTML=`<div class="page"><h3 style="margin:0 0 6px">Ù…Ø¹Ø§ÙŠÙ†Ø© ØªØ­ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ… â€” ${day}</h3><table><thead><tr><th>Ø§Ù„Ù…Ø­Ù„</th><th>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</th><th>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</th><th>ØµØ§ÙÙŠ ÙƒØ§Ø´</th><th>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</th><th>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</th><th>ØµØ§ÙÙŠ Ø¨Ù†Ùƒ</th></tr></thead><tbody>${rows}</tbody><tfoot><tr><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th colspan="2"></th><th>${TC}</th><th colspan="2"></th><th>${TB}</th></tr></tfoot></table><div class="hint">ÙŠÙØ±Ø­Ù‘ÙÙ„ Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚ <b>ØµØ§ÙÙŠ Ø§Ù„ÙƒØ§Ø´ ÙÙ‚Ø·</b>.</div></div>`}

/* ØªØ³ÙˆÙŠØ© ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ */
function updOwnerUI(){const O=getO(),ins=sum(O.ledger,x=>x.type==='in'?+x.amount:0),outs=sum(O.ledger,x=>x.type==='out'?+x.amount:0);qs("#ownerBal").textContent=(ins-outs)}
function rmSettle(day,scope,storeId=null){const O=getO();for(let i=O.ledger.length-1;i>=0;i--){const e=O.ledger[i],m=e.meta||{};if(e.date===day&&m&&m.kind==='settle'&&m.scope===scope&&(scope==='aggregate'||m.storeId===storeId)){O.ledger.splice(i,1)}}setO(O)}
function settleOne(){const day=qs("#today").value||today(),st=cur,d=getS(st),cs=sum(d.sales.filter(x=>x.date===day&&x.type==="ÙƒØ§Ø´"),x=>+x.amount),bs=sum(d.sales.filter(x=>x.date===day&&x.type==="Ø¨Ù†Ùƒ"),x=>+x.amount),ce=sum(d.expenses.filter(x=>x.date===day&&x.type==="ÙƒØ§Ø´"),x=>+x.amount),be=sum(d.expenses.filter(x=>x.date===day&&x.type==="Ø¨Ù†Ùƒ"),x=>+x.amount),nc=cs-ce,nb=bs-be;rmSettle(day,'single',st);const O=getO();if(nc>0){O.ledger.push({id:uid(),date:day,type:"in",amount:+nc,note:`ØªØ±Ø­ÙŠÙ„ ${stores[st]} â€” (ÙƒØ§Ø´=${nc} / Ø¨Ù†Ùƒ=${nb})`,meta:{kind:"settle",scope:"single",storeId:st,netCash:nc,netBank:nb}});setO(O);updOwnerUI();alert("ØªÙ…Øª ØªØ³ÙˆÙŠØ© Ø§Ù„Ù…Ø­Ù„")}else{setO(O);updOwnerUI();alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ§Ø´ ÙØ§Ø¦Ø¶")}renderOwner()}
function settleAll(){const day=qs("#today").value||today(),shops=Object.keys(stores);let tot=0,det=[];shops.forEach(s=>{const d=getS(s),cs=sum(d.sales.filter(x=>x.date===day&&x.type==="ÙƒØ§Ø´"),x=>+x.amount),bs=sum(d.sales.filter(x=>x.type==="Ø¨Ù†Ùƒ"&&x.date===day),x=>+x.amount),ce=sum(d.expenses.filter(x=>x.date===day&&x.type==="ÙƒØ§Ø´"),x=>+x.amount),be=sum(d.expenses.filter(x=>x.date===day&&x.type==="Ø¨Ù†Ùƒ"),x=>+x.amount),nc=cs-ce,nb=bs-be;if(nc>0)tot+=nc;det.push({storeId:s,storeName:stores[s],netCash:nc,netBank:nb})});rmSettle(day,'aggregate');const O=getO();if(tot>0){O.ledger.push({id:uid(),date:day,type:"in",amount:+tot,note:`ØªØ±Ø­ÙŠÙ„ Ù…Ø¬Ù…Ù‘Ø¹: `+det.map(d=>`${d.storeName} Ùƒ=${d.netCash}/Ø¨=${d.netBank}`).join(" | "),meta:{kind:"settle",scope:"aggregate",detail:det}});setO(O);updOwnerUI();alert("ØªÙ… ØªØ±Ø­ÙŠÙ„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒØ§Ø´ = "+tot)}else{setO(O);updOwnerUI();alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ§Ø´ ÙØ§Ø¦Ø¶")}renderOwner()}

/* Ø³Ù„Ù */
function renderLoans(){const L=getL(),ns=Object.keys(L.people||{});if(!ns.length){qs("#loansWrap").innerHTML='<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù„Ù</div>';refillLists();return}
 const rows=ns.map(n=>`<tr><td>${n}</td><td>${L.people[n].balance||0}</td><td><button class="btn r" onclick="delLoanPerson('${n.replace(/'/g,"\\'")}')">ğŸ—‘ Ø­Ø°Ù</button></td></tr>`).join("");
 const tx=[];ns.forEach(n=>(L.people[n].history||[]).slice(-50).forEach(h=>tx.push({name:n,...h})));tx.sort((a,b)=>(a.date||"").localeCompare(b.date||"")).reverse();
 const txRows=tx.length?tx.map(h=>`<tr><td>${h.date||""}</td><td>${h.name}</td><td>${h.type==='in'?'Ø³Ù„ÙØ© (+)':(h.type==='out'?'Ø³Ø¯Ø§Ø¯ (âˆ’)':(h.type==='revert'?'Ø¥Ù„ØºØ§Ø¡':''))}</td><td>${h.amount||0}</td><td>${h.note||""}</td></tr>`).join(""):`<tr><td colspan="5">Ù„Ø§ Ø­Ø±ÙƒØ§Øª</td></tr>`;
 qs("#loansWrap").innerHTML=`<h4>Ø£Ø±ØµØ¯Ø©</h4><table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>${rows}</tbody></table><h4 style="margin-top:10px">ØªÙØ§ØµÙŠÙ„ Ø¢Ø®Ø± Ø§Ù„Ø­Ø±ÙƒØ§Øª</h4><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead><tbody>${txRows}</tbody></table>`;refillLists()}
function addLoan(){const n=(qs("#loanName").value||"").trim(),a=+qs("#loanIn").value||0;if(!n||!a){alert("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº");return}const L=getL();L.people=L.people||{};L.people[n]=L.people[n]||{balance:0,history:[]};L.people[n].balance+=a;L.people[n].history.push({id:uid(),date:today(),type:"in",amount:a,note:"Ø³Ù„ÙØ© Ù„Ù„Ù…Ø­Ù„"});setL(L);const d=getS();d.sales.push({id:uid(),date:today(),type:"ÙƒØ§Ø´",amount:a,note:`Ø³Ù„ÙØ© Ù…Ù† ${n} (ØºÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª)`,meta:{kind:"loanIn",lender:n}});setS(d);qs("#loanName").value="";qs("#loanIn").value="";renderLoans();renderLists()}
function payLoan(){const n=(qs("#loanPayName").value||"").trim(),a=+qs("#loanOut").value||0,src=qs("#loanSrc").value;if(!n||!a){alert("Ø§Ø³Ù…/Ù…Ø¨Ù„Øº");return}const L=getL();if(!L.people||!L.people[n]){alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ù„Ù");return}L.people[n].balance-=a;L.people[n].history.push({id:uid(),date:today(),type:"out",amount:a,source:(src==='store'?'ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„':'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ'),note:`Ø³Ø¯Ø§Ø¯ Ù…Ù† ${src==='store'?'ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„':'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ'}`});setL(L);if(src==='store'){const d=getS();d.expenses.push({id:uid(),date:today(),type:"ÙƒØ§Ø´",desc:`Ø³Ø¯Ø§Ø¯ Ø³Ù„ÙØ© (${n})`,amount:a,note:"Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„",benefType:"loan",benefName:n});setS(d);renderLists()}else{const O=getO();O.ledger.push({id:uid(),date:today(),type:"out",amount:a,note:`Ø³Ø¯Ø§Ø¯ Ø³Ù„ÙØ© (${n})`,meta:{kind:"manual",bindType:"loan",bindName:n}});setO(O);updOwnerUI()}qs("#loanPayName").value="";qs("#loanOut").value="";renderLoans();renderOwner()}
function delLoanPerson(n){if(!confirm(`Ø­Ø°Ù Ø§Ù„Ù…Ø³Ù„Ù "${n}" ÙˆÙƒÙ„ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙ‡ØŸ`))return;const L=getL();if(L.people&&L.people[n]){delete L.people[n];setL(L);renderLoans();refillLists();alert("ØªÙ… Ø§Ù„Ø­Ø°Ù")}}
function renderLoanStmt(){const n=(qs("#loanStmtName").value||"").trim(),f=qs("#loanFrom").value||today().slice(0,8)+"01",t=qs("#loanTo").value||today();const L=getL();if(!n||!L.people||!L.people[n]){qs("#loanStmtWrap").innerHTML='<div class="hint">Ø§Ø®ØªØ± Ø§Ø³Ù… ØµØ­ÙŠØ­</div>';return}const h=(L.people[n].history||[]).filter(x=>inR(x.date,f,t));const rows=h.length?h.map(x=>`<tr><td>${x.date}</td><td>${x.type==='in'?'Ø³Ù„ÙØ© (+)':'Ø³Ø¯Ø§Ø¯ (âˆ’)'}</td><td>${x.amount}</td><td>${x.note||''}</td></tr>`).join(""):`<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª</td></tr>`;qs("#loanStmtWrap").innerHTML=`<div class="page"><h3 style="margin:0 0 6px">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ â€” Ù…Ø³Ù„Ù: ${n}</h3><div class="hint">Ø§Ù„ÙØªØ±Ø©: ${f} â†’ ${t}</div><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead><tbody>${rows}</tbody></table><div style="margin-top:8px"><b>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</b> ${(L.people[n].balance||0)}</div></div>`}

/* ØªØ¬Ø§Ø± */
function renderSup(){const S=getSup(),ns=Object.keys(S.people||{});if(!ns.length){qs("#supWrap").innerHTML='<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ø§Ø±</div>';refillLists();return}
 const rows=ns.map(n=>`<tr><td>${n}</td><td>${S.people[n].balance||0}</td><td><button class="btn r" onclick="delSup('${n.replace(/'/g,"\\'")}')">ğŸ—‘ Ø­Ø°Ù</button></td></tr>`).join("");
 const tx=[];ns.forEach(n=>(S.people[n].history||[]).slice(-60).forEach(h=>tx.push({name:n,...h})));tx.sort((a,b)=>(a.date||"").localeCompare(b.date||"")).reverse();
 const txRows=tx.length?tx.map(h=>`<tr><td>${h.date||""}</td><td>${h.name}</td><td>${h.type==='invoice'?'ÙØ§ØªÙˆØ±Ø© (+)':(h.type==='pay'?'Ø¯ÙØ¹Ø© (âˆ’)':(h.type==='revert'?'Ø¥Ù„ØºØ§Ø¡':''))}</td><td>${h.amount||0}</td><td>${h.note||""}</td></tr>`).join(""):`<tr><td colspan="5">Ù„Ø§ Ø­Ø±ÙƒØ§Øª</td></tr>`;
 qs("#supWrap").innerHTML=`<h4>Ø£Ø±ØµØ¯Ø©</h4><table><thead><tr><th>Ø§Ù„ØªØ§Ø¬Ø±</th><th>Ø§Ù„Ø±ØµÙŠØ¯ (Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©)</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>${rows}</tbody></table><h4 style="margin-top:10px">ØªÙØ§ØµÙŠÙ„ Ø¢Ø®Ø± Ø§Ù„Ø­Ø±ÙƒØ§Øª</h4><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead><tbody>${txRows}</tbody></table>`;refillLists()}
function addInv(){const n=(qs("#supName").value||"").trim(),a=+qs("#supInv").value||0;if(!n||!a){alert("Ø§Ø³Ù…/Ù‚ÙŠÙ…Ø© ÙØ§ØªÙˆØ±Ø©");return}const S=getSup();S.people=S.people||{};S.people[n]=S.people[n]||{balance:0,history:[]};S.people[n].balance+=a;S.people[n].history.push({id:uid(),date:today(),type:"invoice",amount:a,note:"ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª"});setSup(S);qs("#supName").value="";qs("#supInv").value="";renderSup()}
function paySup(){const n=(qs("#supPayName").value||"").trim(),a=+qs("#supPayAmt").value||0,src=qs("#supSrc").value;if(!n||!a){alert("Ø§Ø³Ù…/Ù…Ø¨Ù„Øº");return}const S=getSup();if(!S.people||!S.people[n]){alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø±");return}S.people[n].balance-=a;S.people[n].history=S.people[n].history||[];S.people[n].history.push({id:uid(),date:today(),type:"pay",amount:a,source:(src==='store'?'ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„':(src==='owner'?'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ':'Ø§Ù„Ø¨Ù†Ùƒ')),note:`Ø¯ÙØ¹Ø© Ù…Ù† ${src==='store'?'ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„':(src==='owner'?'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ':'Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ')}`});setSup(S);
 if(src==='store'){const d=getS();d.expenses.push({id:uid(),date:today(),type:"ÙƒØ§Ø´",desc:`Ø¯ÙØ¹Ø© ØªØ§Ø¬Ø± (${n})`,amount:a,note:"Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„",benefType:"supplier",benefName:n});setS(d);renderLists()}
 else if(src==='owner'){const O=getO();O.ledger.push({id:uid(),date:today(),type:"out",amount:a,note:`Ø¯ÙØ¹Ø© ØªØ§Ø¬Ø± (${n})`,meta:{kind:"manual",bindType:"supplier",bindName:n}});setO(O);updOwnerUI()}
 else{const d=getS();d.expenses.push({id:uid(),date:today(),type:"Ø¨Ù†Ùƒ",desc:`Ø¯ÙØ¹Ø© ØªØ§Ø¬Ø± (${n})`,amount:a,note:"Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ",benefType:"supplier",benefName:n});setS(d);renderLists()}
 qs("#supPayName").value="";qs("#supPayAmt").value="";renderSup();renderOwner()}
function delSup(n){if(!confirm(`Ø­Ø°Ù Ø§Ù„ØªØ§Ø¬Ø± "${n}" ÙˆÙƒÙ„ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙ‡ØŸ`))return;const S=getSup();if(S.people&&S.people[n]){delete S.people[n];setSup(S);renderSup();refillLists();alert("ØªÙ… Ø§Ù„Ø­Ø°Ù")}}
function renderSupStmt(){const n=(qs("#supStmtName").value||"").trim(),f=qs("#supFrom").value||today().slice(0,8)+"01",t=qs("#supTo").value||today();const S=getSup();if(!n||!S.people||!S.people[n]){qs("#supStmtWrap").innerHTML='<div class="hint">Ø§Ø®ØªØ± Ø§Ø³Ù… ØªØ§Ø¬Ø± ØµØ­ÙŠØ­</div>';return}const h=(S.people[n].history||[]).filter(x=>inR(x.date,f,t));const rows=h.length?h.map(x=>`<tr><td>${x.date}</td><td>${x.type==='invoice'?'ÙØ§ØªÙˆØ±Ø© (+)':'Ø¯ÙØ¹Ø© (âˆ’)'}</td><td>${x.amount}</td><td>${x.note||''}</td></tr>`).join(""):`<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª</td></tr>`;qs("#supStmtWrap").innerHTML=`<div class="page"><h3 style="margin:0 0 6px">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ â€” ØªØ§Ø¬Ø±: ${n}</h3><div class="hint">Ø§Ù„ÙØªØ±Ø©: ${f} â†’ ${t}</div><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead><tbody>${rows}</tbody></table><div style="margin-top:8px"><b>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©):</b> ${(S.people[n].balance||0)}</div></div>`}

/* Ø¯ÙŠÙˆÙ† (Ø¹Ù…Ù„Ø§Ø¡) */
function renderDebts(){const D=getD(),ns=Object.keys(D.people||{});if(!ns.length){qs("#debtsWrap").innerHTML='<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ†</div>';refillLists();return}
 const rows=ns.map(n=>`<tr><td>${n}</td><td>${D.people[n].balance||0}</td><td><button class="btn r" onclick="delDebtor('${n.replace(/\'/g,"\\'")}')">ğŸ—‘ Ø­Ø°Ù</button></td></tr>`).join("");
 qs("#debtsWrap").innerHTML=`<table><thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>${rows}</tbody></table>`}
function addDebt(){const n=(qs("#debtName").value||"").trim(),a=+qs("#debtAmt").value||0,nt=(qs("#debtNote").value||"").trim();if(!n||!a){alert("Ø§Ø³Ù…/Ù‚ÙŠÙ…Ø© Ø¯ÙŠÙ†");return}const D=getD();D.people=D.people||{};D.people[n]=D.people[n]||{balance:0,history:[]};D.people[n].balance+=a;D.people[n].history.push({id:uid(),date:today(),type:"debt",amount:a,note:nt||"Ø¯ÙŠÙ† Ù…Ø¨ÙŠØ¹Ø§Øª"});setD(D);qs("#debtName").value="";qs("#debtAmt").value="";qs("#debtNote").value="";renderDebts();refillLists()}
function payDebt(){const n=(qs("#debtPayName").value||"").trim(),a=+qs("#debtPayAmt").value||0,m=qs("#debtMethod").value;if(!n||!a){alert("Ø§Ø³Ù…/Ù…Ø¨Ù„Øº");return}const D=getD();if(!D.people||!D.people[n]){alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„");return}D.people[n].balance-=a;D.people[n].history.push({id:uid(),date:today(),type:"pay",amount:a,note:`Ø³Ø¯Ø§Ø¯ Ø¯ÙŠÙ† (${m})`});setD(D);const d=getS();d.sales.push({id:uid(),date:today(),type:m,amount:a,note:`ØªØ­ØµÙŠÙ„ Ø¯ÙŠÙ† Ù…Ù† ${n}`,meta:{kind:"debtCollection"}});setS(d);qs("#debtPayName").value="";qs("#debtPayAmt").value="";renderDebts();renderLists()}
function delDebtor(n){if(!confirm(`Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ "${n}" ÙˆÙƒÙ„ Ø³Ø¬Ù„Ø§ØªÙ‡ØŸ`))return;const D=getD();if(D.people&&D.people[n]){delete D.people[n];setD(D);renderDebts();refillLists();alert("ØªÙ… Ø§Ù„Ø­Ø°Ù")}}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¥ÙŠØ¯Ø§Ø¹/Ø³Ø­Ø¨/Ø­Ø°Ù/ÙƒØ´Ù */
function ownerDeposit(){const a=+qs("#ownIn").value||0,nt=(qs("#ownInNote").value||"").trim();if(!a){alert("Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø¥ÙŠØ¯Ø§Ø¹");return}const O=getO();O.ledger.push({id:uid(),date:today(),type:"in",amount:a,note:nt||"Ø¥ÙŠØ¯Ø§Ø¹ ÙŠØ¯ÙˆÙŠ",meta:{kind:"manual"}});setO(O);updOwnerUI();qs("#ownIn").value="";qs("#ownInNote").value="";renderOwner()}
function ownerWithdraw(){const a=+qs("#ownOut").value||0,bt=qs("#ownBind").value,who=(qs("#ownWho").value||"").trim(),nt=(qs("#ownOutNote").value||"").trim();if(!a){alert("Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø­Ø¨");return}const O=getO();O.ledger.push({id:uid(),date:today(),type:"out",amount:a,note:nt||(bt?(`Ø³Ø­Ø¨ â€” Ø³Ø¯Ø§Ø¯ ${bt==='supplier'?'ØªØ§Ø¬Ø±':'Ù…Ø³Ù„Ù'} (${who})`):"Ø³Ø­Ø¨"),meta:{kind:"manual",bindType:bt||"",bindName:who||""}});setO(O);updOwnerUI();
 if(bt&&who){if(bt==='supplier'){const S=getSup();S.people=S.people||{};S.people[who]=S.people[who]||{balance:0,history:[]};S.people[who].balance-=a;S.people[who].history.push({id:uid(),date:today(),type:"pay",amount:a,source:"ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ",note:"Ø¯ÙØ¹Ø© (Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ)"});setSup(S);renderSup()}else{const L=getL();L.people=L.people||{};L.people[who]=L.people[who]||{balance:0,history:[]};L.people[who].balance-=a;L.people[who].history.push({id:uid(),date:today(),type:"out",amount:a,source:"ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ",note:"Ø³Ø¯Ø§Ø¯ (Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ)"});setL(L);renderLoans()}}
 qs("#ownOut").value="";qs("#ownOutNote").value="";qs("#ownBind").value="";qs("#ownWho").value="";renderOwner()}
function delOwner(id){if(!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚ÙŠØ¯ Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„ÙƒØŸ Ø³ÙŠØªÙ… Ø¹ÙƒØ³ Ø§Ù„Ø±Ø¨Ø· Ø¥Ù† ÙˆØ¬Ø¯."))return;const O=getO();const i=O.ledger.findIndex(e=>e.id===id);if(i===-1)return;const e=O.ledger[i],m=e.meta||{};if(e.type==="out"&&m.kind==="manual"&&m.bindType&&m.bindName){if(m.bindType==="supplier"){const S=getSup();if(S.people&&S.people[m.bindName]){S.people[m.bindName].balance+=+e.amount;S.people[m.bindName].history.push({id:uid(),date:today(),type:"revert",amount:e.amount,note:"Ø¥Ù„ØºØ§Ø¡ Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚"});setSup(S)}}else if(m.bindType==="loan"){const L=getL();if(L.people&&L.people[m.bindName]){L.people[m.bindName].balance+=+e.amount;L.people[m.bindName].history.push({id:uid(),date:today(),type:"revert",amount:e.amount,note:"Ø¥Ù„ØºØ§Ø¡ Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚"});setL(L)}}}O.ledger.splice(i,1);setO(O);updOwnerUI();renderOwner()}
function renderOwner(){const f=qs("#ofFrom").value||today().slice(0,8)+"01",t=qs("#ofTo").value||today(),O=getO(),rows=O.ledger.filter(x=>inR(x.date,f,t)),ins=sum(rows,x=>x.type==='in'?+x.amount:0),outs=sum(rows,x=>x.type==='out'?+x.amount:0);const tbl=rows.length?rows.map(e=>`<tr><td>${e.date}</td><td>${e.type==='in'?'ØªØ­ØµÙŠÙ„':'ØµØ±Ù'}</td><td>${e.amount}</td><td>${e.note||''}</td><td class="pr"><button class="btn r" onclick="delOwner('${e.id}')">Ø­Ø°Ù</button></td></tr>`).join(""):`<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª</td></tr>`;qs("#ownerWrap").innerHTML=`<div class="page"><h2 style="margin:0 0 6px">ÙƒØ´Ù ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</h2><div class="hint">Ø§Ù„ÙØªØ±Ø©: <b>${f}</b> â†’ <b>${t}</b> â€” Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <b>${today()}</b></div><div class="sep"></div><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th><th class="pr">Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>${tbl}</tbody></table><div style="margin-top:8px"><b>ØªØ­ØµÙŠÙ„:</b> ${ins} â€” <b>ØµØ±Ù:</b> ${outs} â€” <b>Ø§Ù„Ø±ØµÙŠØ¯:</b> ${ins-outs}</div><div style="margin-top:26px;display:flex;justify-content:space-between"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ _________</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: _________</div></div></div>`;updOwnerUI(); renderOwnerAgg()}
function renderOwnerAgg(){const d=qs("#today").value||today(),shops=Object.keys(stores);let R='',tc=0,tb=0;shops.forEach(s=>{const S=getS(s),cs=sum(S.sales.filter(x=>x.date===d&&x.type==="ÙƒØ§Ø´"),x=>+x.amount),bs=sum(S.sales.filter(x=>x.date===d&&x.type==="Ø¨Ù†Ùƒ"),x=>+x.amount),ce=sum(S.expenses.filter(x=>x.date===d&&x.type==="ÙƒØ§Ø´"),x=>+x.amount),be=sum(S.expenses.filter(x=>x.date===d&&x.type==="Ø¨Ù†Ùƒ"),x=>+x.amount),nc=cs-ce,nb=bs-be;tc+=Math.max(0,nc);tb+=Math.max(0,nb);R+=`<tr><td>${stores[s]}</td><td>${cs}</td><td>${ce}</td><td><b>${nc}</b></td><td>${bs}</td><td>${be}</td><td><b>${nb}</b></td></tr>`});qs("#ownerAggWrap").innerHTML=`<table><thead><tr><th>Ø§Ù„Ù…Ø­Ù„</th><th>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</th><th>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</th><th>ØµØ§ÙÙŠ ÙƒØ§Ø´</th><th>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</th><th>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</th><th>ØµØ§ÙÙŠ Ø¨Ù†Ùƒ</th></tr></thead><tbody>${R}</tbody><tfoot><tr><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th colspan="2"></th><th>${tc}</th><th colspan="2"></th><th>${tb}</th></tr></tfoot></table><div class="hint">Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙŠØ³ØªÙ‚Ø¨Ù„ ØµØ§ÙÙŠ Ø§Ù„ÙƒØ§Ø´ ÙÙ‚Ø·.</div>`}

/* Ø´Ù‡Ø±ÙŠ */
function reportMonthly(){const ym=(qs("#mMonth").value||today().slice(0,7));let SS=[],EE=[];Object.keys(stores).forEach(s=>{const d=getS(s);SS=SS.concat(d.sales.filter(x=>x.date.slice(0,7)===ym));EE=EE.concat(d.expenses.filter(x=>x.date.slice(0,7)===ym))});const ts=totals(SS),te=totals(EE),nc=ts.cs-te.cs,nb=ts.bn-te.bn;const O=getO(),rows=O.ledger.filter(x=>x.date.slice(0,7)===ym),ins=sum(rows,x=>x.type==='in'?+x.amount:0),outs=sum(rows,x=>x.type==='out'?+x.amount:0);qs("#monthlyWrap").innerHTML=`<div class="page"><h2 style="margin:0 0 6px">ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ Ù…Ø¬Ù…Ù‘Ø¹ â€” ${ym}</h2><div class="hint">ÙŠØ´Ù…Ù„ ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª + ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ â€” Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <b>${today()}</b></div><div class="sep"></div><table><thead><tr><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead><tbody><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</td><td>${ts.cs}</td></tr><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</td><td>${ts.bn}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</td><td>${te.cs}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</td><td>${te.bn}</td></tr><tr><td><b>ØµØ§ÙÙŠ Ø§Ù„ÙƒØ§Ø´</b></td><td><b>${nc}</b></td></tr><tr><td><b>ØµØ§ÙÙŠ Ø§Ù„Ø¨Ù†Ùƒ</b></td><td><b>${nb}</b></td></tr><tr><td><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ§ÙÙŠ</b></td><td><b>${nc+nb}</b></td></tr><tr><td>ØªØ­ØµÙŠÙ„Ø§Øª ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</td><td>${ins}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</td><td>${outs}</td></tr><tr><td><b>Ø±ØµÙŠØ¯ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø®Ù„Ø§Ù„ Ø§Ù„Ø´Ù‡Ø±</b></td><td><b>${ins-outs}</b></td></tr></tbody></table><div style="margin-top:26px;display:flex;justify-content:space-between"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ _________</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: _________</div></div></div>`}

/* Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ */
function exportBackup(){const payload={version:"final-packed-1",at:new Date().toISOString(),stores:{s1:getS("s1"),s2:getS("s2"),s3:getS("s3")},loans:getL(),suppliers:getSup(),debts:getD(),owner_fund:getO()};const blob=new Blob([JSON.stringify(payload)],{type:"application/json"});const a=document.createElement("a"),ts=new Date();a.href=URL.createObjectURL(blob);a.download=`backup-${ts.getFullYear()}${p2(ts.getMonth()+1)}${p2(ts.getDate())}-${p2(ts.getHours())}${p2(ts.getMinutes())}.json`;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(a.href),800)}
function importBackup(file){if(!file){alert("Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø©");return}const r=new FileReader();r.onload=e=>{try{const data=JSON.parse(e.target.result);if(!data||!data.stores)throw new Error("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");localStorage.setItem("s1",JSON.stringify(data.stores.s1||{"sales":[],"expenses":[]}));
localStorage.setItem("s2",JSON.stringify(data.stores.s2||{"sales":[],"expenses":[]}));
localStorage.setItem("s3",JSON.stringify(data.stores.s3||{"sales":[],"expenses":[]}));
localStorage.setItem("owner_fund",JSON.stringify(data.owner_fund||{"ledger":[]}));
localStorage.setItem("loans",JSON.stringify(data.loans||{"people":{}}));
localStorage.setItem("suppliers",JSON.stringify(data.suppliers||{"people":{}}));
localStorage.setItem("debts",JSON.stringify(data.debts||{"people":{}}));
renderLists();renderLoans();renderSup();renderDebts();renderOwner();updOwnerUI();refillLists()}catch(err){alert("ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: "+err.message)}};r.readAsText(file)}

/* ØªÙ‡ÙŠØ¦Ø© + PWA */
document.addEventListener("DOMContentLoaded",()=>{const t=today();["today","rDate","ofFrom","fFrom","aggDay"].forEach(id=>{const x=qs("#"+id);if(x)x.value=t});const x1=qs("#ofTo");if(x1)x1.value=t;const x2=qs("#fTo");if(x2)x2.value=t;tab("input");renderLists();renderLoans();renderSup();renderDebts();renderOwner();updOwnerUI();refillLists();
 const manifest={"name":"Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©","short_name":"Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©","start_url":"./","display":"standalone","background_color":"#eaf3ff","theme_color":"#58a8ff","icons":[{"src":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='256' height='256'%3E%3Crect width='100%25' height='100%25' fill='%2358a8ff'/%3E%3Ctext x='50%25' y='55%25' text-anchor='middle' font-size='120' fill='white'%3E%F0%9F%93%8A%3C/text%3E%3C/svg%3E","sizes":"256x256","type":"image/svg+xml"}]};const mblob=new Blob([JSON.stringify(manifest)],{type:"application/manifest+json"}),murl=URL.createObjectURL(mblob);const link=document.createElement("link");link.rel="manifest";link.href=murl;document.head.appendChild(link);
 if("serviceWorker" in navigator){const sw=`const C='acc-pwa-v1',A=['./',''];self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll(A)).then(()=>self.skipWaiting()))});self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});self.addEventListener('fetch',e=>{const r=e.request;e.respondWith(caches.match(r).then(m=>m||fetch(r).then(res=>{if(r.method==='GET'&&new URL(r.url).origin===location.origin){const cp=res.clone();caches.open(C).then(c=>c.put(r,cp))}return res}).catch(()=>caches.match('./'))))});`;const swb=new Blob([sw],{type:"text/javascript"}),swu=URL.createObjectURL(swb);navigator.serviceWorker.register(swu).catch(console.error)}})
</script>
</body></html>
