<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©</title>
<meta name="theme-color" content="#2b7bff"/>
<link rel="manifest" href="./manifest.webmanifest"/>
<style>
:root{--blue:#2b7bff;--blue-soft:#eaf3ff;--line:#e5e7eb;--card:#fff;--danger:#dc3545;--ok:#16a34a;--muted:#64748b}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:Tajawal,Segoe UI,Tahoma,Arial,sans-serif;background:var(--blue-soft);color:#0f172a}
header{position:sticky;top:0;z-index:10;background:var(--blue);color:#fff;padding:10px 14px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
header h1{margin:0;font-size:18px}
header .owner-badge{margin-top:6px;font-size:14px;color:#eaf5ff;background:rgba(255,255,255,.12);display:inline-block;padding:6px 10px;border-radius:10px}
main{padding:12px;max-width:1200px;margin:auto;padding-bottom:160px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 1px 6px rgba(0,0,0,.04)}
h3{margin:6px 0 10px}
.row{display:flex;flex-wrap:wrap;gap:10px}
.col{flex:1;min-width:190px}
label{font-size:13px;color:#111}
input,select,textarea,button{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:15px;background:#fff}
textarea{min-height:70px;resize:vertical}
button{border:none;cursor:pointer}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border-radius:12px;padding:10px 14px;font-size:14px}
.btn-primary{background:var(--blue);color:#fff}
.btn-outline{background:#fff;border:1px solid var(--line);color:#111}
.btn-danger{background:var(--danger);color:#fff}
.btn-ok{background:var(--ok);color:#fff}
.hint{font-size:12px;color:var(--muted)}
.list .item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 0;border-bottom:1px dashed var(--line)}
.list .item:last-child{border-bottom:none}
.list .meta{flex:1}
.kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
.kpi .box{background:#f3f7ff;border:1px solid #e3ecff;border-radius:12px;padding:10px;text-align:center}
.kpi .box b{display:block;font-size:16px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--line);padding:8px;text-align:center;font-size:14px}
th{background:#f8fbff}
.tabs{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--line);display:flex}
.tab{flex:1}
.tab button{width:100%;background:#fff;border:none;padding:12px 0}
.tab.active{background:#f0f6ff}
.tag{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px}
.subtle{background:#f9fbff;border:1px solid #eef2ff;border-radius:12px;padding:10px;margin-top:8px}
.separator{height:1px;background:var(--line);margin:8px 0}
h2.section{margin:0 0 8px}
@media print{header,nav.tabs,.print-hide{display:none!important} body{background:#fff} .card{box-shadow:none;border:none;padding:0;margin:0} .page{page-break-after:always;margin-bottom:30px}}
</style>
</head>
<body>
<header class="print-hide">
  <h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©</h1>
  <div class="owner-badge">Ø±ØµÙŠØ¯ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ: <b id="ownerBalanceVal">0</b></div>
</header>

<main>
  <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø³Ø±ÙŠØ¹Ø© + ØªØ³ÙˆÙŠØ© Ù…Ø¬Ù…Ø¹Ø© -->
  <div class="card print-hide">
    <div class="row">
      <div class="col">
        <label>Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ù†Ø´Ø·</label>
        <select id="storeSelect" onchange="changeStore()">
          <option value="store1">Ø±ÙˆØ§Ù† Ø¨ÙŠØ¨ÙŠ</option>
          <option value="store2">Ø¬Ù†ØªÙ„ Ø¨ÙŠØ¨ÙŠ Ø¹Ø¨ÙˆØ¯</option>
          <option value="store3">Ø¨Ø³Ø·Ø©</option>
        </select>
      </div>
      <div class="col">
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</label>
        <input type="date" id="todayInput"/>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button class="btn btn-primary" onclick="settleDay()">ØªØ³ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ… Ù„Ù„Ù…Ø­Ù„ Ø§Ù„Ù†Ø´Ø·</button>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button class="btn btn-outline" onclick="previewAllStores()">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© ØªØ­ØµÙŠÙ„ ÙƒÙ„ Ù…Ø­Ù„ (Ø§Ù„ÙŠÙˆÙ…)</button>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button class="btn btn-ok" onclick="settleAllStores()">ğŸ’¼ ØªØ³ÙˆÙŠØ© Ù…Ø¬Ù…Ù‘Ø¹Ø© (ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª)</button>
      </div>
    </div>
    <div class="hint">Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø­Ù„ÙŠ + ÙŠØ¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ù…Ø¹ manifest/sw.js.</div>
  </div>

  <!-- Ø¥Ø¯Ø®Ø§Ù„ -->
  <section class="card" data-tab="input">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
    <div class="row">
      <div class="col"><input type="number" id="saleAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
      <div class="col"><select id="saleType"><option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option><option value="Ø¨Ù†Ùƒ">Ø¨Ù†Ùƒ</option></select></div>
      <div class="col"><input type="text" id="saleNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ/Ø§Ù„ØµÙ†Ù/Ø¬ÙˆØ§Ù„)"></div>
      <div class="col"><button class="btn btn-ok" onclick="addSale()">â• Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ¹</button></div>
    </div>
    <div id="recentSales" class="list"></div>

    <h3 style="margin-top:18px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (Ù…Ù† ÙƒØ§Ø´/Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø­Ù„)</h3>
    <div class="row">
      <div class="col"><input type="text" id="expenseDesc" placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ"></div>
      <div class="col"><input type="number" id="expenseAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
      <div class="col"><select id="expenseType"><option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option><option value="Ø¨Ù†Ùƒ">Ø¨Ù†Ùƒ</option></select></div>
      <div class="col"><input type="text" id="expenseNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
    </div>
    <div class="row">
      <div class="col">
        <select id="expenseBenefType">
          <option value="">â€” Ø±Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€”</option>
          <option value="supplier">Ø³Ø¯Ø§Ø¯ ØªØ§Ø¬Ø±</option>
          <option value="loan">Ø³Ø¯Ø§Ø¯ Ù…Ø³Ù„Ù</option>
        </select>
      </div>
      <div class="col">
        <input type="text" id="expenseBenefName" list="benefList" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ³ÙŠØ¸Ù‡Ø± Ø§Ù‚ØªØ±Ø§Ø­">
        <datalist id="benefList"></datalist>
      </div>
      <div class="col">
        <button class="btn btn-ok" id="addExpenseBtn">â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
      </div>
    </div>
    <div id="recentExpenses" class="list"></div>
  </section>

  <!-- ÙŠÙˆÙ…ÙŠ -->
  <section class="card" data-tab="daily">
    <h3>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
    <div class="row print-hide">
      <div class="col"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="r_date"></div>
      <div class="col"><label>Ø§Ù„Ù…Ø­Ù„</label>
        <select id="r_store">
          <option value="store1">Ø±ÙˆØ§Ù† Ø¨ÙŠØ¨ÙŠ</option>
          <option value="store2">Ø¬Ù†ØªÙ„ Ø¨ÙŠØ¨ÙŠ Ø¹Ø¨ÙˆØ¯</option>
          <option value="store3">Ø¨Ø³Ø·Ø©</option>
        </select>
      </div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="generateDaily()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button></div>
    </div>
    <div id="dailyWrap"></div>
  </section>

  <!-- ÙØªØ±Ø© / Ù…Ø¬Ù…Ù‘Ø¹ -->
  <section class="card" data-tab="range">
    <h3>ØªÙ‚Ø±ÙŠØ± ÙØªØ±Ø© / Ù…Ø¬Ù…Ù‘Ø¹</h3>
    <div class="row print-hide">
      <div class="col"><label>Ù…Ù†</label><input type="date" id="f_from"></div>
      <div class="col"><label>Ø¥Ù„Ù‰</label><input type="date" id="f_to"></div>
      <div class="col"><label>Ø§Ù„Ù†Ù…Ø·</label><select id="f_mode"><option value="per">Ù…Ù†ÙØµÙ„ Ù„ÙƒÙ„ Ù…Ø­Ù„</option><option value="all">Ù…Ø¬Ù…Ù‘Ø¹ Ù„Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø©</option></select></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="generateRange()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button></div>
    </div>
    <div id="rangeWrap"></div>
  </section>

  <!-- Ø§Ù„Ø³ÙÙ„Ù -->
  <section class="card" data-tab="loans">
    <h3>Ø§Ù„Ø³ÙÙ„Ù (ÙƒØ§Ø´ ÙÙ‚Ø·)</h3>
    <div class="row">
      <div class="col"><input type="text" id="loanPerson" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙØ³Ù„Ù"></div>
      <div class="col"><input type="number" id="loanAmount" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù„ÙØ© (+)"></div>
      <div class="col"><button class="btn btn-ok" onclick="addLoan()">â• Ø¥Ø¶Ø§ÙØ© Ø³Ù„ÙØ©</button></div>
    </div>
    <div class="row">
      <div class="col"><input type="text" id="loanPayPerson" list="loanList" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙØ³Ù„Ù â€” Ø³Ø¯Ø§Ø¯"></div>
      <datalist id="loanList"></datalist>
      <div class="col"><input type="number" id="loanPayAmount" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø¯Ø§Ø¯ (âˆ’)"></div>
      <div class="col"><select id="loanPaySource"><option value="store">Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„</option><option value="owner">Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</option></select></div>
      <div class="col"><button class="btn btn-primary" onclick="payLoan()">ğŸ’¸ ØªØ³Ø¬ÙŠÙ„ Ø³Ø¯Ø§Ø¯</button></div>
    </div>

    <div class="subtle print-hide" style="margin-top:8px">
      <div class="row">
        <div class="col"><input id="loanStmtName" list="loanList" placeholder="Ø§Ø³Ù… Ù…Ø³Ù„Ù â€” ÙƒØ´Ù Ù…ÙØµÙ„"></div>
        <div class="col"><input type="date" id="loanFrom"></div>
        <div class="col"><input type="date" id="loanTo"></div>
        <div class="col"><button class="btn btn-outline" onclick="renderLoanStmt()">ğŸ“„ Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ù…Ø³Ù„Ù</button></div>
        <div class="col"><button class="btn btn-outline" onclick="printSection()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù</button></div>
      </div>
    </div>

    <div id="loansWrap" class="subtle" style="margin-top:8px"></div>
    <div id="loanStmtWrap"></div>
  </section>

  <!-- Ø§Ù„ØªØ¬Ø§Ø± -->
  <section class="card" data-tab="suppliers">
    <h3>Ø§Ù„ØªÙØ¬Ø§Ø±</h3>
    <div class="row">
      <div class="col"><input type="text" id="supName" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±"></div>
      <div class="col"><input type="number" id="supInvoice" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (+)"></div>
      <div class="col"><button class="btn btn-ok" onclick="addSupplierInvoice()">â• ØªØ³Ø¬ÙŠÙ„ ÙØ§ØªÙˆØ±Ø©</button></div>
    </div>
    <div class="row">
      <div class="col"><input type="text" id="supPayName" list="supList" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± â€” Ø¯ÙØ¹Ø©"></div>
      <datalist id="supList"></datalist>
      <div class="col"><input type="number" id="supPayAmount" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø© (âˆ’)"></div>
      <div class="col"><select id="supPaySource">
        <option value="store">Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„</option>
        <option value="owner">Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</option>
        <option value="bank">Ù…Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ</option>
      </select></div>
      <div class="col"><button class="btn btn-primary" onclick="paySupplier()">ğŸ’³ ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©</button></div>
    </div>

    <div class="subtle print-hide" style="margin-top:8px">
      <div class="row">
        <div class="col"><input id="supStmtName" list="supList" placeholder="Ø§Ø³Ù… ØªØ§Ø¬Ø± â€” ÙƒØ´Ù Ù…ÙØµÙ„"></div>
        <div class="col"><input type="date" id="supFrom"></div>
        <div class="col"><input type="date" id="supTo"></div>
        <div class="col"><button class="btn btn-outline" onclick="renderSupplierStmt()">ğŸ“„ Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„ØªØ§Ø¬Ø±</button></div>
        <div class="col"><button class="btn btn-outline" onclick="printSection()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù</button></div>
      </div>
    </div>

    <div id="supWrap" class="subtle" style="margin-top:8px"></div>
    <div id="supStmtWrap"></div>
  </section>

  <!-- Ø§Ù„Ø¯ÙŠÙˆÙ† (Ø§Ù„Ù…Ø¯ÙŠÙ†ÙˆÙ†) -->
  <section class="card" data-tab="debts">
    <h3>Ø§Ù„Ø¯ÙŠÙˆÙ† (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡) â€” Ø£Ø±ØµØ¯Ø© + ØªÙØ§ØµÙŠÙ„ + Ø·Ø¨Ø§Ø¹Ø©</h3>
    <div class="row">
      <div class="col"><input id="debtName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"></div>
      <div class="col"><input type="number" id="debtAmt" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙŠÙ† (+)"></div>
      <div class="col"><input id="debtNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
      <div class="col"><button class="btn btn-ok" onclick="addDebt()">â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ†</button></div>
    </div>
    <div class="row">
      <div class="col"><input id="debtPayName" list="debtList" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ â€” Ø³Ø¯Ø§Ø¯ Ø¯ÙŠÙ†"></div>
      <datalist id="debtList"></datalist>
      <div class="col"><input type="number" id="debtPayAmt" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø¯Ø§Ø¯ (âˆ’)"></div>
      <div class="col"><select id="debtMethod"><option>ÙƒØ§Ø´</option><option>Ø¨Ù†Ùƒ</option></select></div>
      <div class="col"><button class="btn btn-primary" onclick="payDebt()">âœ… ØªØ³Ø¬ÙŠÙ„ Ø³Ø¯Ø§Ø¯ Ø¯ÙŠÙ†</button></div>
    </div>

    <div class="subtle print-hide" style="margin-top:8px">
      <div class="row">
        <div class="col"><button class="btn btn-outline" onclick="printSection()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶</button></div>
      </div>
    </div>

    <div class="subtle print-hide" style="margin-top:8px">
      <div class="row">
        <div class="col"><input id="debtStmtName" list="debtList" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ â€” ÙƒØ´Ù Ù…ÙØµÙ„"></div>
        <div class="col"><input type="date" id="debtFrom"></div>
        <div class="col"><input type="date" id="debtTo"></div>
        <div class="col"><button class="btn btn-outline" onclick="renderDebtStmt()">ğŸ“„ Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ø¹Ù…ÙŠÙ„</button></div>
        <div class="col"><button class="btn btn-outline" onclick="printSection()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù</button></div>
      </div>
    </div>

    <div id="debtsWrap" class="subtle" style="margin-top:8px"></div>
    <div id="debtStmtWrap"></div>
  </section>

  <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ -->
  <section class="card" data-tab="owner">
    <h3>ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ â€” ÙƒØ´Ù/ØªØ­ØµÙŠÙ„ Ù…Ø¬Ù…Ù‘Ø¹ + Ø³Ø­Ø¨ Ù…ÙˆØ¬Ù‡</h3>

    <!-- Ù…Ø¹Ø§ÙŠÙ†Ø©/ØªÙ‚Ø±ÙŠØ± Ù…Ø¬Ù…Ø¹ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª -->
    <div class="subtle">
      <h4>ØªÙ‚Ø±ÙŠØ± Ù…Ø¬Ù…Ù‘Ø¹ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª (ØªÙØµÙŠÙ„ ÙƒØ§Ø´/Ø¨Ù†Ùƒ Ù„ÙƒÙ„ Ù…Ø­Ù„)</h4>
      <div class="row print-hide">
        <div class="col"><label>Ù…Ù†</label><input type="date" id="of_from"></div>
        <div class="col"><label>Ø¥Ù„Ù‰</label><input type="date" id="of_to"></div>
        <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="renderOwnerAggregate()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div>
        <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div>
      </div>
      <div id="ownerAggWrap"></div>
    </div>

    <!-- ÙƒØ´Ù Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù†ÙØ³Ù‡ -->
    <div class="subtle" style="margin-top:12px">
      <h4>ÙƒØ´Ù ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ (Ø§Ù„Ø­Ø±ÙƒØ§Øª) â€” Ù…Ø¹ Ø­Ø°Ù Ø§Ù„Ù‚ÙŠØ¯</h4>
      <div class="row print-hide">
        <div class="col"><label>Ù…Ù†</label><input type="date" id="ox_from"></div>
        <div class="col"><label>Ø¥Ù„Ù‰</label><input type="date" id="ox_to"></div>
        <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="renderOwnerStatement()">Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ´Ù</button></div>
        <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù</button></div>
      </div>
      <div id="ownerWrap"></div>
    </div>

    <!-- Ø³Ø­Ø¨ Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ -->
    <div class="subtle" style="margin-top:12px">
      <h4>Ø³Ø­Ø¨ Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ (Ù…ÙˆØ¬Ù‘Ù‡ Ù„ØªØ§Ø¬Ø±/Ù…Ø³Ù„Ù)</h4>
      <div class="row">
        <div class="col"><input id="ownerPayName" list="supList" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±/Ø§Ù„Ù…Ø³Ù„Ù"></div>
        <div class="col">
          <select id="ownerPayType">
            <option value="supplier">Ø³Ø¯Ø§Ø¯ ØªØ§Ø¬Ø±</option>
            <option value="loan">Ø³Ø¯Ø§Ø¯ Ù…Ø³Ù„Ù</option>
          </select>
        </div>
        <div class="col"><input type="number" id="ownerPayAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (âˆ’)"></div>
        <div class="col"><button class="btn btn-danger" onclick="ownerPayOut()">Ø³Ø­Ø¨ Ù…ÙˆØ¬Ù‘Ù‡</button></div>
      </div>
      <div class="hint">Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ§Ø¬Ø±/Ø§Ù„Ù…Ø³Ù„Ù ÙˆØªØ³Ø¬ÙŠÙ„Ù‡ ÙÙŠ ÙƒØ´Ù ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ. ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù‚ÙŠØ¯ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù…Ù† Ø§Ù„ÙƒØ´Ù.</div>
    </div>

    <!-- Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ -->
    <div class="subtle print-hide" style="margin-top:12px">
      <h4>Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h4>
      <div class="row">
        <div class="col"><button class="btn btn-outline" onclick="exportBackup()">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button></div>
        <div class="col">
          <label for="importFile" class="btn btn-ok" style="display:inline-block;cursor:pointer;text-align:center">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø©</label>
          <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importBackup(this.files[0])"/>
        </div>
      </div>
      <div class="hint">ØªØ´Ù…Ù„ Ø§Ù„Ù…Ø­Ù„Ø§Øª + Ø§Ù„Ø³Ù„Ù + Ø§Ù„ØªØ¬Ø§Ø± + Ø§Ù„Ø¯ÙŠÙˆÙ† + ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ.</div>
    </div>
  </section>
</main>

<nav class="tabs print-hide">
  <div class="tab active"><button onclick="showTab('input')">Ø¥Ø¯Ø®Ø§Ù„</button></div>
  <div class="tab"><button onclick="showTab('daily')">ÙŠÙˆÙ…ÙŠ</button></div>
  <div class="tab"><button onclick="showTab('range')">ÙØªØ±Ø©/Ù…Ø¬Ù…Ù‘Ø¹</button></div>
  <div class="tab"><button onclick="showTab('loans')">Ø³ÙÙ„Ù</button></div>
  <div class="tab"><button onclick="showTab('suppliers')">ØªÙØ¬Ø§Ø±</button></div>
  <div class="tab"><button onclick="showTab('debts')">Ø¯ÙŠÙˆÙ†</button></div>
  <div class="tab"><button onclick="showTab('owner')">Ø§Ù„Ù…Ø§Ù„Ùƒ</button></div>
</nav>

<script>
/* ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===== */
const stores={store1:"Ø±ÙˆØ§Ù† Ø¨ÙŠØ¨ÙŠ",store2:"Ø¬Ù†ØªÙ„ Ø¨ÙŠØ¨ÙŠ Ø¹Ø¨ÙˆØ¯",store3:"Ø¨Ø³Ø·Ø©"};let currentStore="store1";
const qs=s=>document.querySelector(s), qsa=s=>Array.from(document.querySelectorAll(s));
const today=()=>new Date().toISOString().slice(0,10);
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,7);
const inR=(iso,from,to)=>{if(!iso)return false;const d=new Date(iso+"T00:00:00");return(!from||d>=new Date(from+"T00:00:00"))&&(!to||d<=new Date(to+"T00:00:00"));};
const sum=(arr,fn)=>arr.reduce((a,b)=>a+fn(b),0);

/* ===== ØªØ®Ø²ÙŠÙ† ===== */
const getStoreData=(st=currentStore)=>JSON.parse(localStorage.getItem(st)||'{"sales":[],"expenses":[]}');
const saveStoreData=(data,st=currentStore)=>localStorage.setItem(st,JSON.stringify(data));
const getOwner=()=>JSON.parse(localStorage.getItem('owner_fund')||'{"ledger":[]}');
const saveOwner=v=>localStorage.setItem('owner_fund',JSON.stringify(v));
const getLoans=()=>JSON.parse(localStorage.getItem('loans')||'{"people":{}}');
const saveLoans=v=>localStorage.setItem('loans',JSON.stringify(v));
const getSuppliers=()=>JSON.parse(localStorage.getItem('suppliers')||'{"people":{}}');
const saveSuppliers=v=>localStorage.setItem('suppliers',JSON.stringify(v));
const getDebts=()=>JSON.parse(localStorage.getItem('debts')||'{"people":{}}');
const saveDebts=v=>localStorage.setItem('debts',JSON.stringify(v));

/* ===== ÙˆØ§Ø¬Ù‡Ø© ===== */
function changeStore(){currentStore=qs('#storeSelect').value;renderLists()}
function showTab(name){
  qsa('[data-tab]').forEach(el=>el.style.display=(el.getAttribute('data-tab')===name?'block':'none'));
  const order=['input','daily','range','loans','suppliers','debts','owner'];
  qsa('.tabs .tab').forEach((t,i)=>t.classList.toggle('active',order[i]===name));
  if(name==='input'){renderLists();refillLists()}
  if(name==='loans'){renderLoans()}
  if(name==='suppliers'){renderSuppliers()}
  if(name==='debts'){renderDebts()}
  if(name==='owner'){updateOwnerBalanceUI();renderOwnerStatement()}
}
function printSection(){window.print()}

/* ===== Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø£Ø³Ù…Ø§Ø¡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ===== */
function supplierNames(){const S=getSuppliers();return S.people?Object.keys(S.people):[]}
function loanNames(){const L=getLoans();return L.people?Object.keys(L.people):[]}
function debtorNames(){const D=getDebts();return D.people?Object.keys(D.people):[]}
function refillLists(){
  const dl=qs('#benefList'); if(dl){const names=[...new Set([...supplierNames(),...loanNames()])]; dl.innerHTML=names.map(n=>`<option value="${n}">`).join('')}
  const dl2=qs('#loanList'); if(dl2){dl2.innerHTML=loanNames().map(n=>`<option value="${n}">`).join('')}
  const dl3=qs('#supList'); if(dl3){dl3.innerHTML=supplierNames().map(n=>`<option value="${n}">`).join('')}
  const dl4=qs('#debtList'); if(dl4){dl4.innerHTML=debtorNames().map(n=>`<option value="${n}">`).join('')}
}

/* ===== Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ===== */
function addSale(){
  const a=parseFloat(qs('#saleAmount').value||'0'), t=qs('#saleType').value, n=(qs('#saleNote').value||'').trim();
  if(!a){alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');return}
  const d=getStoreData(); d.sales.push({id:uid(),date:today(),type:t,amount:a,note:n}); saveStoreData(d);
  qs('#saleAmount').value=''; qs('#saleNote').value=''; renderLists();
}
function deleteSale(id){
  const d=getStoreData(); const i=d.sales.findIndex(x=>x.id===id);
  if(i>-1){ if(!confirm('Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ØŸ'))return; d.sales.splice(i,1); saveStoreData(d); renderLists(); }
}

/* ===== Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ + Ø±Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ØªØ§Ø¬Ø±/Ù…Ø³Ù„Ù ===== */
function _deductSupplier(name, amt, sourceNote){
  const S=getSuppliers(); if(!S.people) S.people={}; if(!S.people[name]) S.people[name]={balance:0,history:[]};
  S.people[name].balance -= amt;
  S.people[name].history.push({id:uid(),date:today(),type:'pay',amount:amt,note:sourceNote||'Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡',source:'store'});
  saveSuppliers(S); renderSuppliers?.(); refillLists();
}
function _undeductSupplier(name, amt, revertNote){
  const S=getSuppliers(); if(!S.people||!S.people[name]) return;
  S.people[name].balance += amt; S.people[name].history.push({id:uid(),date:today(),type:'revert',amount:amt,note:revertNote||'Ø¥Ù„ØºØ§Ø¡ Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡'});
  saveSuppliers(S); renderSuppliers?.(); refillLists();
}
function _deductLoan(name, amt, sourceNote){
  const L=getLoans(); if(!L.people) L.people={}; if(!L.people[name]) L.people[name]={balance:0,history:[]};
  L.people[name].balance -= amt;
  L.people[name].history.push({id:uid(),date:today(),type:'out',amount:amt,note:sourceNote||'Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡',source:'store'});
  saveLoans(L); renderLoans?.(); refillLists();
}
function _undeductLoan(name, amt, revertNote){
  const L=getLoans(); if(!L.people||!L.people[name]) return;
  L.people[name].balance += amt; L.people[name].history.push({id:uid(),date:today(),type:'revert',amount:amt,note:revertNote||'Ø¥Ù„ØºØ§Ø¡ Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡'});
  saveLoans(L); renderLoans?.(); refillLists();
}
function addExpense(){
  const desc=(qs('#expenseDesc').value||'').trim();
  const a=parseFloat(qs('#expenseAmount').value||'0');
  const t=qs('#expenseType').value;
  const n=(qs('#expenseNote').value||'').trim();
  const bType=qs('#expenseBenefType').value||''; const bName=(qs('#expenseBenefName').value||'').trim();
  if(!desc||!a){alert('Ø£Ø¯Ø®Ù„ ÙˆØµÙ ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­');return}
  const d=getStoreData();
  const exp={id:uid(),date:today(),type:t,desc,amount:a,note:n,benefType:bType||null,benefName:bName||null};
  d.expenses.push(exp); saveStoreData(d);
  if(bType && bName){ if(bType==='supplier') _deductSupplier(bName,a,`Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡ Ù…Ù† ${t}`); if(bType==='loan') _deductLoan(bName,a,`Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡ Ù…Ù† ${t}`); }
  qs('#expenseDesc').value=''; qs('#expenseAmount').value=''; qs('#expenseNote').value=''; qs('#expenseBenefType').value=''; qs('#expenseBenefName').value='';
  renderLists();
}
function deleteExpense(id){
  const d=getStoreData(); const i=d.expenses.findIndex(x=>x.id===id); if(i===-1)return;
  const exp=d.expenses[i];
  if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ'))return;
  if (exp.benefType && exp.benefName && exp.amount){
    if (exp.benefType==='supplier') _undeductSupplier(exp.benefName, Number(exp.amount),'Ø¥Ù„ØºØ§Ø¡ Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡');
    if (exp.benefType==='loan')     _undeductLoan(exp.benefName, Number(exp.amount),'Ø¥Ù„ØºØ§Ø¡ Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡');
  }
  d.expenses.splice(i,1); saveStoreData(d); renderLists();
}
function renderLists(){
  const d=getStoreData();
  const rs=d.sales.slice(-30).reverse(), re=d.expenses.slice(-30).reverse();
  qs('#recentSales').innerHTML=rs.length?rs.map(v=>`<div class="item"><div class="meta">${v.date} â€” <span class="tag">${v.type}</span> ${v.note?('â€” <i>'+v.note+'</i>'):''}</div><div><b>${v.amount}</b></div><div><button class="btn btn-danger" onclick="deleteSale('${v.id}')">Ø­Ø°Ù</button></div></div>`).join(''):'<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯</div>';
  qs('#recentExpenses').innerHTML=re.length?re.map(v=>{
    const link=(v.benefType&&v.benefName)?` â€” <b>${v.benefType==='supplier'?'Ø³Ø¯Ø§Ø¯ ØªØ§Ø¬Ø±':'Ø³Ø¯Ø§Ø¯ Ù…Ø³Ù„Ù'} (${v.benefName})</b>`:'';
    return `<div class="item"><div class="meta">${v.date} â€” <span class="tag">${v.type}</span> â€” ${v.desc}${link} ${v.note?('â€” <i>'+v.note+'</i>'):''}</div><div><b>${v.amount}</b></div><div><button class="btn btn-danger" onclick="deleteExpense('${v.id}')">Ø­Ø°Ù</button></div></div>`;
  }).join(''):'<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ø¨Ø¹Ø¯</div>';
  refillLists();
}

/* ===== ØªÙ‚Ø§Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ/ÙØªØ±Ø© ===== */
function totalsByType(rows){return {cs:rows.filter(x=>x.type==='ÙƒØ§Ø´').reduce((a,b)=>a+Number(b.amount||0),0), bs:rows.filter(x=>x.type==='Ø¨Ù†Ùƒ').reduce((a,b)=>a+Number(b.amount||0),0)}}
function fmtDate(iso){const d=new Date(iso+"T00:00:00");const days=["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];const pad=n=>String(n).padStart(2,"0");return `${days[d.getDay()]} ${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}
function generateDaily(){
  const date=qs('#r_date').value||today(), st=qs('#r_store').value||currentStore; const d=getStoreData(st);
  const s=d.sales.filter(x=>x.date===date), e=d.expenses.filter(x=>x.date===date);
  const ts=totalsByType(s), te=totalsByType(e);
  const netCash=ts.cs-te.cs, netBank=ts.bs-te.bs;
  const salesRows=s.map(x=>`<tr><td>${x.date}</td><td>${x.type}</td><td>${x.amount}</td><td>${x.note||''}</td></tr>`).join('')||'<tr><td colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª</td></tr>';
  const expRows=e.map(x=>`<tr><td>${x.date}</td><td>${x.type}</td><td>${x.desc}</td><td>${x.amount}</td><td>${(x.benefType&&x.benefName)?(x.benefType==='supplier'?'ØªØ§Ø¬Ø±: ':'Ù…Ø³Ù„Ù: ')+x.benefName:(x.note||'')}</td></tr>`).join('')||'<tr><td colspan="5">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ</td></tr>';
  qs('#dailyWrap').innerHTML=`<div class="page"><h2 class="section">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ â€” ${stores[st]}</h2><div class="hint">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: <b>${fmtDate(date)}</b></div><div class="separator"></div><div class="kpi"><div class="box"><b>${ts.cs}</b>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</div><div class="box"><b>${ts.bs}</b>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</div><div class="box"><b>${te.cs}</b>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</div><div class="box"><b>${te.bs}</b>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</div></div><h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead><tbody>${salesRows}</tbody></table><h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª/Ø±Ø¨Ø·</th></tr></thead><tbody>${expRows}</tbody></table><div style="margin-top:16px;"><b>Ø§Ù„ØµØ§ÙÙŠ ÙƒØ§Ø´:</b> ${netCash} â€” <b>Ø§Ù„ØµØ§ÙÙŠ Ø¨Ù†Ùƒ:</b> ${netBank}</div><div style="margin-top:36px;display:flex;justify-content:space-between"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ _________</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: _________</div></div></div>`;
}
function generateRange(){
  const from=qs('#f_from').value||today().slice(0,8)+'01', to=qs('#f_to').value||today(), mode=qs('#f_mode').value||'per';
  const shops=Object.keys(stores);
  if(mode==='all'){
    let sales=[],exp=[]; shops.forEach(st=>{const d=getStoreData(st); sales=sales.concat(d.sales.filter(x=>inR(x.date,from,to))); exp=exp.concat(d.expenses.filter(x=>inR(x.date,from,to)));});
    const ts=totalsByType(sales), te=totalsByType(exp); const netCash=ts.cs-te.cs, netBank=ts.bs-te.bs;
    qs('#rangeWrap').innerHTML=`<div class="page"><h2 class="section">ØªÙ‚Ø±ÙŠØ± Ù…Ø¬Ù…Ù‘Ø¹ â€” ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª</h2><div class="hint">Ø§Ù„ÙØªØ±Ø©: <b>${from}</b> â†’ <b>${to}</b></div><div class="separator"></div><table><thead><tr><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead><tbody><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</td><td>${ts.cs}</td></tr><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</td><td>${ts.bs}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</td><td>${te.cs}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</td><td>${te.bs}</td></tr><tr><td><b>Ø§Ù„ØµØ§ÙÙŠ ÙƒØ§Ø´</b></td><td><b>${netCash}</b></td></tr><tr><td><b>Ø§Ù„ØµØ§ÙÙŠ Ø¨Ù†Ùƒ</b></td><td><b>${netBank}</b></td></tr></tbody></table><div style="margin-top:36px;display:flex;justify-content:space-between"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ _________</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: _________</div></div></div>`;
  }else{
    let html=''; shops.forEach(st=>{const d=getStoreData(st); const s=d.sales.filter(x=>inR(x.date,from,to)), e=d.expenses.filter(x=>inR(x.date,from,to)); const ts=totalsByType(s), te=totalsByType(e); const netCash=ts.cs-te.cs, netBank=ts.bs-te.bs;
      html+=`<div class="page"><h2 class="section">ØªÙ‚Ø±ÙŠØ± ÙØªØ±Ø© â€” ${stores[st]}</h2><div class="hint">Ø§Ù„ÙØªØ±Ø©: <b>${from}</b> â†’ <b>${to}</b></div><div class="separator"></div><table><thead><tr><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead><tbody><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</td><td>${ts.cs}</td></tr><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</td><td>${ts.bs}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</td><td>${te.cs}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</td><td>${te.bs}</td></tr><tr><td><b>Ø§Ù„ØµØ§ÙÙŠ ÙƒØ§Ø´</b></td><td><b>${netCash}</b></td></tr><tr><td><b>Ø§Ù„ØµØ§ÙÙŠ Ø¨Ù†Ùƒ</b></td><td><b>${netBank}</b></td></tr></tbody></table><div style="margin-top:36px;display:flex;justify-content:space-between"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ _________</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: _________</div></div></div>`;
    }); qs('#rangeWrap').innerHTML=html;
  }
}

/* ===== ØªØ³ÙˆÙŠØ© ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ ===== */
function updateOwnerBalanceUI(){
  const O=getOwner(); const ins=sum(O.ledger,x=>x.type==='in'?Number(x.amount||0):0), outs=sum(O.ledger,x=>x.type==='out'?Number(x.amount||0):0);
  qs('#ownerBalanceVal').textContent=(ins-outs);
}
function settleDay(){
  const day=(qs('#todayInput').value||today()), d=getStoreData();
  const cashSales=d.sales.filter(x=>x.date===day && x.type==='ÙƒØ§Ø´').reduce((a,b)=>a+Number(b.amount||0),0);
  const cashExp  =d.expenses.filter(x=>x.date===day && x.type==='ÙƒØ§Ø´').reduce((a,b)=>a+Number(b.amount||0),0);
  const net=cashSales-cashExp; const O=getOwner();
  // Ø§Ø­Ø°Ù Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… ÙˆÙ„Ù†ÙØ³ Ø§Ù„Ù…Ø­Ù„
  for(let i=O.ledger.length-1;i>=0;i--){const e=O.ledger[i]; if(e.date===day && e.type==='in' && e.tag==='settle' && e.store===currentStore){O.ledger.splice(i,1)}}
  if(net>0){O.ledger.push({id:uid(),date:day,type:'in',amount:+net,note:`ØªØ±Ø­ÙŠÙ„ ÙƒØ§Ø´ Ø§Ù„ÙŠÙˆÙ… Ù…Ù† ${stores[currentStore]} (Ù…Ø¨ÙŠØ¹Ø§Øª-Ù…ØµØ±ÙˆÙØ§Øª)`,tag:'settle',store:currentStore});}
  saveOwner(O); updateOwnerBalanceUI();
}
function previewAllStores(){
  const day=(qs('#todayInput').value||today()); const shops=Object.keys(stores);
  const rows=shops.map(st=>{const d=getStoreData(st);
    const s=d.sales.filter(x=>x.date===day), e=d.expenses.filter(x=>x.date===day);
    const ts=totalsByType(s), te=totalsByType(e); return {st,cs:ts.cs,bs:ts.bs,ce:te.cs,be:te.bs};
  });
  const html=`<div class="page"><h2 class="section">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙŠÙˆÙ… â€” ${day}</h2>
  <table><thead><tr><th>Ø§Ù„Ù…Ø­Ù„</th><th>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</th><th>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</th><th>ØµØ§ÙÙŠ ÙƒØ§Ø´</th><th>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</th><th>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</th><th>ØµØ§ÙÙŠ Ø¨Ù†Ùƒ</th></tr></thead><tbody>
  ${rows.map(r=>`<tr><td>${stores[r.st]}</td><td>${r.cs}</td><td>${r.ce}</td><td><b>${r.cs-r.ce}</b></td><td>${r.bs}</td><td>${r.be}</td><td><b>${r.bs-r.be}</b></td></tr>`).join('')}
  </tbody></table></div>`;
  alert('ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£Ø³ÙÙ„ ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„Ù…Ø§Ù„Ùƒ â†’ ØªÙ‚Ø±ÙŠØ± Ù…Ø¬Ù…Ù‘Ø¹"'); qs('#ownerAggWrap').innerHTML=html;
}
function settleAllStores(){
  const day=(qs('#todayInput').value||today()); const shops=Object.keys(stores); const O=getOwner();
  // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ØªØ³ÙˆÙŠØ© Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„ÙŠÙˆÙ… Ù„ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª
  for(let i=O.ledger.length-1;i>=0;i--){const e=O.ledger[i]; if(e.date===day && e.type==='in' && e.tag==='settle'){O.ledger.splice(i,1)}}
  let noteParts=[];
  shops.forEach(st=>{
    const d=getStoreData(st);
    const s=d.sales.filter(x=>x.date===day), e=d.expenses.filter(x=>x.date===day);
    const ts=totalsByType(s), te=totalsByType(e);
    const netCash=ts.cs-te.cs; // Ø§Ù„Ù…Ø¬Ù…Ù‘Ø¹ ÙŠØ±Ø­Ù‘Ù„ Ø§Ù„ÙƒØ§Ø´ ÙÙ‚Ø·
    noteParts.push(`${stores[st]} Ùƒ:${ts.cs}âˆ’${te.cs}=${netCash} | Ø¨:${ts.bs}âˆ’${te.bs}=${ts.bs-te.bs}`);
    if(netCash>0){O.ledger.push({id:uid(),date:day,type:'in',amount:+netCash,note:`ØªØ­ØµÙŠÙ„ ÙƒØ§Ø´ ÙŠÙˆÙ… ${day} Ù…Ù† ${stores[st]}`,tag:'settle',store:st});}
  });
  saveOwner(O); updateOwnerBalanceUI();
  alert('ØªÙ…Øª Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ù…Ø¬Ù…Ù‘Ø¹Ø©. ØªÙØ§ØµÙŠÙ„:\n'+noteParts.join('\n'));
}

/* ===== ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ: ØªÙ‚Ø§Ø±ÙŠØ±/ÙƒØ´Ù/Ø³Ø­Ø¨ ===== */
function renderOwnerAggregate(){
  const from=(qs('#of_from').value||today().slice(0,8)+'01'), to=(qs('#of_to').value||today()); const shops=Object.keys(stores);
  let rows=shops.map(st=>{const d=getStoreData(st);
    const s=d.sales.filter(x=>inR(x.date,from,to)), e=d.expenses.filter(x=>inR(x.date,from,to));
    const ts=totalsByType(s), te=totalsByType(e); return {st,cs:ts.cs,bs:ts.bs,ce:te.cs,be:te.bs};
  });
  const totals=rows.reduce((acc,r)=>({cs:acc.cs+r.cs, bs:acc.bs+r.bs, ce:acc.ce+r.ce, be:acc.be+r.be}),{cs:0,bs:0,ce:0,be:0});
  const netCash=totals.cs-totals.ce, netBank=totals.bs-totals.be;
  const html=`<div class="page"><h2 class="section">ØªÙ‚Ø±ÙŠØ± Ù…Ø¬Ù…Ù‘Ø¹ â€” ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª</h2>
  <div class="hint">Ø§Ù„ÙØªØ±Ø©: <b>${from}</b> â†’ <b>${to}</b></div>
  <table><thead><tr><th>Ø§Ù„Ù…Ø­Ù„</th><th>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</th><th>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</th><th>ØµØ§ÙÙŠ ÙƒØ§Ø´</th><th>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</th><th>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</th><th>ØµØ§ÙÙŠ Ø¨Ù†Ùƒ</th></tr></thead><tbody>
  ${rows.map(r=>`<tr><td>${stores[r.st]}</td><td>${r.cs}</td><td>${r.ce}</td><td><b>${r.cs-r.ce}</b></td><td>${r.bs}</td><td>${r.be}</td><td><b>${r.bs-r.be}</b></td></tr>`).join('')}
  </tbody></table>
  <div style="margin-top:10px"><b>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ â€” ØµØ§ÙÙŠ ÙƒØ§Ø´:</b> ${netCash} â€” <b>ØµØ§ÙÙŠ Ø¨Ù†Ùƒ:</b> ${netBank}</div>
  <div style="margin-top:36px;display:flex;justify-content:space-between"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ _________</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: _________</div></div>
  </div>`;
  qs('#ownerAggWrap').innerHTML=html;
}
function renderOwnerStatement(){
  const from=(qs('#ox_from').value||today().slice(0,8)+'01'), to=(qs('#ox_to').value||today()); const O=getOwner();
  const rows=(O.ledger||[]).filter(x=>inR(x.date,from,to)).slice().reverse();
  const ins=sum(rows,x=>x.type==='in'?Number(x.amount||0):0), outs=sum(rows,x=>x.type==='out'?Number(x.amount||0):0);
  const tbl=rows.length?rows.map(e=>`<tr><td>${e.date}</td><td>${e.type==='in'?'ØªØ­ØµÙŠÙ„':'ØµØ±Ù'}</td><td>${e.amount}</td><td>${e.note||''}</td><td>${e.store?stores[e.store]:''}</td><td><button class="btn btn-danger" onclick="deleteOwnerEntry('${e.id}')">Ø­Ø°Ù</button></td></tr>`).join(''):`<tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª</td></tr>`;
  qs('#ownerWrap').innerHTML=`<div class="page"><h2 class="section">ÙƒØ´Ù ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</h2><div class="hint">Ø§Ù„ÙØªØ±Ø©: <b>${from}</b> â†’ <b>${to}</b></div><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ø§Ù„Ù…Ø­Ù„</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>${tbl}</tbody></table><div style="margin-top:8px"><b>ØªØ­ØµÙŠÙ„:</b> ${ins} â€” <b>ØµØ±Ù:</b> ${outs} â€” <b>Ø§Ù„Ø±ØµÙŠØ¯:</b> ${ins-outs}</div></div>`;
  updateOwnerBalanceUI();
}
function deleteOwnerEntry(id){
  const O=getOwner(); const i=O.ledger.findIndex(x=>x.id===id); if(i===-1)return;
  const rec=O.ledger[i];
  if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚ÙŠØ¯ Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„ÙƒØŸ'))return;
  // Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ¯ Ù…Ø±ØªØ¨Ø· Ø¨Ø³Ø¯Ø§Ø¯ ØªØ§Ø¬Ø±/Ù…Ø³Ù„Ù Ù…Ù† Ø§Ù„Ù…Ø§Ù„ÙƒØŒ Ø£Ø±Ø¬Ø¹ Ø£Ø«Ø±Ù‡
  if(rec.link && rec.link.type==='supplier'){ const S=getSuppliers(); const nm=rec.link.name, amt=Number(rec.amount||0); if(S.people&&S.people[nm]){ S.people[nm].balance += amt; S.people[nm].history.push({id:uid(),date:today(),type:'revert',amount:amt,note:'Ø¥Ù„ØºØ§Ø¡ Ø³Ø¯Ø§Ø¯ Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ'}); saveSuppliers(S);} }
  if(rec.link && rec.link.type==='loan'){ const L=getLoans(); const nm=rec.link.name, amt=Number(rec.amount||0); if(L.people&&L.people[nm]){ L.people[nm].balance += amt; L.people[nm].history.push({id:uid(),date:today(),type:'revert',amount:amt,note:'Ø¥Ù„ØºØ§Ø¡ Ø³Ø¯Ø§Ø¯ Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ'}); saveLoans(L);} }
  O.ledger.splice(i,1); saveOwner(O); renderOwnerStatement(); updateOwnerBalanceUI();
}
function ownerPayOut(){
  const name=(qs('#ownerPayName').value||'').trim(), typ=qs('#ownerPayType').value, amt=parseFloat(qs('#ownerPayAmt').value||'0');
  if(!name||!amt){alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ø¨Ù„Øº');return}
  const O=getOwner(); O.ledger.push({id:uid(),date:today(),type:'out',amount:amt,note:(typ==='supplier'?`Ø³Ø¯Ø§Ø¯ ØªØ§Ø¬Ø± (${name})`:`Ø³Ø¯Ø§Ø¯ Ù…Ø³Ù„Ù (${name})`),link:{type:typ,name}});
  saveOwner(O);
  if(typ==='supplier'){ const S=getSuppliers(); if(!S.people) S.people={}; if(!S.people[name]) S.people[name]={balance:0,history:[]}; S.people[name].balance -= amt; S.people[name].history.push({id:uid(),date:today(),type:'pay',amount:amt,note:'Ø¯ÙØ¹Ø© Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ',source:'owner'}); saveSuppliers(S); renderSuppliers(); }
  else { const L=getLoans(); if(!L.people) L.people={}; if(!L.people[name]) L.people[name]={balance:0,history:[]}; L.people[name].balance -= amt; L.people[name].history.push({id:uid(),date:today(),type:'out',amount:amt,note:'Ø³Ø¯Ø§Ø¯ Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ',source:'owner'}); saveLoans(L); renderLoans(); }
  qs('#ownerPayName').value=''; qs('#ownerPayAmt').value=''; renderOwnerStatement(); updateOwnerBalanceUI();
}

/* ===== Ø³ÙÙ„Ù ===== */
function renderLoans(){
  const L=getLoans(), ns=Object.keys(L.people||{});
  if(!ns.length){qs('#loansWrap').innerHTML='<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù„Ù</div>';refillLists();return}
  const rows=ns.map(n=>`<tr><td>${n}</td><td>${L.people[n].balance||0}</td><td><button class="btn btn-danger" onclick="deleteLoanPerson('${n.replace(/'/g,"\\'")}')">ğŸ—‘ Ø­Ø°Ù</button></td></tr>`).join('');
  const tx=[]; ns.forEach(n=>{(L.people[n].history||[]).slice(-100).forEach(h=>tx.push({name:n,...h}))}); tx.sort((a,b)=>(a.date||'').localeCompare(b.date||'')).reverse();
  const txRows=tx.length?tx.map(h=>`<tr><td>${h.date||''}</td><td>${h.name}</td><td>${h.type==='in'?'Ø³Ù„ÙØ© (+)':(h.type==='out'?'Ø³Ø¯Ø§Ø¯ (âˆ’)':(h.type==='revert'?'Ø¥Ù„ØºØ§Ø¡':''))}</td><td>${h.amount||0}</td><td>${h.note||''}</td></tr>`).join(''):`<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª</td></tr>`;
  qs('#loansWrap').innerHTML=`<h4>Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…Ø³Ù„ÙÙŠÙ†</h4><table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>${rows}</tbody></table><h4 style="margin-top:10px">ØªÙØ§ØµÙŠÙ„ Ø¢Ø®Ø± Ø§Ù„Ø­Ø±ÙƒØ§Øª</h4><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead><tbody>${txRows}</tbody></table>`;
  refillLists();
}
function addLoan(){
  const name=(qs('#loanPerson').value||'').trim(), amt=parseFloat(qs('#loanAmount').value||'0');
  if(!name||!amt){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­');return}
  const L=getLoans(); if(!L.people) L.people={}; if(!L.people[name]) L.people[name]={balance:0,history:[]};
  L.people[name].balance += amt; L.people[name].history.push({id:uid(),date:today(),type:'in',amount:amt,note:'Ø³Ù„ÙØ© Ù„Ù„Ù…Ø­Ù„'});
  saveLoans(L);
  // ØªØ²ÙŠØ¯ ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ ÙˆØªØ¸Ù‡Ø± ÙƒØªØ¯ÙˆÙŠÙ†Ø© ÙÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
  const d=getStoreData(); d.sales.push({id:uid(),date:today(),type:'ÙƒØ§Ø´',amount:amt,note:`Ø³Ù„ÙØ© Ù…Ù† (${name}) â€” ØºÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª`}); saveStoreData(d);
  qs('#loanPerson').value=''; qs('#loanAmount').value=''; renderLoans(); renderLists();
}
function payLoan(){
  const name=(qs('#loanPayPerson').value||'').trim(), amt=parseFloat(qs('#loanPayAmount').value||'0'), src=qs('#loanPaySource').value;
  if(!name||!amt){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­');return}
  const L=getLoans(); if(!L.people||!L.people[name]){alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ù„Ù');return}
  L.people[name].balance -= amt; L.people[name].history.push({id:uid(),date:today(),type:'out',amount:amt,note:`Ø³Ø¯Ø§Ø¯ Ù…Ù† ${src==='store'?'ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„':'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ'}`,source:src});
  saveLoans(L);
  if(src==='store'){ const d=getStoreData(); d.expenses.push({id:uid(),date:today(),type:'ÙƒØ§Ø´',desc:`Ø³Ø¯Ø§Ø¯ Ø³Ù„ÙØ© (${name})`,amount:amt,note:'Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„',benefType:'loan',benefName:name}); saveStoreData(d); renderLists(); }
  else { const O=getOwner(); O.ledger.push({id:uid(),date:today(),type:'out',amount:amt,note:`Ø³Ø¯Ø§Ø¯ Ø³Ù„ÙØ© (${name})`,link:{type:'loan',name}}); saveOwner(O); updateOwnerBalanceUI(); }
  qs('#loanPayPerson').value=''; qs('#loanPayAmount').value=''; renderLoans(); renderOwnerStatement();
}
function deleteLoanPerson(name){
  if(!confirm(`Ø­Ø°Ù Ø§Ù„Ù…Ø³Ù„Ù "${name}" ÙˆØ¬Ù…ÙŠØ¹ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙ‡ØŸ`))return;
  const L=getLoans(); if(L.people&&L.people[name]){ delete L.people[name]; saveLoans(L); renderLoans(); refillLists(); }
}

/* ===== ØªØ¬Ø§Ø± ===== */
function renderSuppliers(){
  const S=getSuppliers(), ns=Object.keys(S.people||{});
  if(!ns.length){qs('#supWrap').innerHTML='<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ø§Ø±</div>';refillLists();return}
  const rows=ns.map(n=>`<tr><td>${n}</td><td>${S.people[n].balance||0}</td><td><button class="btn btn-danger" onclick="deleteSupplierPerson('${n.replace(/'/g,"\\'")}')">ğŸ—‘ Ø­Ø°Ù</button></td></tr>`).join('');
  const tx=[]; ns.forEach(n=>{(S.people[n].history||[]).slice(-100).forEach(h=>tx.push({name:n,...h}))}); tx.sort((a,b)=>(a.date||'').localeCompare(b.date||'')).reverse();
  const txRows=tx.length?tx.map(h=>`<tr><td>${h.date||''}</td><td>${h.name}</td><td>${h.type==='invoice'?'ÙØ§ØªÙˆØ±Ø© (+)':(h.type==='pay'?'Ø¯ÙØ¹Ø© (âˆ’)':(h.type==='revert'?'Ø¥Ù„ØºØ§Ø¡':''))}</td><td>${h.amount||0}</td><td>${h.note||''}</td></tr>`).join(''):`<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª</td></tr>`;
  qs('#supWrap').innerHTML=`<h4>Ø£Ø±ØµØ¯Ø© Ø§Ù„ØªØ¬Ø§Ø±</h4><table><thead><tr><th>Ø§Ù„ØªØ§Ø¬Ø±</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>${rows}</tbody></table><h4 style="margin-top:10px">ØªÙØ§ØµÙŠÙ„ Ø¢Ø®Ø± Ø§Ù„Ø­Ø±ÙƒØ§Øª</h4><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead><tbody>${txRows}</tbody></table>`;
  refillLists();
}
function addSupplierInvoice(){
  const name=(qs('#supName').value||'').trim(), amt=parseFloat(qs('#supInvoice').value||'0');
  if(!name||!amt){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙ‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø©');return}
  const S=getSuppliers(); if(!S.people) S.people={}; if(!S.people[name]) S.people[name]={balance:0,history:[]};
  S.people[name].balance += amt; S.people[name].history.push({id:uid(),date:today(),type:'invoice',amount:amt,note:'ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª'}); saveSuppliers(S);
  qs('#supName').value=''; qs('#supInvoice').value=''; renderSuppliers();
}
function paySupplier(){
  const name=(qs('#supPayName').value||'').trim(), amt=parseFloat(qs('#supPayAmount').value||'0'), src=qs('#supPaySource').value;
  if(!name||!amt){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­');return}
  const S=getSuppliers(); if(!S.people||!S.people[name]){alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø±');return}
  S.people[name].balance -= amt; S.people[name].history.push({id:uid(),date:today(),type:'pay',amount:amt,note:`Ø¯ÙØ¹Ø© Ù…Ù† ${src==='store'?'ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„':(src==='owner'?'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ':'Ø§Ù„Ø¨Ù†Ùƒ')}`,source:src});
  saveSuppliers(S);
  if(src==='store'){ const d=getStoreData(); d.expenses.push({id:uid(),date:today(),type:'ÙƒØ§Ø´',desc:`Ø¯ÙØ¹Ø© ØªØ§Ø¬Ø± (${name})`,amount:amt,note:'Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„',benefType:'supplier',benefName:name}); saveStoreData(d); renderLists(); }
  else if(src==='owner'){ const O=getOwner(); O.ledger.push({id:uid(),date:today(),type:'out',amount:amt,note:`Ø¯ÙØ¹Ø© ØªØ§Ø¬Ø± (${name})`,link:{type:'supplier',name}}); saveOwner(O); updateOwnerBalanceUI(); }
  else { const d=getStoreData(); d.expenses.push({id:uid(),date:today(),type:'Ø¨Ù†Ùƒ',desc:`Ø¯ÙØ¹Ø© ØªØ§Ø¬Ø± (${name})`,amount:amt,note:'Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ',benefType:'supplier',benefName:name}); saveStoreData(d); renderLists(); }
  qs('#supPayName').value=''; qs('#supPayAmount').value=''; renderSuppliers(); renderOwnerStatement();
}
function deleteSupplierPerson(name){
  if(!confirm(`Ø­Ø°Ù Ø§Ù„ØªØ§Ø¬Ø± "${name}" ÙˆØ¬Ù…ÙŠØ¹ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙ‡ØŸ`))return;
  const S=getSuppliers(); if(S.people&&S.people[name]){ delete S.people[name]; saveSuppliers(S); renderSuppliers(); refillLists(); }
}

/* ===== Ø§Ù„Ø¯ÙŠÙˆÙ† ===== */
function renderDebts(){
  const D=getDebts(), ns=Object.keys(D.people||{});
  if(!ns.length){qs("#debtsWrap").innerHTML='<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ†</div>'; refillLists(); return;}
  const rows=ns.map(n=>`<tr><td>${n}</td><td>${D.people[n].balance||0}</td><td><button class="btn btn-danger" onclick="delDebtor('${n.replace(/\'/g,"\\'")}')">ğŸ—‘ Ø­Ø°Ù</button></td></tr>`).join('');
  const tx=[]; ns.forEach(n=>{(D.people[n].history||[]).slice(-120).forEach(h=>tx.push({name:n,...h}))}); tx.sort((a,b)=>(a.date||'').localeCompare(b.date||'')).reverse();
  const txRows=tx.length?tx.map(h=>`<tr><td>${h.date||''}</td><td>${h.name}</td><td>${h.type==='debt'?'Ø¯ÙŠÙ† (+)':(h.type==='pay'?'Ø³Ø¯Ø§Ø¯ (âˆ’)':(h.type==='revert'?'Ø¥Ù„ØºØ§Ø¡':''))}</td><td>${h.amount||0}</td><td>${h.note||''}</td></tr>`).join(''):`<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª</td></tr>`;
  qs('#debtsWrap').innerHTML=`<h4>Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†ÙŠÙ†</h4><table><thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>${rows}</tbody></table><h4 style="margin-top:10px">ØªÙØ§ØµÙŠÙ„ Ø¢Ø®Ø± Ø§Ù„Ø­Ø±ÙƒØ§Øª</h4><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead><tbody>${txRows}</tbody></table>`;
  refillLists();
}
function addDebt(){
  const name=(qs('#debtName').value||'').trim(), amt=parseFloat(qs('#debtAmt').value||'0'), note=(qs('#debtNote').value||'').trim();
  if(!name||!amt){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­');return}
  const D=getDebts(); if(!D.people) D.people={}; if(!D.people[name]) D.people[name]={balance:0,history:[]};
  D.people[name].balance += amt; D.people[name].history.push({id:uid(),date:today(),type:'debt',amount:amt,note:note}); saveDebts(D);
  // ØªÙØ³Ø¬Ù„ ÙƒØ¨ÙŠØ¹ (Ø­Ø³Ø¨ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯ØŸ Ø§Ù„Ø¯ÙŠÙ† Ø¹Ø§Ø¯Ø©Ù‹ Ø¢Ø¬Ù„ØŒ Ù„Ø§ ÙŠØ²ÙŠØ¯ Ø§Ù„Ø¨Ù†Ùƒ/Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø¢Ù†) â€” Ù†ØªØ±ÙƒÙ‡Ø§ ÙƒØ¯ÙŠÙ† ÙÙ‚Ø·
  qs('#debtName').value=''; qs('#debtAmt').value=''; qs('#debtNote').value=''; renderDebts();
}
function payDebt(){
  const name=(qs('#debtPayName').value||'').trim(), amt=parseFloat(qs('#debtPayAmt').value||'0'), method=qs('#debtMethod').value;
  if(!name||!amt){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­');return}
  const D=getDebts(); if(!D.people||!D.people[name]){alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„');return}
  D.people[name].balance -= amt; D.people[name].history.push({id:uid(),date:today(),type:'pay',amount:amt,note:`Ø³Ø¯Ø§Ø¯ ${method}`}); saveDebts(D);
  // Ø¯Ø®Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (ÙƒØ§Ø´/Ø¨Ù†Ùƒ) â€” Ù„Ø£Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø³Ø¯Ù‘Ø¯ Ø§Ù„Ø¢Ù†
  const d=getStoreData(); d.sales.push({id:uid(),date:today(),type:(method==='ÙƒØ§Ø´'?'ÙƒØ§Ø´':'Ø¨Ù†Ùƒ'),amount:amt,note:`Ø³Ø¯Ø§Ø¯ Ø¯ÙŠÙ† Ù…Ù† (${name})`}); saveStoreData(d); renderLists();
  qs('#debtPayName').value=''; qs('#debtPayAmt').value=''; renderDebts();
}
function delDebtor(name){
  if(!confirm(`Ø­Ø°Ù Ø§Ù„Ù…Ø¯ÙŠÙ† "${name}" ÙˆØ¬Ù…ÙŠØ¹ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙ‡ØŸ`))return;
  const D=getDebts(); if(D.people&&D.people[name]){ delete D.people[name]; saveDebts(D); renderDebts(); refillLists(); }
}
function renderDebtStmt(){
  const name=(qs("#debtStmtName").value||"").trim();
  const from=qs("#debtFrom").value||today().slice(0,8)+"01";
  const to  =qs("#debtTo").value||today();
  const D=getDebts();
  if(!name||!D.people||!D.people[name]){qs("#debtStmtWrap").innerHTML='<div class="hint">Ø§Ø®ØªØ± Ø§Ø³Ù… Ø¹Ù…ÙŠÙ„ ØµØ­ÙŠØ­.</div>';return}
  const hist=(D.people[name].history||[]).filter(x=>inR(x.date,from,to));
  const rows=hist.length?hist.map(x=>`<tr><td>${x.date||''}</td><td>${x.type==='debt'?'Ø¯ÙŠÙ† (+)':(x.type==='pay'?'Ø³Ø¯Ø§Ø¯ (âˆ’)':'Ø¥Ù„ØºØ§Ø¡')}</td><td>${x.amount||0}</td><td>${x.note||''}</td></tr>`).join(''):`<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª</td></tr>`;
  qs("#debtStmtWrap").innerHTML=`<div class="page"><h3 class="section">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ â€” Ø¹Ù…ÙŠÙ„: ${name}</h3><div class="hint">Ø§Ù„ÙØªØ±Ø©: <b>${from}</b> â†’ <b>${to}</b></div><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead><tbody>${rows}</tbody></table><div style="margin-top:8px"><b>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</b> ${(D.people[name].balance||0)}</div><div style="margin-top:26px;display:flex;justify-content:space-between"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ _________</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: _________</div></div></div>`;
}

/* ===== Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ===== */
function exportBackup(){
  const payload={version:"final-integrated-agg-owner",at:new Date().toISOString(),
    stores:{store1:getStoreData('store1'),store2:getStoreData('store2'),store3:getStoreData('store3')},
    loans:getLoans(),suppliers:getSuppliers(),debts:getDebts(),owner_fund:getOwner()};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a=document.createElement("a"); const ts=new Date(); const pad=n=>String(n).padStart(2,'0');
  a.href=URL.createObjectURL(blob); a.download=`backup-${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}-${pad(ts.getHours())}${pad(ts.getMinutes())}.json`;
  document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
}
function importBackup(file){
  if(!file){alert("Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©");return}
  const r=new FileReader();
  r.onload=e=>{try{
    const data=JSON.parse(e.target.result);
    localStorage.setItem('store1',JSON.stringify(data.stores?.store1||{"sales":[],"expenses":[]}));
    localStorage.setItem('store2',JSON.stringify(data.stores?.store2||{"sales":[],"expenses":[]}));
    localStorage.setItem('store3',JSON.stringify(data.stores?.store3||{"sales":[],"expenses":[]}));
    localStorage.setItem('owner_fund',JSON.stringify(data.owner_fund||{"ledger":[]}));
    localStorage.setItem('loans',JSON.stringify(data.loans||{"people":{}}));
    localStorage.setItem('suppliers',JSON.stringify(data.suppliers||{"people":{}}));
    localStorage.setItem('debts',JSON.stringify(data.debts||{"people":{}}));
    renderLists(); renderLoans(); renderSuppliers(); renderDebts(); renderOwnerStatement(); renderOwnerAggregate(); updateOwnerBalanceUI(); refillLists();
  }catch(err){alert("ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: "+err.message)}};
  r.readAsText(file);
}

/* ===== ØªÙ‡ÙŠØ¦Ø© ===== */
document.addEventListener('DOMContentLoaded',()=>{
  const t=today();
  ['todayInput','r_date','of_from','f_from','ox_from','debtFrom','supFrom','loanFrom'].forEach(id=>{const x=qs('#'+id); if(x) x.value=t;});
  const x1=qs('#of_to'); if(x1) x1.value=t; const x2=qs('#f_to'); if(x2) x2.value=t; const x3=qs('#ox_to'); if(x3) x3.value=t;
  showTab('input'); renderLists(); renderLoans(); renderSuppliers(); renderDebts(); renderOwnerStatement(); renderOwnerAggregate(); updateOwnerBalanceUI(); refillLists();
});
</script>

<script>
/* Service Worker (ÙŠØªØ·Ù„Ø¨ Ù…Ù„Ù sw.js Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø¬Ø§Ù†Ø¨ index.html) */
if("serviceWorker" in navigator){
  window.addEventListener("load",()=>{
    navigator.serviceWorker.register("./sw.js")
      .then(()=>console.log("SWâœ…"))
      .catch(e=>console.error("SWâŒ",e));
  });
}
</script>
  <script>
/* ØªØµØ­ÙŠØ­ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ â€” Ù„Ø§ ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„ Ø£ÙŠ ÙƒÙˆØ¯ Ù‚Ø¯ÙŠÙ… */
(function(){
  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©-Ø§Ù„Ù‡Ù†Ø¯ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
  function normalizeNum(str){
    if(!str) return '';
    const ar = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
    return String(str)
      .replace(/[Ù -Ù©]/g, d => String(ar.indexOf(d)))
      .replace(/,/g,'')
      .replace(/\s+/g,'')
      .trim();
  }

  // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ (ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)
  window.addExpense = function(){
    const descInput = document.querySelector('#expenseDesc');
    const amtInput  = document.querySelector('#expenseAmount');
    const typeSel   = document.querySelector('#expenseType');
    const noteInput = document.querySelector('#expenseNote');
    const bTypeSel  = document.querySelector('#expenseBenefType');
    const bNameInp  = document.querySelector('#expenseBenefName');

    let desc = (descInput ? descInput.value : '').trim();
    const amtRaw = normalizeNum(amtInput ? amtInput.value : '0');
    const a = Number(amtRaw);
    const t = typeSel ? typeSel.value : 'ÙƒØ§Ø´';
    const n = (noteInput ? noteInput.value : '').trim();
    const bType = bTypeSel ? (bTypeSel.value || '') : '';
    const bName = (bNameInp ? bNameInp.value : '').trim();

    if(!(a > 0)){ alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }
    if(!desc) desc = 'Ù…ØµØ±ÙˆÙ Ø¨Ø¯ÙˆÙ† ÙˆØµÙ';

    // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£ØµÙ„Ø§Ù‹ ÙÙŠ Ù…Ù„ÙÙƒ
    const d = (typeof getStoreData === 'function') ? getStoreData() : {sales:[],expenses:[]};
    const exp = {
      id: (typeof uid==='function'? uid(): String(Date.now())),
      date: (typeof today==='function'? today(): new Date().toISOString().slice(0,10)),
      type: t, desc, amount: a, note: n,
      benefType: bType || null, benefName: bName || null
    };
    d.expenses = Array.isArray(d.expenses) ? d.expenses : [];
    d.expenses.push(exp);
    if(typeof saveStoreData === 'function') saveStoreData(d);

    // Ø±Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ØªØ§Ø¬Ø±/Ø§Ù„Ù…Ø³Ù„Ù Ø¥Ù† ÙˆÙØ¬Ø¯
    if (bType && bName){
      if (bType === 'supplier' && typeof _deductSupplier === 'function'){
        _deductSupplier(bName, a, `Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡ Ù…Ù† ${t}`);
      }
      if (bType === 'loan' && typeof _deductLoan === 'function'){
        _deductLoan(bName, a, `Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡ Ù…Ù† ${t}`);
      }
    }

    // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    if(descInput) descInput.value = '';
    if(amtInput)  amtInput.value  = '';
    if(noteInput) noteInput.value = '';
    if(bTypeSel)  bTypeSel.value  = '';
    if(bNameInp)  bNameInp.value  = '';
    if(typeof renderLists === 'function') renderLists();
  };

  // ØªØ£ÙƒÙŠØ¯ Ø±Ø¨Ø· Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ" Ø¨Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  const btn = document.getElementById('addExpenseBtn');
  if(btn){
    // Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù‚Ø¯Ø§Ù…Ù‰ (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†) Ø¨ÙˆØ¶Ø¹ Ø§Ø³Ù… Ù…Ø®ØªÙ„Ù Ù…Ø³ØªØ­ÙŠÙ„ Ù†Ø¹Ø±ÙÙ‡ØŸ Ø§Ù„Ø­Ù„: Ù†Ø¹ÙŠÙ‘Ù† Ù…Ù† Ø¬Ø¯ÙŠØ¯
    btn.onclick = null;
    btn.addEventListener('click', window.addExpense, { once: false });
  }
})();
</script>
 <script>
/* ØªØµØ­ÙŠØ­ Ø­ÙØ¸ Ø§Ù„ØªØ§Ø±ÙŠØ® + Ø¯Ø¹Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© â€” Ø¨Ø¯ÙˆÙ† Ù„Ù…Ø³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… */
(function () {
  // 1) ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©-Ø§Ù„Ù‡Ù†Ø¯ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
  function normalizeNum(str){
    if(!str) return '';
    const ar = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
    return String(str)
      .replace(/[Ù -Ù©]/g, d => String(ar.indexOf(d)))
      .replace(/,/g,'')
      .replace(/\s+/g,'')
      .trim();
  }

  // 2) Ø£Ø®Ø° Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¹Ù„ÙˆÙŠ (#todayInput)ØŒ ÙˆØ¥Ù„Ø§ Ø§Ù„ÙŠÙˆÙ…
  function formDay(){
    const el = document.querySelector('#todayInput');
    return (el && el.value) ? el.value : new Date().toISOString().slice(0,10);
  }

  // 3) Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø¢Ù…Ù†Ø©
  const qs = s => document.querySelector(s);

  // =========================
  // Ù…Ø¨ÙŠØ¹Ø§Øª
  // =========================
  window.addSale = function(){
    const amtRaw = normalizeNum(qs('#saleAmount')?.value || '0');
    const a      = Number(amtRaw);
    const t      = qs('#saleType')?.value || 'ÙƒØ§Ø´';
    const n      = (qs('#saleNote')?.value || '').trim();
    if(!(a>0)){ alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }

    const d = (typeof getStoreData==='function') ? getStoreData() : {sales:[],expenses:[]};
    d.sales = Array.isArray(d.sales) ? d.sales : [];
    d.sales.push({ id: (typeof uid==='function'? uid(): String(Date.now())),
                   date: formDay(), type: t, amount: a, note: n });
    if(typeof saveStoreData==='function') saveStoreData(d);

    if(qs('#saleAmount')) qs('#saleAmount').value='';
    if(qs('#saleNote'))   qs('#saleNote').value='';
    if(typeof renderLists==='function') renderLists();
  };

  // =========================
  // Ù…ØµØ§Ø±ÙŠÙ + Ø±Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠ (ØªØ§Ø¬Ø±/Ù…Ø³Ù„Ù)
  // =========================
  window.addExpense = function(){
    let desc = (qs('#expenseDesc')?.value || '').trim();
    const amtRaw = normalizeNum(qs('#expenseAmount')?.value || '0');
    const a      = Number(amtRaw);
    const t      = qs('#expenseType')?.value || 'ÙƒØ§Ø´';
    const n      = (qs('#expenseNote')?.value || '').trim();
    const bType  = qs('#expenseBenefType')?.value || '';
    const bName  = (qs('#expenseBenefName')?.value || '').trim();

    if(!(a>0)){ alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }
    if(!desc) desc = 'Ù…ØµØ±ÙˆÙ Ø¨Ø¯ÙˆÙ† ÙˆØµÙ';

    const d = (typeof getStoreData==='function') ? getStoreData() : {sales:[],expenses:[]};
    d.expenses = Array.isArray(d.expenses) ? d.expenses : [];
    const exp = { id: (typeof uid==='function'? uid(): String(Date.now())),
                  date: formDay(), type: t, desc, amount:a, note:n,
                  benefType: bType || null, benefName: bName || null };
    d.expenses.push(exp);
    if(typeof saveStoreData==='function') saveStoreData(d);

    // Ø±Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠ
    if (bType && bName){
      if (bType==='supplier' && typeof _deductSupplier==='function') _deductSupplier(bName, a, `Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡ Ù…Ù† ${t}`);
      if (bType==='loan'     && typeof _deductLoan    ==='function') _deductLoan(bName, a, `Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡ Ù…Ù† ${t}`);
    }

    if(qs('#expenseDesc')) qs('#expenseDesc').value='';
    if(qs('#expenseAmount')) qs('#expenseAmount').value='';
    if(qs('#expenseNote')) qs('#expenseNote').value='';
    if(qs('#expenseBenefType')) qs('#expenseBenefType').value='';
    if(qs('#expenseBenefName')) qs('#expenseBenefName').value='';
    if(typeof renderLists==='function') renderLists();
    if(typeof renderOwnerStatement==='function') renderOwnerStatement();
  };

  // =========================
  // Ø³ÙÙ„Ù
  // =========================
  window.addLoan = function(){
    const name = (qs('#loanPerson')?.value || '').trim();
    const amt  = Number(normalizeNum(qs('#loanAmount')?.value || '0'));
    if(!name || !(amt>0)){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }

    const L = (typeof getLoans==='function') ? getLoans() : {people:{}};
    if(!L.people) L.people = {};
    if(!L.people[name]) L.people[name] = { balance:0, history:[] };

    const id = (typeof uid==='function'? uid(): String(Date.now()));
    L.people[name].balance += amt;
    L.people[name].history.push({ id, date: formDay(), type:'in', amount: amt, note:'Ø³Ù„ÙØ© Ù„Ù„Ù…Ø­Ù„' });
    if(typeof saveLoans==='function') saveLoans(L);

    if(qs('#loanPerson')) qs('#loanPerson').value='';
    if(qs('#loanAmount')) qs('#loanAmount').value='';
    if(typeof renderLoans==='function') renderLoans();
  };

  window.payLoan = function(){
    const name = (qs('#loanPayPerson')?.value || '').trim();
    const amt  = Number(normalizeNum(qs('#loanPayAmount')?.value || '0'));
    const src  = qs('#loanPaySource')?.value || 'store'; // store / owner
    if(!name || !(amt>0)){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }

    const L = (typeof getLoans==='function') ? getLoans() : {people:{}};
    if(!L.people || !L.people[name]){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ù„Ù'); return; }

    const payId = (typeof uid==='function'? uid(): String(Date.now()));
    let linkedExpenseId = null;

    L.people[name].balance -= amt;
    L.people[name].history = L.people[name].history || [];
    L.people[name].history.push({
      id: payId, date: formDay(), type:'out', amount: amt,
      source: (src==='store'?'ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„':'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ'),
      note:   (src==='store'?'Ø³Ø¯Ø§Ø¯ Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„':'Ø³Ø¯Ø§Ø¯ Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ'),
      linkedExpenseId: null
    });
    if(typeof saveLoans==='function') saveLoans(L);

    if(src==='store'){
      const d = (typeof getStoreData==='function') ? getStoreData() : {sales:[],expenses:[]};
      linkedExpenseId = (typeof uid==='function'? uid(): String(Date.now()));
      d.expenses = Array.isArray(d.expenses) ? d.expenses : [];
      d.expenses.push({
        id: linkedExpenseId, date: formDay(), type: 'ÙƒØ§Ø´',
        desc:`Ø³Ø¯Ø§Ø¯ Ø³Ù„ÙØ© (${name})`, amount: amt, note:'Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„',
        benefType:'loan', benefName:name
      });
      if(typeof saveStoreData==='function') saveStoreData(d);
      const L2 = (typeof getLoans==='function') ? getLoans() : {people:{}};
      const rec = (L2.people?.[name]?.history || []).find(x=>x.id===payId);
      if(rec){ rec.linkedExpenseId = linkedExpenseId; if(typeof saveLoans==='function') saveLoans(L2); }
      if(typeof renderLists==='function') renderLists();
    }else{
      const O = (typeof getOwner==='function') ? getOwner() : {ledger:[]};
      O.ledger = Array.isArray(O.ledger) ? O.ledger : [];
      O.ledger.push({ id:(typeof uid==='function'? uid(): String(Date.now())), date: formDay(), type:'out', amount: amt, note:`Ø³Ø¯Ø§Ø¯ Ø³Ù„ÙØ© (${name})` });
      if(typeof saveOwner==='function') saveOwner(O);
      if(typeof updateOwnerBalanceUI==='function') updateOwnerBalanceUI();
    }
    if(qs('#loanPayPerson')) qs('#loanPayPerson').value='';
    if(qs('#loanPayAmount')) qs('#loanPayAmount').value='';
    if(typeof renderLoans==='function') renderLoans();
    if(typeof renderOwnerStatement==='function') renderOwnerStatement();
  };

  // =========================
  // ØªÙØ¬Ù‘Ø§Ø±
  // =========================
  window.addSupplierInvoice = function(){
    const name = (qs('#supName')?.value || '').trim();
    const amt  = Number(normalizeNum(qs('#supInvoice')?.value || '0'));
    if(!name || !(amt>0)){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙ‚ÙŠÙ…Ø© ÙØ§ØªÙˆØ±Ø© ØµØ­ÙŠØ­Ø©'); return; }

    const S = (typeof getSuppliers==='function') ? getSuppliers() : {people:{}};
    if(!S.people) S.people = {};
    if(!S.people[name]) S.people[name] = { balance:0, history:[] };

    const id = (typeof uid==='function'? uid(): String(Date.now()));
    S.people[name].balance += amt;
    S.people[name].history.push({ id, date: formDay(), type:'invoice', amount: amt, note:'ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª' });
    if(typeof saveSuppliers==='function') saveSuppliers(S);

    if(qs('#supName')) qs('#supName').value='';
    if(qs('#supInvoice')) qs('#supInvoice').value='';
    if(typeof renderSuppliers==='function') renderSuppliers();
  };

  window.paySupplier = function(){
    const name = (qs('#supPayName')?.value || '').trim();
    const amt  = Number(normalizeNum(qs('#supPayAmount')?.value || '0'));
    const src  = qs('#supPaySource')?.value || 'store'; // store / owner / bank
    if(!name || !(amt>0)){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }

    const S = (typeof getSuppliers==='function') ? getSuppliers() : {people:{}};
    if(!S.people || !S.people[name]){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø±'); return; }

    const payId = (typeof uid==='function'? uid(): String(Date.now()));
    let linkedExpenseId = null;

    S.people[name].balance -= amt;
    S.people[name].history = S.people[name].history || [];
    S.people[name].history.push({
      id: payId, date: formDay(), type:'pay', amount: amt,
      source: (src==='store'?'ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„':(src==='owner'?'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ':'Ø§Ù„Ø¨Ù†Ùƒ')),
      note:   (src==='store'?'Ø¯ÙØ¹Ø© Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„':(src==='owner'?'Ø¯ÙØ¹Ø© Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ':'Ø¯ÙØ¹Ø© Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ')),
      linkedExpenseId: null
    });
    if(typeof saveSuppliers==='function') saveSuppliers(S);

    if(src==='store' || src==='bank'){
      const d = (typeof getStoreData==='function') ? getStoreData() : {sales:[],expenses:[]};
      linkedExpenseId = (typeof uid==='function'? uid(): String(Date.now()));
      d.expenses = Array.isArray(d.expenses) ? d.expenses : [];
      d.expenses.push({
        id: linkedExpenseId, date: formDay(), type: (src==='store'?'ÙƒØ§Ø´':'Ø¨Ù†Ùƒ'),
        desc:`Ø¯ÙØ¹Ø© ØªØ§Ø¬Ø± (${name})`, amount: amt, note:(src==='store'?'Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„':'Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ'),
        benefType:'supplier', benefName:name
      });
      if(typeof saveStoreData==='function') saveStoreData(d);
      const S2 = (typeof getSuppliers==='function') ? getSuppliers() : {people:{}};
      const rec = (S2.people?.[name]?.history || []).find(x=>x.id===payId);
      if(rec){ rec.linkedExpenseId = linkedExpenseId; if(typeof saveSuppliers==='function') saveSuppliers(S2); }
      if(typeof renderLists==='function') renderLists();
    }else if(src==='owner'){
      const O = (typeof getOwner==='function') ? getOwner() : {ledger:[]};
      O.ledger = Array.isArray(O.ledger) ? O.ledger : [];
      O.ledger.push({ id:(typeof uid==='function'? uid(): String(Date.now())), date: formDay(), type:'out', amount: amt, note:`Ø¯ÙØ¹Ø© ØªØ§Ø¬Ø± (${name})` });
      if(typeof saveOwner==='function') saveOwner(O);
      if(typeof updateOwnerBalanceUI==='function') updateOwnerBalanceUI();
    }

    if(qs('#supPayName')) qs('#supPayName').value='';
    if(qs('#supPayAmount')) qs('#supPayAmount').value='';
    if(typeof renderSuppliers==='function') renderSuppliers();
    if(typeof renderOwnerStatement==='function') renderOwnerStatement();
  };

  // 4) Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø© IDs Ù„Ù‡Ø§)
  const expBtn = document.getElementById('addExpenseBtn');
  if(expBtn){ expBtn.onclick = null; expBtn.addEventListener('click', window.addExpense); }
  const saleBtn = document.getElementById('addSaleBtn');
  if(saleBtn){ saleBtn.onclick = null; saleBtn.addEventListener('click', window.addSale); }
})();
</script> 
</body>
</html>
