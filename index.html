<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ูุธุงู ุงููุญุงุณุจุฉ โ ุงูุฅุตุฏุงุฑ ุงูููุงุฆู</title>
<meta name="theme-color" content="#2b7bff"/>
<style>
:root{--blue:#2b7bff;--blue-soft:#eaf3ff;--line:#e5e7eb;--card:#fff;--danger:#dc3545;--ok:#16a34a;--muted:#64748b}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:Tajawal,Arial,Helvetica,sans-serif;background:var(--blue-soft);color:#0f172a}
header{position:sticky;top:0;z-index:10;background:var(--blue);color:#fff;padding:12px 14px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
header h1{margin:0;font-size:18px}
header .sub{opacity:.95;font-size:13px}
header .owner-badge{margin-top:6px;font-size:14px;color:#eaf5ff;background:rgba(255,255,255,.12);display:inline-block;padding:6px 10px;border-radius:10px}
main{padding:12px;max-width:1150px;margin:auto;padding-bottom:160px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 1px 6px rgba(0,0,0,.04)}
h3{margin:6px 0 10px;color:#0d47a1}
.row{display:flex;flex-wrap:wrap;gap:10px}
.col{flex:1;min-width:220px}
label{font-size:13px;color:#111}
input,select,textarea,button{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:16px;background:#fff}
button{border:none;cursor:pointer}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border-radius:12px;padding:10px 14px;font-size:14px}
.btn-primary{background:var(--blue);color:#fff}
.btn-outline{background:#fff;border:1px solid var(--line);color:#111}
.btn-danger{background:var(--danger);color:#fff}
.btn-ok{background:var(--ok);color:#fff}
.hint{font-size:12px;color:var(--muted)}
.list .item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 0;border-bottom:1px dashed var(--line)}
.list .item:last-child{border-bottom:none}
.list .meta{flex:1}
.kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
.kpi .box{background:#f3f7ff;border:1px solid #e3ecff;border-radius:12px;padding:10px;text-align:center}
.kpi .box b{display:block;font-size:16px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--line);padding:8px;text-align:center;font-size:14px}
th{background:#f8fbff}
.tabs{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--line);display:flex}
.tab{flex:1}
.tab button{width:100%;background:#fff;border:none;padding:12px 0}
.tab.active{background:#f0f6ff}
.separator{height:1px;background:var(--line);margin:8px 0}
.subtle{background:#f9fbff;border:1px solid #eef2ff;border-radius:12px;padding:10px;margin-top:8px}
@media print{
  header,nav.tabs,.print-hide{display:none!important}
  body{background:#fff}
  .card{box-shadow:none;border:none;padding:0;margin:0}
  .page{page-break-after:always;margin-bottom:30px}
}
</style>
</head>
<body>
<header class="print-hide">
  <h1>ูุธุงู ุงููุญุงุณุจุฉ</h1>
  <div class="sub">ุงููุงูู: <b>ุนุจุฏ ุงููู ุฃุจู ุนูุถ</b></div>
  <div class="owner-badge">ุฑุตูุฏ ุตูุฏูู ุงููุงูู: <b id="ownerBalanceVal">0</b></div>
</header>

<main>
  <div class="card print-hide">
    <div class="row">
      <div class="col">
        <label>ุงููุญู</label>
        <select id="storeSelect" onchange="changeStore()">
          <option value="store1">ุฑูุงู ุจูุจู</option>
          <option value="store2">ุฌูุชู ุจูุจู ุนุจูุฏ</option>
          <option value="store3">ุจุณุทุฉ</option>
        </select>
      </div>
      <div class="col">
        <label>ุชุงุฑูุฎ ุงูููู</label>
        <input type="date" id="todayInput"/>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button class="btn btn-primary" onclick="settleDay()">ุชุณููุฉ ุงูููู ูุตูุฏูู ุงููุงูู</button>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button class="btn btn-outline" onclick="exportBackup()">โฌ๏ธ ุชุตุฏูุฑ ูุณุฎุฉ</button>
      </div>
      <div class="col">
        <label for="importFile" class="btn btn-ok" style="display:inline-block;cursor:pointer;text-align:center">โฌ๏ธ ุงุณุชูุฑุงุฏ ูุณุฎุฉ</label>
        <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importBackup(this.files[0])"/>
      </div>
    </div>
    <div class="hint">ุชุนูู ุจุฏูู ุฅูุชุฑูุช โ ูู ุงูุจูุงูุงุช ูุญูููุง. ุงูุชุณููุฉ ุงูููููุฉ ุชุณุชุจุฏู ููุฏ ุงูููู ูููุณ ุงููุญู ุญุชู ูุง ูุชูุฑุฑ.</div>
  </div>

  <!-- ุฅุฏุฎุงู -->
  <section class="card" data-tab="input">
    <h3>ุชุณุฌูู ุงููุจูุนุงุช</h3>
    <div class="row">
      <div class="col"><input type="number" id="saleAmount" placeholder="ุงููุจูุบ"></div>
      <div class="col">
        <select id="saleType">
          <option value="ูุงุด">ูุงุด</option>
          <option value="ุจูู">ุจูู</option>
        </select>
      </div>
      <div class="col"><input type="text" id="saleNote" placeholder="ููุงุญุธุงุช (ุงุณู ุงููุดุชุฑู/ุงูุตูู/ุฌูุงู)"></div>
      <div class="col"><button class="btn btn-ok" onclick="addSale()">โ ุฅุถุงูุฉ ุจูุน</button></div>
    </div>
    <div id="recentSales" class="list"></div>

    <h3 style="margin-top:18px">ุชุณุฌูู ุงููุตุงุฑูู (ูู ูุงุด ุงููุญู)</h3>
    <div class="row">
      <div class="col"><input type="text" id="expenseDesc" placeholder="ูุตู ุงููุตุฑูู"></div>
      <div class="col"><input type="number" id="expenseAmount" placeholder="ุงููุจูุบ"></div>
      <div class="col"><input type="text" id="expenseNote" placeholder="ููุงุญุธุงุช (ุงุฎุชูุงุฑู)"></div>

      <div class="col">
        <select id="expenseBenefType">
          <option value="">โ ุฌูุฉ ูุณุชููุฏุฉ (ุงุฎุชูุงุฑู) โ</option>
          <option value="supplier">ุณุฏุงุฏ ูุชุงุฌุฑ</option>
          <option value="loan">ุณุฏุงุฏ ููุณูู</option>
        </select>
      </div>
      <div class="col">
        <input type="text" id="expenseBenefName" list="benefList" placeholder="ุงูุชุจ ุงูุงุณู ูุณูุธูุฑ ุงูุชุฑุงุญ">
        <datalist id="benefList"></datalist>
      </div>

      <div class="col"><button class="btn btn-ok" id="addExpenseBtn">โ ุฅุถุงูุฉ ูุตุฑูู</button></div>
    </div>
    <div id="recentExpenses" class="list"></div>
  </section>

  <!-- ูููู -->
  <section class="card" data-tab="daily">
    <h3>ุงูุชูุฑูุฑ ุงููููู</h3>
    <div class="row print-hide">
      <div class="col"><label>ุงูุชุงุฑูุฎ</label><input type="date" id="r_date"></div>
      <div class="col"><label>ุงููุญู</label>
        <select id="r_store">
          <option value="store1">ุฑูุงู ุจูุจู</option>
          <option value="store2">ุฌูุชู ุจูุจู ุนุจูุฏ</option>
          <option value="store3">ุจุณุทุฉ</option>
        </select>
      </div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="generateDaily()">ุนุฑุถ ุงูุชูุฑูุฑ</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ PDF</button></div>
    </div>
    <div id="dailyWrap"></div>
  </section>

  <!-- ูุชุฑุฉ / ูุฌููุน -->
  <section class="card" data-tab="range">
    <h3>ุชูุฑูุฑ ูุชุฑุฉ / ูุฌููุน</h3>
    <div class="row print-hide">
      <div class="col"><label>ูู</label><input type="date" id="f_from"></div>
      <div class="col"><label>ุฅูู</label><input type="date" id="f_to"></div>
      <div class="col"><label>ุงูููุท</label><select id="f_mode"><option value="per">ูููุตู ููู ูุญู</option><option value="all">ูุฌููุน ูููุญูุงุช ุงูุซูุงุซุฉ</option></select></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="generateRange()">ุนุฑุถ ุงูุชูุฑูุฑ</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ PDF</button></div>
    </div>
    <div id="rangeWrap"></div>
  </section>

  <!-- ุงูุณูู -->
  <section class="card" data-tab="loans">
    <h3>ุงูุณููู (ูุงุด ููุท)</h3>
    <div class="row">
      <div class="col"><input type="text" id="loanPerson" placeholder="ุงุณู ุงูููุณูู"></div>
      <div class="col"><input type="number" id="loanAmount" placeholder="ูุจูุบ ุงูุณููุฉ (+)"></div>
      <div class="col"><button class="btn btn-ok" onclick="addLoan()">โ ุฅุถุงูุฉ ุณููุฉ (ูุฒูุฏ ูุงุด ุงููุญู)</button></div>
    </div>
    <div class="row">
      <div class="col"><input type="text" id="loanPayPerson" list="loanList" placeholder="ุงูุชุจ ุงูุงุณู ููุณุฏุงุฏ"></div>
      <datalist id="loanList"></datalist>
      <div class="col"><input type="number" id="loanPayAmount" placeholder="ูุจูุบ ุงูุณุฏุงุฏ (โ)"></div>
      <div class="col">
        <select id="loanPaySource">
          <option value="store">ูู ูุงุด ุงููุญู</option>
          <option value="owner">ูู ุตูุฏูู ุงููุงูู</option>
        </select>
      </div>
      <div class="col"><button class="btn btn-primary" onclick="payLoan()">๐ธ ุชุณุฌูู ุณุฏุงุฏ</button></div>
    </div>
    <div class="row print-hide" style="margin-top:8px">
      <div class="col"><input type="text" id="loanStmtName" list="loanList" placeholder="ุงุณู ุงููุณูู ููุดู ุงูุญุณุงุจ"></div>
      <div class="col"><input type="date" id="loanStmtFrom"></div>
      <div class="col"><input type="date" id="loanStmtTo"></div>
      <div class="col"><button class="btn btn-outline" onclick="renderLoanStatement()">๐ ุนุฑุถ ูุดู ุงููุณูู</button></div>
      <div class="col"><button class="btn btn-outline" onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ PDF</button></div>
    </div>
    <div id="loansWrap" class="subtle" style="margin-top:8px"></div>
    <div id="loanStatementWrap"></div>
  </section>

  <!-- ุงูุชุฌุงุฑ -->
  <section class="card" data-tab="suppliers">
    <h3>ุงูุชูุฌุงุฑ</h3>
    <div class="row">
      <div class="col"><input type="text" id="supName" placeholder="ุงุณู ุงูุชุงุฌุฑ"></div>
      <div class="col"><input type="number" id="supInvoice" placeholder="ูููุฉ ุงููุงุชูุฑุฉ (ุชุฒูุฏ ุงูุฏูู)"></div>
      <div class="col"><button class="btn btn-ok" onclick="addSupplierInvoice()">โ ุชุณุฌูู ูุงุชูุฑุฉ</button></div>
    </div>
    <div class="row">
      <div class="col"><input type="text" id="supPayName" list="supList" placeholder="ุงูุชุจ ุงูุงุณู ููุณุฏุงุฏ"></div>
      <datalist id="supList"></datalist>
      <div class="col"><input type="number" id="supPayAmount" placeholder="ูุจูุบ ุงูุฏูุนุฉ (โ)"></div>
      <div class="col"><select id="supPaySource">
        <option value="store">ูู ูุงุด ุงููุญู</option>
        <option value="owner">ูู ุตูุฏูู ุงููุงูู</option>
        <option value="bank">ูู ุญุณุงุจ ุงูุจูู</option>
      </select></div>
      <div class="col"><button class="btn btn-primary" onclick="paySupplier()">๐ณ ุชุณุฌูู ุฏูุนุฉ</button></div>
    </div>
    <div class="row print-hide" style="margin-top:8px">
      <div class="col"><input type="text" id="supStmtName" list="supList" placeholder="ุงุณู ุงูุชุงุฌุฑ ููุดู ุงูุญุณุงุจ"></div>
      <div class="col"><input type="date" id="supStmtFrom"></div>
      <div class="col"><input type="date" id="supStmtTo"></div>
      <div class="col"><button class="btn btn-outline" onclick="renderSupplierStatement()">๐ ุนุฑุถ ูุดู ุงูุชุงุฌุฑ</button></div>
      <div class="col"><button class="btn btn-outline" onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ PDF</button></div>
    </div>
    <div id="supWrap" class="subtle" style="margin-top:8px"></div>
    <div id="supplierStatementWrap"></div>
  </section>

  <!-- ุงูุฏููู (ุนููุงุก) -->
  <section class="card" data-tab="debts">
    <h3>ุงูุฏููู (ุนููุงุก)</h3>
    <div class="row">
      <div class="col"><input type="text" id="debtorName" placeholder="ุงุณู ุงูุนููู"></div>
      <div class="col"><input type="number" id="debtAmount" placeholder="ูููุฉ ุงูุฏูู (+)"></div>
      <div class="col"><input type="text" id="debtNote" placeholder="ููุงุญุธุฉ (ุงุฎุชูุงุฑู)"></div>
      <div class="col"><button class="btn btn-ok" onclick="addDebt()">โ ุชุณุฌูู ุฏูู</button></div>
    </div>
    <div class="row">
      <div class="col"><input type="text" id="debtPayName" list="debtList" placeholder="ุงุฎุชุฑ/ุงูุชุจ ุงูุงุณู ููุณุฏุงุฏ"></div>
      <datalist id="debtList"></datalist>
      <div class="col"><input type="number" id="debtPayAmount" placeholder="ูุจูุบ ุงูุณุฏุงุฏ (โ)"></div>
      <div class="col">
        <select id="debtPayMethod">
          <option value="ูุงุด">ูุงุด (ูุฒูุฏ ูุจูุนุงุช ุงููุงุด)</option>
          <option value="ุจูู">ุจูู (ูุฒูุฏ ูุจูุนุงุช ุงูุจูู)</option>
        </select>
      </div>
      <div class="col"><button class="btn btn-primary" onclick="payDebt()">๐ฐ ุชุณุฌูู ุณุฏุงุฏ ุฏูู</button></div>
    </div>
    <div class="row print-hide" style="margin-top:8px">
      <div class="col"><input type="text" id="debtStmtName" list="debtList" placeholder="ุงุณู ุงูุนููู ููุดู ุงูุญุณุงุจ"></div>
      <div class="col"><input type="date" id="debtStmtFrom"></div>
      <div class="col"><input type="date" id="debtStmtTo"></div>
      <div class="col"><button class="btn btn-outline" onclick="renderDebtStatement()">๐ ุนุฑุถ ูุดู ุงูุนููู</button></div>
      <div class="col"><button class="btn btn-outline" onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ PDF</button></div>
    </div>
    <div id="debtsWrap" class="subtle" style="margin-top:8px"></div>
    <div id="debtStatementWrap"></div>
  </section>

  <!-- ุตูุฏูู ุงููุงูู -->
  <section class="card" data-tab="owner">
    <h3>ุตูุฏูู ุงููุงูู</h3>
    <div class="row">
      <div class="col"><input type="number" id="ownerInAmt" placeholder="ุฅูุฏุงุน ููุตูุฏูู (+)"></div>
      <div class="col"><input type="text" id="ownerInNote" placeholder="ููุงุญุธุฉ (ุงุฎุชูุงุฑู)"></div>
      <div class="col"><button class="btn btn-ok" onclick="ownerDeposit()">โ ุฅูุฏุงุน</button></div>
      <div class="col"><input type="number" id="ownerOutAmt" placeholder="ุณุญุจ ูู ุงูุตูุฏูู (โ)"></div>
      <div class="col"><input type="text" id="ownerOutNote" placeholder="ููุงุญุธุฉ (ุงุฎุชูุงุฑู)"></div>
      <div class="col"><button class="btn btn-danger" onclick="ownerWithdraw()">โ ุณุญุจ</button></div>
    </div>

    <div class="subtle" style="margin-top:10px">
      <div class="row print-hide">
        <div class="col"><label>ูู</label><input type="date" id="of_from"></div>
        <div class="col"><label>ุฅูู</label><input type="date" id="of_to"></div>
        <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="renderOwnerStatement()">ุนุฑุถ ุงููุดู</button></div>
        <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ PDF</button></div>
      </div>
      <div id="ownerWrap"></div>
    </div>

    <div class="subtle" style="margin-top:10px">
      <h4>ุชูุฑูุฑ ุดูุฑู ูุฌููุน</h4>
      <div class="row print-hide">
        <div class="col"><label>ุงูุดูุฑ</label><input type="month" id="m_month"></div>
        <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="generateMonthly()">ุฅูุดุงุก ุงูุชูุฑูุฑ ุงูุดูุฑู</button></div>
        <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ PDF</button></div>
      </div>
      <div id="monthlyWrap"></div>
    </div>
  </section>
</main>

<nav class="tabs print-hide">
  <div class="tab active"><button onclick="showTab('input')">ุฅุฏุฎุงู</button></div>
  <div class="tab"><button onclick="showTab('daily')">ูููู</button></div>
  <div class="tab"><button onclick="showTab('range')">ูุชุฑุฉ/ูุฌููุน</button></div>
  <div class="tab"><button onclick="showTab('loans')">ุณููู</button></div>
  <div class="tab"><button onclick="showTab('suppliers')">ุชูุฌุงุฑ</button></div>
  <div class="tab"><button onclick="showTab('debts')">ุงูุฏููู</button></div>
  <div class="tab"><button onclick="showTab('owner')">ุงููุงูู</button></div>
</nav>

<script>
/* ุฃุณุงุณูุงุช */
const stores={store1:"ุฑูุงู ุจูุจู",store2:"ุฌูุชู ุจูุจู ุนุจูุฏ",store3:"ุจุณุทุฉ"};let currentStore="store1";
const qs=s=>document.querySelector(s), qsa=s=>Array.from(document.querySelectorAll(s));
const todayISO=()=>new Date().toISOString().slice(0,10);
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,7);
const inRange=(iso,from,to)=>{if(!iso)return false;const d=new Date(iso+"T00:00:00");return(!from||d>=new Date(from+"T00:00:00"))&&(!to||d<=new Date(to+"T00:00:00"));};
const sum=(arr,fn)=>arr.reduce((a,b)=>a+fn(b),0);

/* ุชุฎุฒูู */
function getStoreData(store=currentStore){return JSON.parse(localStorage.getItem(store)||'{"sales":[],"expenses":[]}')}
function saveStoreData(data,store=currentStore){localStorage.setItem(store,JSON.stringify(data))}
function getLoans(){return JSON.parse(localStorage.getItem('loans')||'{"people":{}}')}
function saveLoans(v){localStorage.setItem('loans',JSON.stringify(v))}
function getSuppliers(){return JSON.parse(localStorage.getItem('suppliers')||'{"people":{}}')}
function saveSuppliers(v){localStorage.setItem('suppliers',JSON.stringify(v))}
function getOwner(){return JSON.parse(localStorage.getItem('owner_fund')||'{"ledger":[]}')}
function saveOwner(v){localStorage.setItem('owner_fund',JSON.stringify(v))}
function getDebts(){return JSON.parse(localStorage.getItem('debts')||'{"people":{}}')}
function saveDebts(v){localStorage.setItem('debts',JSON.stringify(v))}

/* ุงูุชุฑุงุญุงุช ุฃุณูุงุก ุฏููุงููููุฉ */
function supplierNames(){const S=getSuppliers();return S.people?Object.keys(S.people):[]}
function loanNames(){const L=getLoans();return L.people?Object.keys(L.people):[]}
function debtorNames(){const D=getDebts();return D.people?Object.keys(D.people):[]}
function refreshNameLists(){
  const dl=qs('#benefList'); if(dl){const names=[...new Set([...supplierNames(),...loanNames()])]; dl.innerHTML=names.map(n=>`<option value="${n}">`).join('')}
  const dl2=qs('#loanList'); if(dl2){dl2.innerHTML=loanNames().map(n=>`<option value="${n}">`).join('')}
  const dl3=qs('#supList'); if(dl3){dl3.innerHTML=supplierNames().map(n=>`<option value="${n}">`).join('')}
  const dl4=qs('#debtList'); if(dl4){dl4.innerHTML=debtorNames().map(n=>`<option value="${n}">`).join('')}
}
qs('#expenseBenefType').addEventListener('change',()=>{
  const type=qs('#expenseBenefType').value, dl=qs('#benefList'); if(!dl)return;
  let names=[]; if(type==='supplier')names=supplierNames(); else if(type==='loan')names=loanNames(); else names=[...new Set([...supplierNames(),...loanNames()])];
  dl.innerHTML=names.map(n=>`<option value="${n}">`).join('');
});

/* ุชุจููุจุงุช */
function changeStore(){currentStore=qs('#storeSelect').value;renderAll()}
function showTab(name){
  qsa('[data-tab]').forEach(el=>el.style.display=(el.getAttribute('data-tab')===name?'block':'none'));
  const order=['input','daily','range','loans','suppliers','debts','owner'];
  qsa('.tabs .tab').forEach((t,i)=>t.classList.toggle('active',order[i]===name));
  if(name==='loans') renderLoans();
  if(name==='suppliers') renderSuppliers();
  if(name==='debts') renderDebts();
  if(name==='owner') {renderOwnerStatement(); updateOwnerBalanceUI();}
}
function printSection(){window.print()}

/* ูุจูุนุงุช */
function addSale(){
  const a=parseFloat(qs('#saleAmount').value||'0'), t=qs('#saleType').value, n=(qs('#saleNote').value||'').trim();
  if(!a){alert('ุฃุฏุฎู ูุจูุบ ุตุญูุญ');return}
  const d=getStoreData(); d.sales.push({id:uid(),date:todayISO(),type:t,amount:a,note:n}); saveStoreData(d);
  qs('#saleAmount').value=''; qs('#saleNote').value=''; renderLists();
}
function deleteSale(id){if(!confirm('ุญุฐู ุนูููุฉ ุงูุจูุนุ'))return;const d=getStoreData();const i=d.sales.findIndex(x=>x.id===id);if(i>-1){d.sales.splice(i,1);saveStoreData(d);renderLists()}}

/* ูุตุงุฑูู + ุฑุจุท ุชููุงุฆู (ุชุงุฌุฑ/ูุณูู) */
function _deductSupplier(name, amt) {
  const S = getSuppliers(); if(!S.people) S.people={};
  if (!S.people[name]) S.people[name] = { balance: 0, history: [] };
  S.people[name].balance -= amt;
  S.people[name].history.push({ id: uid(), date: todayISO(), type: 'pay', amount: amt, note: 'ูุตุฑูู ููุฌูู (ูู ูุงุด ุงููุญู)' });
  saveSuppliers(S); renderSuppliers?.(); refreshNameLists();
}
function _undeductSupplier(name, amt) {
  const S = getSuppliers(); if(!S.people||!S.people[name]) return;
  S.people[name].balance += amt;
  S.people[name].history.push({ id: uid(), date: todayISO(), type: 'revert', amount: amt, note: 'ุฅูุบุงุก ูุตุฑูู ููุฌูู' });
  saveSuppliers(S); renderSuppliers?.(); refreshNameLists();
}
function _deductLoan(name, amt) {
  const L = getLoans(); if(!L.people) L.people={};
  if (!L.people[name]) L.people[name] = { balance: 0, history: [] };
  L.people[name].balance -= amt;
  L.people[name].history.push({ id: uid(), date: todayISO(), type: 'out', amount: amt, note: 'ูุตุฑูู ููุฌูู (ูู ูุงุด ุงููุญู)' });
  saveLoans(L); renderLoans?.(); refreshNameLists();
}
function _undeductLoan(name, amt) {
  const L = getLoans(); if(!L.people||!L.people[name]) return;
  L.people[name].balance += amt;
  L.people[name].history.push({ id: uid(), date: todayISO(), type: 'revert', amount: amt, note: 'ุฅูุบุงุก ูุตุฑูู ููุฌูู' });
  saveLoans(L); renderLoans?.(); refreshNameLists();
}
function addExpense(){
  const desc=(qs('#expenseDesc').value||'').trim();
  const a=parseFloat(qs('#expenseAmount').value||'0');
  const n=(qs('#expenseNote').value||'').trim();
  const bType = qs('#expenseBenefType').value || '';
  const bName = (qs('#expenseBenefName').value||'').trim();
  if(!desc||!a){alert('ุฃุฏุฎู ูุตู ููุจูุบ ุตุญูุญ');return}
  const d=getStoreData();
  const exp={id:uid(),date:todayISO(),type:'ูุงุด',desc,amount:a,note:n,benefType:bType||null,benefName:bName||null};
  d.expenses.push(exp); saveStoreData(d);
  if (bType && bName){ if (bType==='supplier') _deductSupplier(bName,a); if (bType==='loan') _deductLoan(bName,a); }
  qs('#expenseDesc').value=''; qs('#expenseAmount').value=''; qs('#expenseNote').value=''; qs('#expenseBenefType').value=''; qs('#expenseBenefName').value='';
  renderLists();
}
document.getElementById('addExpenseBtn').addEventListener('click', addExpense);
function deleteExpense(id){
  if(!confirm('ุญุฐู ุงููุตุฑููุ'))return;
  const d=getStoreData(); const i=d.expenses.findIndex(x=>x.id===id); if(i===-1) return;
  const exp=d.expenses[i];
  if (exp.benefType && exp.benefName && exp.amount){
    if (exp.benefType==='supplier') _undeductSupplier(exp.benefName, Number(exp.amount));
    if (exp.benefType==='loan')     _undeductLoan(exp.benefName, Number(exp.amount));
  }
  d.expenses.splice(i,1); saveStoreData(d); renderLists();
}

/* ุณููู โ ุชุฒูุฏ ุงููุงุด ุชููุงุฆููุง ูุชุธูุฑ ูููุงุญุธุฉ */
function renderLoans(){
  const L=getLoans(), names=Object.keys(L.people||{});
  if(!names.length){qs('#loansWrap').innerHTML='<div class="hint">ูุง ุชูุฌุฏ ุณูู ุจุนุฏ</div>';refreshNameLists?.();return}
  const rows=names.map(n=>`<tr>
      <td>${n}</td>
      <td>${L.people[n].balance||0}</td>
      <td><button class="btn btn-danger" onclick="deleteLoanPerson('${n.replace(/'/g,"\\'")}')">๐ ุญุฐู</button></td>
    </tr>`).join('');
  const allTx=[]; names.forEach(n=>{(L.people[n].history||[]).slice(-30).forEach(h=>allTx.push({name:n,...h}))}); allTx.sort((a,b)=>(a.date||'').localeCompare(b.date||'')); allTx.reverse();
  const txRows = allTx.length ? allTx.map(h=>{
    const kind = h.type==='in' ? 'ุณููุฉ (+)':(h.type==='out'?`ุณุฏุงุฏ (โ)`: (h.type==='revert'?'ุฅูุบุงุก/ุงุณุชุฑุฌุงุน':(h.type||'')));
    const btn = (h.type==='in' || h.type==='out') ? `<button class="btn btn-danger" onclick="deleteLoanHistory('${h.name.replace(/'/g,"\\'")}','${h.id||''}')">ุญุฐู ุงูููุฏ</button>` : '';
    return `<tr><td>${h.date||''}</td><td>${h.name}</td><td>${kind}</td><td>${h.amount||0}</td><td>${h.note||''}</td><td>${btn}</td></tr>`;
  }).join('') : `<tr><td colspan="6">ูุง ุชูุฌุฏ ุญุฑูุงุช ุญุฏูุซุฉ</td></tr>`;
  qs('#loansWrap').innerHTML = `
    <h4>ุฃุฑุตุฏุฉ ุงููุณูููู</h4>
    <table><thead><tr><th>ุงูุงุณู</th><th>ุงูุฑุตูุฏ</th><th>ุฅุฌุฑุงุก</th></tr></thead><tbody>${rows}</tbody></table>
    <h4 style="margin-top:12px">ุขุฎุฑ ุงูุญุฑูุงุช</h4>
    <table><thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูุงุณู</th><th>ุงูููุน</th><th>ุงููุจูุบ</th><th>ููุงุญุธุฉ</th><th>ุฅุฌุฑุงุก</th></tr></thead>
    <tbody>${txRows}</tbody></table>`;
}
function addLoan(){
  const name=(qs('#loanPerson').value||'').trim(), amt=parseFloat(qs('#loanAmount').value||'0');
  if(!name||!amt){alert('ุฃุฏุฎู ุงุณู ููุจูุบ ุตุญูุญ');return}
  const L=getLoans(); if(!L.people) L.people={};
  if(!L.people[name]) L.people[name]={balance:0,history:[]};
  const saleId=uid();
  L.people[name].balance += amt;
  L.people[name].history.push({id:uid(), date:todayISO(), type:'in', amount:amt, note:'ุณููุฉ ูููุญู', linkedSaleId:saleId});
  saveLoans(L);
  const d=getStoreData();
  d.sales.push({id:saleId,date:todayISO(),type:'ูุงุด',amount:amt,note:`ุณูููุฉ ูู (${name})`});
  saveStoreData(d);
  qs('#loanPerson').value=''; qs('#loanAmount').value=''; renderLoans(); renderLists();
}
function payLoan(){
  const name=(qs('#loanPayPerson').value||'').trim(), amt=parseFloat(qs('#loanPayAmount').value||'0'), src=qs('#loanPaySource').value;
  if(!name||!amt){alert('ุฃุฏุฎู ุงุณู ููุจูุบ ุตุญูุญ');return}
  const L=getLoans(); if(!L.people||!L.people[name]){alert('ูุง ููุฌุฏ ูุฐุง ุงููุณูู');return}
  L.people[name].balance -= amt;
  if(src==='store'){
    const d=getStoreData();
    d.expenses.push({id:uid(),date:todayISO(),type:'ูุงุด',desc:`ุณุฏุงุฏ ุณููุฉ (${name})`,amount:amt,note:'ูู ูุงุด ุงููุญู'});
    saveStoreData(d);
    L.people[name].history.push({id:uid(),date:todayISO(),type:'out',amount:amt,note:'ุณุฏุงุฏ ูู ูุงุด ุงููุญู'});
  }else{
    L.people[name].history.push({id:uid(),date:todayISO(),type:'out',amount:amt,note:'ุณุฏุงุฏ ูู ุตูุฏูู ุงููุงูู'});
    const O=getOwner(); O.ledger.push({id:uid(),date:todayISO(),type:'out',amount:amt,note:`ุณุฏุงุฏ ุณููุฉ (${name})`, linked:true});
    saveOwner(O); updateOwnerBalanceUI();
  }
  saveLoans(L);
  qs('#loanPayPerson').value=''; qs('#loanPayAmount').value=''; renderLoans(); renderLists(); renderOwnerStatement();
}
function deleteLoanHistory(name, histId){
  const L=getLoans(); if(!L.people||!L.people[name]) return;
  const i=(L.people[name].history||[]).findIndex(h=>h.id===histId); if(i===-1) return;
  const rec=L.people[name].history[i];
  if(rec.type==='in'){
    L.people[name].balance -= Number(rec.amount||0);
    if(rec.linkedSaleId){
      const d=getStoreData(); const j=(d.sales||[]).findIndex(s=>s.id===rec.linkedSaleId);
      if(j>-1){ d.sales.splice(j,1); saveStoreData(d); renderLists?.(); }
    }
  }
  if(rec.type==='out'){ L.people[name].balance += Number(rec.amount||0); }
  L.people[name].history.splice(i,1); saveLoans(L); renderLoans();
}
function deleteLoanPerson(name){
  if(!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงููุณูู "${name}" ูุฌููุน ูุนุงููุงุชูุ ูุง ูููู ุงูุชุฑุงุฌุน.`)) return;
  const L=getLoans(); if(L.people && L.people[name]){ delete L.people[name]; saveLoans(L); renderLoans(); refreshNameLists(); alert('ุชู ุงูุญุฐู ุจูุฌุงุญ'); }
}
/* ูุดู ูุณูููู */
function renderLoanStatement(){
  const name=(qs('#loanStmtName').value||'').trim(), from=qs('#loanStmtFrom').value, to=qs('#loanStmtTo').value;
  const L=getLoans(); if(!name || !L.people || !L.people[name]){alert('ุงุฎุชุฑ ุงุณู ูุณูู ุตุญูุญ');return}
  const hist=(L.people[name].history||[]).filter(h=>inRange(h.date,from,to));
  const rows=hist.length?hist.map(h=>{
    const kind = h.type==='in'?'ุณููุฉ (+)':(h.type==='out'?'ุณุฏุงุฏ (โ)':'ุฃุฎุฑู');
    return `<tr><td>${h.date||''}</td><td>${kind}</td><td>${h.amount||0}</td><td>${h.note||''}</td></tr>`;
  }).join(''):`<tr><td colspan="4">ูุง ุชูุฌุฏ ุญุฑูุงุช</td></tr>`;
  const bal=L.people[name].balance||0;
  qs('#loanStatementWrap').innerHTML=`
    <div class="page">
      <h2 style="margin:0 0 8px">ูุดู ุงููุณูููู โ ${name}</h2>
      <div class="hint">ุงููุชุฑุฉ: <b>${from||'โ'}</b> โ <b>${to||'โ'}</b> โ ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: <b>${todayISO()}</b></div>
      <div class="separator"></div>
      <table><thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูููุน</th><th>ุงููุจูุบ</th><th>ุงูููุงุญุธุฉ</th></tr></thead><tbody>${rows}</tbody></table>
      <div style="margin-top:8px"><b>ุงูุฑุตูุฏ ุงูุญุงูู:</b> ${bal}</div>
      <div style="margin-top:40px;display:flex;justify-content:space-between"><div>ุชูููุน ุงููุงูู: ุนุจุฏ ุงููู ุฃุจู ุนูุถ ____________________</div><div>ุชูููุน ุงููุฏูุฑ ุงููุงูู: ____________________</div></div>
    </div>`;
}

/* ุงูุชุฌูุงุฑ */
function renderSuppliers(){
  const S=getSuppliers(), names=Object.keys(S.people||{});
  if(!names.length){qs('#supWrap').innerHTML='<div class="hint">ูุง ููุฌุฏ ุชุฌุงุฑ ุจุนุฏ</div>';refreshNameLists?.();return}
  const rows=names.map(n=>`<tr>
      <td>${n}</td>
      <td>${S.people[n].balance||0}</td>
      <td><button class="btn btn-danger" onclick="deleteSupplierPerson('${n.replace(/'/g,"\\'")}')">๐ ุญุฐู</button></td>
    </tr>`).join('');
  const allTx=[]; names.forEach(n=>{(S.people[n].history||[]).slice(-30).forEach(h=>allTx.push({name:n,...h}))}); allTx.sort((a,b)=>(a.date||'').localeCompare(b.date||'')); allTx.reverse();
  const txRows = allTx.length ? allTx.map(h=>{
    const kind = h.type==='invoice' ? 'ูุงุชูุฑุฉ (+)' : (h.type==='pay' ? `ุฏูุนุฉ (โ)` : (h.type==='revert' ? 'ุฅูุบุงุก/ุงุณุชุฑุฌุงุน' : (h.type||'')));
    const btn  = (h.type==='pay' || h.type==='invoice') ? `<button class="btn btn-danger" onclick="deleteSupplierHistory('${h.name.replace(/'/g,"\\'")}','${h.id||''}')">ุญุฐู ุงูููุฏ</button>` : '';
    return `<tr><td>${h.date||''}</td><td>${h.name}</td><td>${kind}</td><td>${h.amount||0}</td><td>${h.note||''}</td><td>${btn}</td></tr>`;
  }).join('') : `<tr><td colspan="6">ูุง ุชูุฌุฏ ุญุฑูุงุช ุญุฏูุซุฉ</td></tr>`;
  qs('#supWrap').innerHTML = `
    <h4>ุฃุฑุตุฏุฉ ุงูุชุฌุงุฑ</h4>
    <table><thead><tr><th>ุงูุชุงุฌุฑ</th><th>ุงูุฑุตูุฏ (ูุฏููููุฉ)</th><th>ุฅุฌุฑุงุก</th></tr></thead><tbody>${rows}</tbody></table>
    <h4 style="margin-top:12px">ุขุฎุฑ ุงูุญุฑูุงุช</h4>
    <table><thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูุงุณู</th><th>ุงูููุน</th><th>ุงููุจูุบ</th><th>ููุงุญุธุฉ</th><th>ุฅุฌุฑุงุก</th></tr></thead>
    <tbody>${txRows}</tbody></table>`;
}
function addSupplierInvoice(){
  const name=(qs('#supName').value||'').trim(), amt=parseFloat(qs('#supInvoice').value||'0');
  if(!name||!amt){alert('ุฃุฏุฎู ุงุณู ููููุฉ ูุงุชูุฑุฉ ุตุญูุญุฉ');return}
  const S=getSuppliers(); if(!S.people) S.people={}; if(!S.people[name]) S.people[name]={balance:0,history:[]};
  S.people[name].balance += amt;
  S.people[name].history.push({id:uid(), date:todayISO(), type:'invoice', amount:amt, note:'ูุงุชูุฑุฉ ูุดุชุฑูุงุช'}); saveSuppliers(S);
  qs('#supName').value=''; qs('#supInvoice').value=''; renderSuppliers();
}
function paySupplier(){
  const name=(qs('#supPayName').value||'').trim(), amt=parseFloat(qs('#supPayAmount').value||'0'), src=qs('#supPaySource').value;
  if(!name||!amt){alert('ุฃุฏุฎู ุงุณู ููุจูุบ ุตุญูุญ');return}
  const S=getSuppliers(); if(!S.people||!S.people[name]){alert('ูุง ููุฌุฏ ูุฐุง ุงูุชุงุฌุฑ');return}
  S.people[name].balance -= amt;
  const d=getStoreData(); const type=(src==='bank')?'ุจูู':'ูุงุด';
  d.expenses.push({id:uid(),date:todayISO(),type,desc:`ุฏูุนุฉ ุชุงุฌุฑ (${name})`,amount:amt,note:(src==='owner'?'ูู ุตูุฏูู ุงููุงูู':(src==='bank'?'ูู ุงูุจูู':'ูู ูุงุด ุงููุญู'))});
  saveStoreData(d);
  if(src==='owner'){ const O=getOwner(); O.ledger.push({id:uid(),date:todayISO(),type:'out',amount:amt,note:`ุฏูุนุฉ ุชุงุฌุฑ (${name})`, linked:true}); saveOwner(O); updateOwnerBalanceUI(); }
  S.people[name].history.push({id:uid(),date:todayISO(),type:'pay',amount:amt,note:`ุฏูุนุฉ ูู ${src==='owner'?'ุตูุฏูู ุงููุงูู':(src==='bank'?'ุงูุจูู':'ูุงุด ุงููุญู')}`}); saveSuppliers(S);
  qs('#supPayName').value=''; qs('#supPayAmount').value=''; renderSuppliers(); renderLists(); renderOwnerStatement();
}
function deleteSupplierHistory(name, histId){
  const S=getSuppliers(); if(!S.people||!S.people[name]) return;
  const i=(S.people[name].history||[]).findIndex(h=>h.id===histId); if(i===-1) return;
  const rec=S.people[name].history[i];
  if(rec.type==='invoice'){ S.people[name].balance -= Number(rec.amount||0); }
  if(rec.type==='pay'){ S.people[name].balance += Number(rec.amount||0); }
  S.people[name].history.splice(i,1); saveSuppliers(S); renderSuppliers();
}
function deleteSupplierPerson(name){
  if(!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุชุงุฌุฑ "${name}" ูุฌููุน ูุนุงููุงุชูุ ูุง ูููู ุงูุชุฑุงุฌุน.`)) return;
  const S=getSuppliers(); if(S.people && S.people[name]){ delete S.people[name]; saveSuppliers(S); renderSuppliers(); refreshNameLists(); alert('ุชู ุงูุญุฐู ุจูุฌุงุญ'); }
}
/* ูุดู ุชุงุฌุฑ */
function renderSupplierStatement(){
  const name=(qs('#supStmtName').value||'').trim(), from=qs('#supStmtFrom').value, to=qs('#supStmtTo').value;
  const S=getSuppliers(); if(!name || !S.people || !S.people[name]){alert('ุงุฎุชุฑ ุงุณู ุชุงุฌุฑ ุตุญูุญ');return}
  const hist=(S.people[name].history||[]).filter(h=>inRange(h.date,from,to));
  const rows=hist.length?hist.map(h=>{
    const kind = h.type==='invoice'?'ูุงุชูุฑุฉ (+)':(h.type==='pay'?'ุฏูุนุฉ (โ)':'ุฃุฎุฑู');
    return `<tr><td>${h.date||''}</td><td>${kind}</td><td>${h.amount||0}</td><td>${h.note||''}</td></tr>`;
  }).join(''):`<tr><td colspan="4">ูุง ุชูุฌุฏ ุญุฑูุงุช</td></tr>`;
  const bal=S.people[name].balance||0;
  qs('#supplierStatementWrap').innerHTML=`
    <div class="page">
      <h2 style="margin:0 0 8px">ูุดู ุงูุชุงุฌุฑ โ ${name}</h2>
      <div class="hint">ุงููุชุฑุฉ: <b>${from||'โ'}</b> โ <b>${to||'โ'}</b> โ ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: <b>${todayISO()}</b></div>
      <div class="separator"></div>
      <table><thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูููุน</th><th>ุงููุจูุบ</th><th>ุงูููุงุญุธุฉ</th></tr></thead><tbody>${rows}</tbody></table>
      <div style="margin-top:8px"><b>ุงูุฑุตูุฏ ุงูุญุงูู (ูุฏููููุฉ):</b> ${bal}</div>
      <div style="margin-top:40px;display:flex;justify-content:space-between"><div>ุชูููุน ุงููุงูู: ุนุจุฏ ุงููู ุฃุจู ุนูุถ ____________________</div><div>ุชูููุน ุงููุฏูุฑ ุงููุงูู: ____________________</div></div>
    </div>`;
}

/* ุงูุฏููู (ุนููุงุก) */
function renderDebts(){
  const D=getDebts(), names=Object.keys(D.people||{});
  if(!names.length){qs('#debtsWrap').innerHTML='<div class="hint">ูุง ุชูุฌุฏ ุฏููู ูุณุฌูุฉ</div>';refreshNameLists?.();return}
  const rows=names.map(n=>`<tr>
      <td>${n}</td>
      <td>${D.people[n].balance||0}</td>
      <td><button class="btn btn-danger" onclick="deleteDebtor('${n.replace(/'/g,"\\'")}')">๐ ุญุฐู</button></td>
    </tr>`).join('');
  const allTx=[]; names.forEach(n=>{(D.people[n].history||[]).slice(-50).forEach(h=>allTx.push({name:n,...h}))}); allTx.sort((a,b)=>(a.date||'').localeCompare(b.date||'')); allTx.reverse();
  const txRows = allTx.length ? allTx.map(h=>{
    const kind = h.type==='debt' ? 'ุชุณุฌูู ุฏูู (+)' : (h.type==='pay' ? `ุณุฏุงุฏ ุฏูู (โ)` : (h.type==='revert' ? 'ุฅูุบุงุก/ุงุณุชุฑุฌุงุน' : (h.type||'')));
    const btn  = `<button class="btn btn-danger" onclick="deleteDebtHistory('${h.name.replace(/'/g,"\\'")}','${h.id||''}')">ุญุฐู ุงูููุฏ</button>`;
    return `<tr><td>${h.date||''}</td><td>${h.name}</td><td>${kind}</td><td>${h.amount||0}</td><td>${h.note||''}</td><td>${btn}</td></tr>`;
  }).join('') : `<tr><td colspan="6">ูุง ุชูุฌุฏ ุญุฑูุงุช ุญุฏูุซุฉ</td></tr>`;
  qs('#debtsWrap').innerHTML = `
    <h4>ุฃุฑุตุฏุฉ ุงูุนููุงุก</h4>
    <table><thead><tr><th>ุงูุนููู</th><th>ุงูุฑุตูุฏ (ูุฏูู)</th><th>ุฅุฌุฑุงุก</th></tr></thead><tbody>${rows}</tbody></table>
    <h4 style="margin-top:12px">ุขุฎุฑ ุงูุญุฑูุงุช</h4>
    <table><thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูุงุณู</th><th>ุงูููุน</th><th>ุงููุจูุบ</th><th>ููุงุญุธุฉ</th><th>ุฅุฌุฑุงุก</th></tr></thead>
    <tbody>${txRows}</tbody></table>`;
}
function addDebt(){
  const name=(qs('#debtorName').value||'').trim(), amt=parseFloat(qs('#debtAmount').value||'0'), note=(qs('#debtNote').value||'').trim();
  if(!name||!amt){alert('ุฃุฏุฎู ุงุณู ููููุฉ ุฏูู ุตุญูุญุฉ');return}
  const D=getDebts(); if(!D.people) D.people={};
  if(!D.people[name]) D.people[name]={balance:0,history:[]};
  D.people[name].balance += amt;
  D.people[name].history.push({id:uid(),date:todayISO(),type:'debt',amount:amt,note:note||'ุฏูู ูุดุชุฑูุงุช'});
  saveDebts(D);
  qs('#debtorName').value=''; qs('#debtAmount').value=''; qs('#debtNote').value='';
  renderDebts();
}
function payDebt(){
  const name=(qs('#debtPayName').value||'').trim(), amt=parseFloat(qs('#debtPayAmount').value||'0'), method=qs('#debtPayMethod').value;
  if(!name||!amt){alert('ุฃุฏุฎู ุงุณู ููุจูุบ ุณุฏุงุฏ ุตุญูุญ');return}
  const D=getDebts(); if(!D.people||!D.people[name]){alert('ูุง ููุฌุฏ ูุฐุง ุงูุนููู');return}
  D.people[name].balance -= amt;
  const saleId=uid(); // ุฑุจุท ูุน ุงููุจูุนุงุช
  D.people[name].history.push({id:uid(),date:todayISO(),type:'pay',amount:amt,note:`ุณุฏุงุฏ ุฏูู (${method})`, linkedSaleId:saleId});
  saveDebts(D);
  const d=getStoreData();
  d.sales.push({id:saleId,date:todayISO(),type:method,amount:amt,note:`ุณุฏุงุฏ ุฏูู (${name})`});
  saveStoreData(d);
  qs('#debtPayName').value=''; qs('#debtPayAmount').value=''; renderDebts(); renderLists();
}
function deleteDebtHistory(name, histId){
  const D=getDebts(); if(!D.people||!D.people[name]) return;
  const i=(D.people[name].history||[]).findIndex(h=>h.id===histId); if(i===-1) return;
  const rec=D.people[name].history[i];
  if(rec.type==='debt'){ D.people[name].balance -= Number(rec.amount||0); }
  if(rec.type==='pay'){
    D.people[name].balance += Number(rec.amount||0);
    if(rec.linkedSaleId){
      const d=getStoreData(); const j=(d.sales||[]).findIndex(s=>s.id===rec.linkedSaleId);
      if(j>-1){ d.sales.splice(j,1); saveStoreData(d); renderLists?.(); }
    }
  }
  D.people[name].history.splice(i,1); saveDebts(D); renderDebts();
}
function deleteDebtor(name){
  if(!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุนููู "${name}" ูุฌููุน ูุนุงููุงุชูุ ูุง ูููู ุงูุชุฑุงุฌุน.`)) return;
  const D=getDebts(); if(D.people && D.people[name]){ delete D.people[name]; saveDebts(D); renderDebts(); refreshNameLists(); alert('ุชู ุงูุญุฐู ุจูุฌุงุญ'); }
}
/* ูุดู ุนููู ูุฏูู */
function renderDebtStatement(){
  const name=(qs('#debtStmtName').value||'').trim(), from=qs('#debtStmtFrom').value, to=qs('#debtStmtTo').value;
  const D=getDebts(); if(!name || !D.people || !D.people[name]){alert('ุงุฎุชุฑ ุงุณู ุนููู ุตุญูุญ');return}
  const hist=(D.people[name].history||[]).filter(h=>inRange(h.date,from,to));
  const rows=hist.length?hist.map(h=>{
    const kind = h.type==='debt'?'ุฏูู (+)':(h.type==='pay'?'ุณุฏุงุฏ (โ)':'ุฃุฎุฑู');
    return `<tr><td>${h.date||''}</td><td>${kind}</td><td>${h.amount||0}</td><td>${h.note||''}</td></tr>`;
  }).join(''):`<tr><td colspan="4">ูุง ุชูุฌุฏ ุญุฑูุงุช</td></tr>`;
  const bal=D.people[name].balance||0;
  qs('#debtStatementWrap').innerHTML=`
    <div class="page">
      <h2 style="margin:0 0 8px">ูุดู ุงูุนููู โ ${name}</h2>
      <div class="hint">ุงููุชุฑุฉ: <b>${from||'โ'}</b> โ <b>${to||'โ'}</b> โ ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: <b>${todayISO()}</b></div>
      <div class="separator"></div>
      <table><thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูููุน</th><th>ุงููุจูุบ</th><th>ุงูููุงุญุธุฉ</th></tr></thead><tbody>${rows}</tbody></table>
      <div style="margin-top:8px"><b>ุงูุฑุตูุฏ ุงูุญุงูู (ูุฏูู):</b> ${bal}</div>
      <div style="margin-top:40px;display:flex;justify-content:space-between"><div>ุชูููุน ุงููุงูู: ุนุจุฏ ุงููู ุฃุจู ุนูุถ ____________________</div><div>ุชูููุน ุงููุฏูุฑ ุงููุงูู: ____________________</div></div>
    </div>`;
}

/* ุชูุงุฑูุฑ ุงููุญูุงุช */
function calcTotals(entries,typeKey='type'){const cs=entries.filter(x=>x[typeKey]==='ูุงุด').reduce((a,b)=>a+Number(b.amount||0),0);const bs=entries.filter(x=>x[typeKey]==='ุจูู').reduce((a,b)=>a+Number(b.amount||0),0);return{cs,bs}}
function fmtDatePretty(iso){const d=new Date(iso+"T00:00:00");const days=["ุงูุฃุญุฏ","ุงูุฅุซููู","ุงูุซูุงุซุงุก","ุงูุฃุฑุจุนุงุก","ุงูุฎููุณ","ุงูุฌูุนุฉ","ุงูุณุจุช"];const pad=n=>String(n).padStart(2,"0");return `${days[d.getDay()]} ${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}
function generateDaily(){
  const date=qs('#r_date').value||todayISO();const store=qs('#r_store').value||currentStore;
  const d=JSON.parse(localStorage.getItem(store)||'{"sales":[],"expenses":[]}');
  const s=d.sales.filter(x=>x.date===date), e=d.expenses.filter(x=>x.date===date);
  const ts=calcTotals(s), te=calcTotals(e);
  const salesCash=ts.cs, salesBank=ts.bs, expCash=te.cs, expBank=te.bs;
  const netCash=salesCash-expCash, netBank=salesBank-expBank;
  const salesRows=s.map(x=>`<tr><td>${x.date}</td><td>${x.type}</td><td>${x.amount}</td><td>${x.note||''}</td></tr>`).join('')||'<tr><td colspan="4">ูุง ููุฌุฏ ูุจูุนุงุช</td></tr>';
  const expRows=e.map(x=>`<tr><td>${x.date}</td><td>${x.type}</td><td>${x.desc||''}</td><td>${x.amount}</td><td>${(x.benefType&&x.benefName)?(x.benefType==='supplier'?'ุชุงุฌุฑ: ':'ูุณูู: ')+x.benefName:(x.note||'')}</td></tr>`).join('')||'<tr><td colspan="5">ูุง ููุฌุฏ ูุตุงุฑูู</td></tr>';
  qs('#dailyWrap').innerHTML=`<div class="page">
    <h2 style="margin:0 0 8px">ุงูุชูุฑูุฑ ุงููููู โ ${stores[store]}</h2>
    <div class="hint">ุชุงุฑูุฎ ุงูุชูุฑูุฑ: <b>${fmtDatePretty(date)}</b> โ ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: <b>${fmtDatePretty(todayISO())}</b></div>
    <div class="separator"></div>
    <div class="kpi">
      <div class="box"><b>${salesCash}</b>ูุจูุนุงุช ูุงุด</div>
      <div class="box"><b>${salesBank}</b>ูุจูุนุงุช ุจูู</div>
      <div class="box"><b>${expCash}</b>ูุตุฑููุงุช ูุงุด</div>
      <div class="box"><b>${expBank}</b>ูุตุฑููุงุช ุจูู</div>
    </div>
    <div class="subtle" style="margin-top:10px"><b>ุงูุตุงูู:</b>
      <span style="margin-inline-start:8px">ุตุงูู ุงููุงุด = <b>${netCash}</b></span>
      <span style="margin-inline-start:16px">ุตุงูู ุงูุจูู = <b>${netBank}</b></span>
    </div>
    <h3>ุชูุงุตูู ุงููุจูุนุงุช</h3>
    <table><thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูููุน</th><th>ุงููุจูุบ</th><th>ููุงุญุธุงุช</th></tr></thead><tbody>${salesRows}</tbody></table>
    <h3>ุชูุงุตูู ุงููุตุงุฑูู</h3>
    <table><thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูููุน</th><th>ุงููุตู</th><th>ุงููุจูุบ</th><th>ููุงุญุธุงุช/ุฑุจุท</th></tr></thead><tbody>${expRows}</tbody></table>
    <div style="margin-top:40px;display:flex;justify-content:space-between"><div>ุชูููุน ุงููุงูู: ุนุจุฏ ุงููู ุฃุจู ุนูุถ ____________________</div><div>ุชูููุน ุงููุฏูุฑ ุงููุงูู: ____________________</div></div>
  </div>`;
}
function generateRange(){
  const from=qs('#f_from').value||todayISO().slice(0,8)+'01', to=qs('#f_to').value||todayISO(), mode=qs('#f_mode').value||'per';
  const shops=Object.keys(stores);
  if(mode==='all'){
    let allSales=[],allExp=[];shops.forEach(st=>{const d=getStoreData(st);allSales=allSales.concat(d.sales.filter(x=>inRange(x.date,from,to)));allExp=allExp.concat(d.expenses.filter(x=>inRange(x.date,from,to)))});const ts=calcTotals(allSales), te=calcTotals(allExp);const net=(ts.cs+ts.bs)-(te.cs+te.bs);
    qs('#rangeWrap').innerHTML=`<div class="page"><h2 style="margin:0 0 8px">ุชูุฑูุฑ ูุฌููุน โ ูู ุงููุญูุงุช</h2><div class="hint">ุงููุชุฑุฉ: <b>${from}</b> โ <b>${to}</b> โ ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: <b>${fmtDatePretty(todayISO())}</b></div><div class="separator"></div><table><thead><tr><th>ุงููุคุดุฑ</th><th>ุงููููุฉ</th></tr></thead><tbody><tr><td>ูุจูุนุงุช ูุงุด</td><td>${ts.cs}</td></tr><tr><td>ูุจูุนุงุช ุจูู</td><td>${ts.bs}</td></tr><tr><td>ูุตุฑููุงุช ูุงุด</td><td>${te.cs}</td></tr><tr><td>ูุตุฑููุงุช ุจูู</td><td>${te.bs}</td></tr><tr><td><b>ุงูุตุงูู</b></td><td><b>${net}</b></td></tr></tbody></table><div style="margin-top:40px;display:flex;justify-content:space-between"><div>ุชูููุน ุงููุงูู: ุนุจุฏ ุงููู ุฃุจู ุนูุถ ____________________</div><div>ุชูููุน ุงููุฏูุฑ ุงููุงูู: ____________________</div></div></div>`;
  }else{
    let html='';shops.forEach(st=>{const d=getStoreData(st);const s=d.sales.filter(x=>inRange(x.date,from,to)), e=d.expenses.filter(x=>inRange(x.date,from,to));const ts=calcTotals(s), te=calcTotals(e);const net=(ts.cs+ts.bs)-(te.cs+te.bs);
      html+=`<div class="page"><h2 style="margin:0 0 8px">ุชูุฑูุฑ ูุชุฑุฉ โ ${stores[st]}</h2><div class="hint">ุงููุชุฑุฉ: <b>${from}</b> โ <b>${to}</b> โ ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: <b>${fmtDatePretty(todayISO())}</b></div><div class="separator"></div><table><thead><tr><th>ุงููุคุดุฑ</th><th>ุงููููุฉ</th></tr></thead><tbody><tr><td>ูุจูุนุงุช ูุงุด</td><td>${ts.cs}</td></tr><tr><td>ูุจูุนุงุช ุจูู</td><td>${ts.bs}</td></tr><tr><td>ูุตุฑููุงุช ูุงุด</td><td>${te.cs}</td></tr><tr><td>ูุตุฑููุงุช ุจูู</td><td>${te.bs}</td></tr><tr><td><b>ุงูุตุงูู</b></td><td><b>${net}</b></td></tr></tbody></table><div style="margin-top:40px;display:flex;justify-content:space-between"><div>ุชูููุน ุงููุงูู: ุนุจุฏ ุงููู ุฃุจู ุนูุถ ____________________</div><div>ุชูููุน ุงููุฏูุฑ ุงููุงูู: ____________________</div></div></div>`;
    });qs('#rangeWrap').innerHTML=html;
  }
}

/* ุตูุฏูู ุงููุงูู */
function updateOwnerBalanceUI(){const O=getOwner();const ins=sum(O.ledger||[],x=>x.type==='in'?Number(x.amount||0):0);const outs=sum(O.ledger||[],x=>x.type==='out'?Number(x.amount||0):0);qs('#ownerBalanceVal').textContent=(ins-outs)}
function settleDay(){
  const day=(qs('#todayInput').value||todayISO()), d=getStoreData();
  const cashSales=d.sales.filter(x=>x.date===day && x.type==='ูุงุด').reduce((a,b)=>a+Number(b.amount||0),0);
  const cashExp  =d.expenses.filter(x=>x.date===day && x.type==='ูุงุด').reduce((a,b)=>a+Number(b.amount||0),0);
  const net=cashSales-cashExp; const O=getOwner();
  for(let i=O.ledger.length-1;i>=0;i--){const e=O.ledger[i];if(e.date===day && e.type==='in' && String(e.note||'').includes(`ุชุฑุญูู ูุงุด ุงูููู ูู ${stores[currentStore]}`)){O.ledger.splice(i,1)}}
  if(net>0){O.ledger.push({id:uid(),date:day,type:'in',amount:+net,note:`ุชุฑุญูู ูุงุด ุงูููู ูู ${stores[currentStore]}`, linked:false});}
  saveOwner(O); updateOwnerBalanceUI(); renderOwnerStatement();
}
function ownerDeposit(){
  const a=parseFloat(qs('#ownerInAmt').value||'0'), note=(qs('#ownerInNote').value||'').trim();
  if(!a){alert('ุฃุฏุฎู ูุจูุบ ุตุญูุญ');return}
  const O=getOwner(); O.ledger.push({id:uid(),date:todayISO(),type:'in',amount:a,note:note||'ุฅูุฏุงุน ูุฏูู',linked:false}); saveOwner(O);
  qs('#ownerInAmt').value=''; qs('#ownerInNote').value=''; updateOwnerBalanceUI(); renderOwnerStatement();
}
function ownerWithdraw(){
  const a=parseFloat(qs('#ownerOutAmt').value||'0'), note=(qs('#ownerOutNote').value||'').trim();
  if(!a){alert('ุฃุฏุฎู ูุจูุบ ุตุญูุญ');return}
  const O=getOwner(); O.ledger.push({id:uid(),date:todayISO(),type:'out',amount:a,note:note||'ุณุญุจ ูุฏูู',linked:false}); saveOwner(O);
  qs('#ownerOutAmt').value=''; qs('#ownerOutNote').value=''; updateOwnerBalanceUI(); renderOwnerStatement();
}
function deleteOwnerEntry(id){
  const O=getOwner(); const i=(O.ledger||[]).findIndex(x=>x.id===id); if(i===-1) return;
  const e=O.ledger[i];
  if(e.linked){
    if(!confirm('ูุฐุง ุงูููุฏ ูุฑุชุจุท ุจุฏูุนุฉ ุชุงุฌุฑ/ุณููุฉ ูู ุงูุตูุฏูู. ุญุฐูู ูู ููุฑุฌุน ุงูุฏูุนุฉ ุชููุงุฆููุง. ูุชุงุจุนุฉุ')) return;
  }else{
    if(!confirm('ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงูููุฏ ูู ุตูุฏูู ุงููุงููุ')) return;
  }
  O.ledger.splice(i,1); saveOwner(O); updateOwnerBalanceUI(); renderOwnerStatement();
}
function renderOwnerStatement(){
  const from=(qs('#of_from').value||todayISO().slice(0,8)+'01'), to=(qs('#of_to').value||todayISO());
  const O=getOwner(); const rows=(O.ledger||[]).filter(x=>inRange(x.date,from,to));
  const ins=sum(rows,x=>x.type==='in'?Number(x.amount||0):0), outs=sum(rows,x=>x.type==='out'?Number(x.amount||0):0);
  const tbl=rows.length?rows.map(e=>`<tr><td>${e.date}</td><td>${e.type==='in'?'ุชุญุตูู':'ุตุฑู'}</td><td>${e.amount}</td><td>${e.note||''}</td><td><button class="btn btn-danger" onclick="deleteOwnerEntry('${e.id}')">ุญุฐู</button></td></tr>`).join(''):`<tr><td colspan="5">ูุง ุชูุฌุฏ ุญุฑูุงุช</td></tr>`;
  qs('#ownerWrap').innerHTML=`<div class="page"><h2 style="margin:0 0 8px">ูุดู ุตูุฏูู ุงููุงูู</h2><div class="hint">ุงููุชุฑุฉ: <b>${from}</b> โ <b>${to}</b> โ ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: <b>${todayISO()}</b></div><div class="separator"></div><table><thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูููุน</th><th>ุงููุจูุบ</th><th>ุงูููุงุญุธุฉ</th><th>ุฅุฌุฑุงุก</th></tr></thead><tbody>${tbl}</tbody></table><div style="margin-top:8px"><b>ุชุญุตูู:</b> ${ins} โ <b>ุตุฑู:</b> ${outs} โ <b>ุงูุฑุตูุฏ:</b> ${ins-outs}</div><div style="margin-top:40px;display:flex;justify-content:space-between"><div>ุชูููุน ุงููุงูู: ุนุจุฏ ุงููู ุฃุจู ุนูุถ ____________________</div><div>ุชูููุน ุงููุฏูุฑ ุงููุงูู: ____________________</div></div></div>`;
}
function generateMonthly(){
  const ym=(qs('#m_month').value||todayISO().slice(0,7));
  let allSales=[],allExp=[];
  Object.keys(stores).forEach(st=>{const d=getStoreData(st);allSales=allSales.concat(d.sales.filter(x=>x.date.slice(0,7)===ym));allExp=allExp.concat(d.expenses.filter(x=>x.date.slice(0,7)===ym));});
  const ts=calcTotals(allSales), te=calcTotals(allExp), net=(ts.cs+ts.bs)-(te.cs+te.bs);
  const O=getOwner(); const rows=(O.ledger||[]).filter(x=>x.date.slice(0,7)===ym);
  const ins=sum(rows,x=>x.type==='in'?Number(x.amount||0):0), outs=sum(rows,x=>x.type==='out'?Number(x.amount||0):0);
  qs('#monthlyWrap').innerHTML=`<div class="page"><h2 style="margin:0 0 8px">ุชูุฑูุฑ ุดูุฑู ูุฌููุน โ ${ym}</h2><div class="hint">ูู ุงููุญูุงุช + ุตูุฏูู ุงููุงูู โ ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: <b>${todayISO()}</b></div><div class="separator"></div><table><thead><tr><th>ุงููุคุดุฑ</th><th>ุงููููุฉ</th></tr></thead><tbody><tr><td>ูุจูุนุงุช ูุงุด</td><td>${ts.cs}</td></tr><tr><td>ูุจูุนุงุช ุจูู</td><td>${ts.bs}</td></tr><tr><td>ูุตุฑููุงุช ูุงุด</td><td>${te.cs}</td></tr><tr><td>ูุตุฑููุงุช ุจูู</td><td>${te.bs}</td></tr><tr><td><b>ุตุงูู (ุงููุญูุงุช)</b></td><td><b>${net}</b></td></tr><tr><td>ุชุญุตููุงุช ุตูุฏูู ุงููุงูู</td><td>${ins}</td></tr><tr><td>ูุตุฑููุงุช ุตูุฏูู ุงููุงูู</td><td>${outs}</td></tr><tr><td><b>ุฑุตูุฏ ุตูุฏูู ุงููุงูู ุฎูุงู ุงูุดูุฑ</b></td><td><b>${ins-outs}</b></td></tr></tbody></table><div style="margin-top:40px;display:flex;justify-content:space-between"><div>ุชูููุน ุงููุงูู: ุนุจุฏ ุงููู ุฃุจู ุนูุถ ____________________</div><div>ุชูููุน ุงููุฏูุฑ ุงููุงูู: ____________________</div></div></div>`;
}

/* ุนุฑุถ ุงูููุงุฆู */
function renderSalesList(){
  const d=getStoreData(); const rs=d.sales.slice(-30).reverse();
  qs('#recentSales').innerHTML=rs.length?rs.map(v=>`<div class="item"><div class="meta">${v.date} โ <b>${v.type}</b> โ ${v.note||''}</div><div><b>${v.amount}</b></div><div><button class="btn btn-danger" onclick="deleteSale('${v.id}')">ุญุฐู</button></div></div>`).join(''):'<div class="hint">ูุง ุชูุฌุฏ ูุจูุนุงุช ุจุนุฏ</div>';
}
function renderExpensesList(){
  const d=getStoreData(); const re=d.expenses.slice(-30).reverse();
  qs('#recentExpenses').innerHTML=re.length?re.map(v=>{
    const link = (v.benefType && v.benefName) ? ` โ <b>ููุฌูู ุฅูู: ${v.benefType==='supplier'?'ุชุงุฌุฑ':'ูุณูู'} (${v.benefName})</b>` : '';
    return `<div class="item"><div class="meta">${v.date} โ <b>${v.type}</b> โ ${v.desc}${link} ${v.note?(' โ <i>'+v.note+'</i>'):''}</div><div><b>${v.amount}</b></div><div><button class="btn btn-danger" onclick="deleteExpense('${v.id}')">ุญุฐู</button></div></div>`;
  }).join(''):'<div class="hint">ูุง ุชูุฌุฏ ูุตุงุฑูู ุจุนุฏ</div>';
}
function renderLists(){renderSalesList();renderExpensesList()}
function renderAll(){renderLists();renderLoans();renderSuppliers();renderDebts();updateOwnerBalanceUI();refreshNameLists()}

/* ูุณุฎ ุงุญุชูุงุทู */
function exportBackup(){
  const payload={version:"final-full-print-1",at:new Date().toISOString(),
    stores:{store1:JSON.parse(localStorage.getItem('store1')||'{"sales":[],"expenses":[]}'),
            store2:JSON.parse(localStorage.getItem('store2')||'{"sales":[],"expenses":[]}'),
            store3:JSON.parse(localStorage.getItem('store3')||'{"sales":[],"expenses":[]}')},
    loans:getLoans(),suppliers:getSuppliers(),debts:getDebts(),owner_fund:getOwner()};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a=document.createElement("a"); const ts=new Date(); const pad=n=>String(n).padStart(2,'0');
  a.href=URL.createObjectURL(blob); a.download=`backup-${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}-${pad(ts.getHours())}${pad(ts.getMinutes())}.json`;
  document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
}
function importBackup(file){
  if(!file){alert("ุงุฎุชุฑ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ");return}
  const r=new FileReader();
  r.onload=e=>{try{
    const data=JSON.parse(e.target.result);
    if(!data||!data.stores)throw new Error("ููู ุบูุฑ ุตุงูุญ");
    localStorage.setItem('store1',JSON.stringify(data.stores.store1||{"sales":[],"expenses":[]}));
    localStorage.setItem('store2',JSON.stringify(data.stores.store2||{"sales":[],"expenses":[]}));
    localStorage.setItem('store3',JSON.stringify(data.stores.store3||{"sales":[],"expenses":[]}));
    localStorage.setItem('owner_fund',JSON.stringify(data.owner_fund||{"ledger":[]}));
    localStorage.setItem('loans',JSON.stringify(data.loans||{"people":{}}));
    localStorage.setItem('suppliers',JSON.stringify(data.suppliers||{"people":{}}));
    localStorage.setItem('debts',JSON.stringify(data.debts||{"people":{}}));
    renderAll(); renderOwnerStatement();
  }catch(err){alert("ุชุนุฐุฑ ุงูุงุณุชูุฑุงุฏ: "+err.message)}};
  r.readAsText(file);
}

/* ุชููุฆุฉ */
document.addEventListener('DOMContentLoaded',()=>{
  const t=todayISO();
  ['todayInput','r_date','of_from','f_from'].forEach(id=>{const x=qs('#'+id); if(x) x.value=t;});
  const x1=qs('#of_to'); if(x1) x1.value=t; const x2=qs('#f_to'); if(x2) x2.value=t;
  showTab('input'); renderAll(); renderOwnerStatement();
});
</script>

<!-- (ุงุฎุชูุงุฑู) ุชูุนูู PWA ุฅู ูุงู ูุฏูู sw.js ู manifest ูู ููุณ ุงููุฌูุฏ
<script>
if("serviceWorker" in navigator){
  window.addEventListener("load",()=>{
    navigator.serviceWorker.register("./sw.js")
      .then(()=>console.log("SWโ"))
      .catch(e=>console.error("SWโ",e));
  });
}
</script>
-->
</body>
</html>
