<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>نظام المحاسبة — النهائي (أوفلاين)</title>
  <meta name="theme-color" content="#87b9ff"/>
  <link rel="manifest" href="./manifest.webmanifest">
  <style>
  :root{
    --blue:#2b7bff;       /* أزرق رئيسي */
    --blue-soft:#eaf3ff;  /* أزرق سماوي فاتح للخلفية */
    --line:#e5e7eb;
    --card:#fff;
    --danger:#dc3545;
    --ok:#16a34a;
    --muted:#64748b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Tahoma,Arial,sans-serif;background:var(--blue-soft);color:#0f172a}
  header{position:sticky;top:0;z-index:10;background:var(--blue);color:#fff;padding:10px 14px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
  header h1{margin:0;font-size:18px}
  header .sub{opacity:.95;font-size:13px}
  header .owner-badge{margin-top:6px;font-size:14px;color:#eaf5ff;background:rgba(255,255,255,.12);display:inline-block;padding:6px 10px;border-radius:10px}
  main{padding:12px;max-width:1150px;margin:auto;padding-bottom:160px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 1px 6px rgba(0,0,0,.04)}
  h3{margin:6px 0 10px}
  .row{display:flex;flex-wrap:wrap;gap:10px}
  .col{flex:1;min-width:200px}
  label{font-size:13px;color:#111}
  input,select,textarea,button{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:16px;background:#fff}
  textarea{min-height:70px;resize:vertical}
  button{border:none;cursor:pointer}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border-radius:12px;padding:10px 14px;font-size:14px}
  .btn-primary{background:var(--blue);color:#fff}
  .btn-outline{background:#fff;border:1px solid var(--line);color:#111}
  .btn-danger{background:var(--danger);color:#fff}
  .btn-ok{background:var(--ok);color:#fff}
  .hint{font-size:12px;color:var(--muted)}
  .list .item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 0;border-bottom:1px dashed var(--line)}
  .list .item:last-child{border-bottom:none}
  .list .meta{flex:1}
  .kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  .kpi .box{background:#f3f7ff;border:1px solid #e3ecff;border-radius:12px;padding:10px;text-align:center}
  .kpi .box b{display:block;font-size:16px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid var(--line);padding:8px;text-align:center;font-size:14px}
  th{background:#f8fbff}
  .tabs{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--line);display:flex}
  .tab{flex:1}
  .tab button{width:100%;background:#fff;border:none;padding:12px 0}
  .tab.active{background:#f0f6ff}
  .tag{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px}
  .subtle{background:#f9fbff;border:1px solid #eef2ff;border-radius:12px;padding:10px;margin-top:8px}
  .separator{height:1px;background:var(--line);margin:8px 0}
  .badge{display:inline-block;padding:.25rem .6rem;border-radius:999px;border:1px solid #dbeafe;background:#eff6ff;font-size:12px}
  @media print{
    header,nav.tabs,.print-hide{display:none !important}
    body{background:#fff}
    .card{box-shadow:none;border:none;padding:0;margin:0}
    .page{page-break-after:always;margin-bottom:30px}
  }
  </style>
</head>
<body>
<header class="print-hide">
  <h1>نظام المحاسبة</h1>
  <div class="sub">المالك: <b>عبد الله أبو عوض</b></div>
  <div class="owner-badge">رصيد صندوق المالك: <b id="ownerBalanceVal">0</b></div>
</header>

<main>
  <div class="card print-hide">
    <div class="row">
      <div class="col">
        <label>المحل</label>
        <select id="storeSelect" onchange="changeStore()">
          <option value="store1">روان بيبي</option>
          <option value="store2">جنتل بيبي عبود</option>
          <option value="store3">بسطة</option>
        </select>
      </div>
      <div class="col">
        <label>تاريخ اليوم</label>
        <input type="date" id="todayInput"/>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button class="btn btn-primary" onclick="settleDay()">تسوية اليوم لصندوق المالك</button>
      </div>
    </div>
    <div class="hint">تعمل بدون إنترنت — الحفظ تلقائي محليًا. يحتوي على تصدير/استيراد نسخة احتياطية من تبويب “المالك”.</div>
  </div>

  <section class="card" data-tab="input">
    <h3>تسجيل المبيعات</h3>
    <div class="row">
      <div class="col"><input type="number" id="saleAmount" placeholder="المبلغ"></div>
      <div class="col"><select id="saleType"><option value="كاش">كاش</option><option value="بنك">بنك</option></select></div>
      <div class="col"><input type="text" id="saleNote" placeholder="ملاحظات (اسم المشتري/الصنف/جوال)"></div>
      <div class="col"><button class="btn btn-ok" onclick="addSale()">➕ إضافة بيع</button></div>
    </div>
    <div id="recentSales" class="list"></div>

    <h3 style="margin-top:18px">تسجيل المصاريف</h3>
    <div class="row">
      <div class="col"><input type="text" id="expenseDesc" placeholder="وصف المصروف"></div>
      <div class="col"><input type="number" id="expenseAmount" placeholder="المبلغ"></div>
      <div class="col"><select id="expenseType"><option value="كاش">كاش</option><option value="بنك">بنك</option></select></div>
      <div class="col"><input type="text" id="expenseNote" placeholder="ملاحظات (اختياري)"></div>
      <div class="col"><button class="btn btn-ok" onclick="addExpense()">➕ إضافة مصروف</button></div>
    </div>
    <div id="recentExpenses" class="list"></div>
  </section>

  <section class="card" data-tab="daily">
    <h3>التقرير اليومي</h3>
    <div class="row print-hide">
      <div class="col"><label>التاريخ</label><input type="date" id="r_date"></div>
      <div class="col"><label>المحل</label>
        <select id="r_store">
          <option value="store1">روان بيبي</option>
          <option value="store2">جنتل بيبي عبود</option>
          <option value="store3">بسطة</option>
        </select>
      </div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="generateDaily()">عرض التقرير</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection('dailyWrap')">🖨️ طباعة PDF</button></div>
    </div>
    <div id="dailyWrap"></div>
  </section>

  <section class="card" data-tab="range">
    <h3>تقرير فترة / مجمّع</h3>
    <div class="row print-hide">
      <div class="col"><label>من</label><input type="date" id="f_from"></div>
      <div class="col"><label>إلى</label><input type="date" id="f_to"></div>
      <div class="col"><label>النمط</label><select id="f_mode"><option value="per">منفصل لكل محل</option><option value="all">مجمّع للمحلات الثلاثة</option></select></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="generateRange()">عرض التقرير</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection('rangeWrap')">🖨️ طباعة PDF</button></div>
    </div>
    <div id="rangeWrap"></div>
  </section>

  <section class="card" data-tab="loans">
    <h3>السُلف (كاش فقط)</h3>
    <div class="row">
      <div class="col"><input type="text" id="loanPerson" placeholder="اسم المُسلف"></div>
      <div class="col"><input type="number" id="loanAmount" placeholder="مبلغ السلفة (+)"></div>
      <div class="col"><button class="btn btn-ok" onclick="addLoan()">➕ إضافة سلفة</button></div>
    </div>
    <div class="row">
      <div class="col"><input type="text" id="loanPayPerson" placeholder="اختر/اكتب نفس الاسم للسداد"></div>
      <div class="col"><input type="number" id="loanPayAmount" placeholder="مبلغ السداد (−)"></div>
      <div class="col"><select id="loanPaySource"><option value="store">من كاش المحل</option><option value="owner">من صندوق المالك</option></select></div>
      <div class="col"><button class="btn btn-primary" onclick="payLoan()">💸 تسجيل سداد</button></div>
    </div>
    <div id="loansWrap" class="subtle" style="margin-top:8px"></div>
  </section>

  <section class="card" data-tab="suppliers">
    <h3>التُجار</h3>
    <div class="row">
      <div class="col"><input type="text" id="supName" placeholder="اسم التاجر"></div>
      <div class="col"><input type="number" id="supInvoice" placeholder="قيمة الفاتورة (تزيد الدين)"></div>
      <div class="col"><button class="btn btn-ok" onclick="addSupplierInvoice()">➕ تسجيل فاتورة</button></div>
    </div>
    <div class="row">
      <div class="col"><input type="text" id="supPayName" placeholder="اختر/اكتب الاسم للدفع"></div>
      <div class="col"><input type="number" id="supPayAmount" placeholder="مبلغ الدفعة (يقلل الدين)"></div>
      <div class="col"><select id="supPaySource">
        <option value="store">من كاش المحل</option>
        <option value="owner">من صندوق المالك</option>
        <option value="bank">من حساب البنك</option>
      </select></div>
      <div class="col"><button class="btn btn-primary" onclick="paySupplier()">💳 تسجيل دفعة</button></div>
    </div>
    <div id="supWrap" class="subtle" style="margin-top:8px"></div>
  </section>

  <section class="card" data-tab="owner">
    <h3>صندوق المالك — كشف فوري وتقرير شهري</h3>
    <div class="row print-hide">
      <div class="col"><label>من</label><input type="date" id="of_from"></div>
      <div class="col"><label>إلى</label><input type="date" id="of_to"></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="renderOwnerStatement()">عرض الكشف</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection('ownerWrap')">🖨️ طباعة PDF</button></div>
    </div>
    <div id="ownerWrap"></div>

    <div class="subtle print-hide" style="margin-top:12px">
      <h4>تقرير شهري مجمّع (كل المحلات + صندوق المالك)</h4>
      <div class="row">
        <div class="col"><label>الشهر</label><input type="month" id="m_month"></div>
        <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="generateMonthly()">إنشاء التقرير الشهري</button></div>
        <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection('monthlyWrap')">🖨️ طباعة PDF</button></div>
      </div>
      <div id="monthlyWrap"></div>
    </div>

    <div class="subtle print-hide" style="margin-top:12px">
      <h4>نسخ احتياطي</h4>
      <div class="row">
        <div class="col"><button class="btn btn-outline" onclick="exportBackup()">⬇️ تصدير نسخة احتياطية</button></div>
        <div class="col">
          <label for="importFile" class="btn btn-ok" style="display:inline-block;cursor:pointer;text-align:center">⬆️ استيراد نسخة</label>
          <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importBackup(this.files[0])"/>
        </div>
      </div>
      <div class="hint">تشمل النسخة: المحلات، السلف، التجار، وصندوق المالك.</div>
    </div>
  </section>
</main>

<nav class="tabs print-hide">
  <div class="tab active"><button onclick="showTab('input')">إدخال</button></div>
  <div class="tab"><button onclick="showTab('daily')">يومي</button></div>
  <div class="tab"><button onclick="showTab('range')">فترة/مجمّع</button></div>
  <div class="tab"><button onclick="showTab('loans')">سُلف</button></div>
  <div class="tab"><button onclick="showTab('suppliers')">تُجار</button></div>
  <div class="tab"><button onclick="showTab('owner')">المالك</button></div>
</nav>

<script>
/* أدوات */
const stores = {store1:"روان بيبي", store2:"جنتل بيبي عبود", store3:"بسطة"};
let currentStore = "store1";
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
function todayISO(){ return new Date().toISOString().slice(0,10); }
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,7); }
function inRange(iso,from,to){ const d=new Date(iso+"T00:00:00"); return d>=new Date(from+"T00:00:00") && d<=new Date(to+"T00:00:00"); }
function sum(arr,fn){ return arr.reduce((a,b)=>a+fn(b),0); }
function fmtDatePretty(iso){const d=new Date(iso+"T00:00:00");const days=["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];const p=n=>String(n).padStart(2,"0");return `${days[d.getDay()]} ${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;}

/* تخزين */
function getStoreData(store=currentStore){ return JSON.parse(localStorage.getItem(store) || '{"sales":[],"expenses":[]}'); }
function saveStoreData(data,store=currentStore){ localStorage.setItem(store, JSON.stringify(data)); }
function getOwner(){ return JSON.parse(localStorage.getItem('owner_fund') || '{"ledger":[]}'); }
function saveOwner(v){ localStorage.setItem('owner_fund', JSON.stringify(v)); }
function getLoans(){ return JSON.parse(localStorage.getItem('loans') || '{"people":{}}'); }
function saveLoans(v){ localStorage.setItem('loans', JSON.stringify(v)); }
function getSuppliers(){ return JSON.parse(localStorage.getItem('suppliers') || '{"people":{}}'); }
function saveSuppliers(v){ localStorage.setItem('suppliers', JSON.stringify(v)); }

/* واجهة */
function changeStore(){ currentStore = qs('#storeSelect').value; renderLists(); }
function showTab(name){
  qsa('[data-tab]').forEach(el => el.style.display = (el.getAttribute('data-tab')===name ? 'block':'none'));
  const order = ['input','daily','range','loans','suppliers','owner'];
  qsa('.tabs .tab').forEach((t,i)=>t.classList.toggle('active', order[i]===name));
  if(name==='input'){ renderLists(); }
  if(name==='owner'){ renderOwnerStatement(); }
  if(name==='loans'){ renderLoans(); }
  if(name==='suppliers'){ renderSuppliers(); }
}
function printSection(){ window.print(); }

/* إدخال */
function addSale(){
  const a = parseFloat(qs('#saleAmount').value||'0');
  const t = qs('#saleType').value;
  const n = (qs('#saleNote').value||'').trim();
  if(!a){ alert('أدخل مبلغ صحيح'); return; }
  const d = getStoreData(); d.sales.push({id:uid(),date:todayISO(),type:t,amount:a,note:n});
  saveStoreData(d);
  qs('#saleAmount').value=''; qs('#saleNote').value='';
  renderLists();
}
function addExpense(){
  const desc=(qs('#expenseDesc').value||'').trim();
  const a=parseFloat(qs('#expenseAmount').value||'0');
  const t=qs('#expenseType').value;
  const n=(qs('#expenseNote').value||'').trim();
  if(!desc||!a){ alert('أدخل وصف ومبلغ صحيح'); return; }
  const d = getStoreData(); d.expenses.push({id:uid(),date:todayISO(),type:t,desc,amount:a,note:n});
  saveStoreData(d);
  qs('#expenseDesc').value=''; qs('#expenseAmount').value=''; qs('#expenseNote').value='';
  renderLists();
}
function deleteSale(id){
  const d=getStoreData(); const i=d.sales.findIndex(x=>x.id===id);
  if(i>-1 && confirm('حذف عملية البيع؟')){ d.sales.splice(i,1); saveStoreData(d); renderLists(); }
}
function deleteExpense(id){
  const d=getStoreData(); const i=d.expenses.findIndex(x=>x.id===id);
  if(i>-1 && confirm('حذف عملية المصروف؟')){ d.expenses.splice(i,1); saveStoreData(d); renderLists(); }
}
function renderLists(){
  const d = getStoreData();
  const rs = d.sales.slice(-30).reverse();
  const re = d.expenses.slice(-30).reverse();
  qs('#recentSales').innerHTML = rs.length ? rs.map(v=>`
    <div class="item">
      <div class="meta">${v.date} — <span class="tag">${v.type}</span> ${v.note?('— <i>'+v.note+'</i>'):''}</div>
      <div><b>${v.amount}</b></div>
      <div><button class="btn btn-danger" onclick="deleteSale('${v.id}')">حذف</button></div>
    </div>`).join('') : '<div class="hint">لا توجد مبيعات بعد</div>';
  qs('#recentExpenses').innerHTML = re.length ? re.map(v=>`
    <div class="item">
      <div class="meta">${v.date} — <span class="tag">${v.type}</span> — ${v.desc} ${v.note?('— <i>'+v.note+'</i>'):''}</div>
      <div><b>${v.amount}</b></div>
      <div><button class="btn btn-danger" onclick="deleteExpense('${v.id}')">حذف</button></div>
    </div>`).join('') : '<div class="hint">لا توجد مصاريف بعد</div>';
}

/* تقارير */
function calcTotals(entries,typeKey='type'){
  const cs = entries.filter(x=>x[typeKey]==='كاش').reduce((a,b)=>a+Number(b.amount||0),0);
  const bs = entries.filter(x=>x[typeKey]==='بنك').reduce((a,b)=>a+Number(b.amount||0),0);
  return {cs,bs};
}
function generateDaily(){
  const date = qs('#r_date').value || todayISO();
  const store = qs('#r_store').value || currentStore;
  const d = JSON.parse(localStorage.getItem(store) || '{"sales":[],"expenses":[]}');
  const s = d.sales.filter(x=>x.date===date);
  const e = d.expenses.filter(x=>x.date===date);
  const ts = calcTotals(s), te = calcTotals(e);
  const salesRows = s.map(x=>`<tr><td>${x.date}</td><td>${x.type}</td><td>${x.amount}</td><td>${x.note||''}</td></tr>`).join('') || '<tr><td colspan="4">لا يوجد مبيعات</td></tr>';
  const expRows = e.map(x=>`<tr><td>${x.date}</td><td>${x.type}</td><td>${x.desc}</td><td>${x.amount}</td><td>${x.note||''}</td></tr>`).join('') || '<tr><td colspan="5">لا يوجد مصاريف</td></tr>';
  qs('#dailyWrap').innerHTML = `
    <div class="page">
      <h2 style="margin:0 0 8px">التقرير اليومي — ${stores[store]}</h2>
      <div class="hint">تاريخ التقرير: <b>${fmtDatePretty(date)}</b> — تاريخ الطباعة: <b>${fmtDatePretty(todayISO())}</b></div>
      <div class="separator"></div>
      <div class="kpi">
        <div class="box"><b>${ts.cs}</b>مبيعات كاش</div>
        <div class="box"><b>${ts.bs}</b>مبيعات بنك</div>
        <div class="box"><b>${te.cs}</b>مصروفات كاش</div>
        <div class="box"><b>${te.bs}</b>مصروفات بنك</div>
      </div>
      <h3>تفاصيل المبيعات</h3>
      <table><thead><tr><th>التاريخ</th><th>النوع</th><th>المبلغ</th><th>ملاحظات</th></tr></thead><tbody>${salesRows}</tbody></table>
      <h3>تفاصيل المصاريف</h3>
      <table><thead><tr><th>التاريخ</th><th>النوع</th><th>الوصف</th><th>المبلغ</th><th>ملاحظات</th></tr></thead><tbody>${expRows}</tbody></table>
      <div style="margin-top:16px;display:flex;gap:10px;justify-content:flex-end"><div><b>الصافي:</b> ${(ts.cs+ts.bs)-(te.cs+te.bs)}</div></div>
      <div style="margin-top:40px;display:flex;justify-content:space-between">
        <div>توقيع المالك: عبد الله أبو عوض ____________________</div>
        <div>توقيع المدير المالي: ____________________</div>
      </div>
    </div>`;
}
function generateRange(){
  const from = qs('#f_from').value || todayISO().slice(0,8)+'01';
  const to   = qs('#f_to').value   || todayISO();
  const mode = qs('#f_mode').value || 'per';
  const shops = Object.keys(stores);

  if(mode==='all'){
    let allSales=[], allExp=[];
    shops.forEach(st=>{
      const d=getStoreData(st);
      allSales = allSales.concat(d.sales.filter(x=>inRange(x.date,from,to)));
      allExp   = allExp  .concat(d.expenses.filter(x=>inRange(x.date,from,to)));
    });
    const ts=calcTotals(allSales), te=calcTotals(allExp);
    const net=(ts.cs+ts.bs)-(te.cs+te.bs);
    qs('#rangeWrap').innerHTML = `
      <div class="page">
        <h2 style="margin:0 0 8px">تقرير مجمّع — كل المحلات</h2>
        <div class="hint">الفترة: <b>${from}</b> → <b>${to}</b> — تاريخ الطباعة: <b>${fmtDatePretty(todayISO())}</b></div>
        <div class="separator"></div>
        <table><thead><tr><th>المؤشر</th><th>القيمة</th></tr></thead><tbody>
          <tr><td>مبيعات كاش</td><td>${ts.cs}</td></tr>
          <tr><td>مبيعات بنك</td><td>${ts.bs}</td></tr>
          <tr><td>مصروفات كاش</td><td>${te.cs}</td></tr>
          <tr><td>مصروفات بنك</td><td>${te.bs}</td></tr>
          <tr><td><b>الصافي</b></td><td><b>${net}</b></td></tr>
        </tbody></table>
        <div style="margin-top:40px;display:flex;justify-content:space-between">
          <div>توقيع المالك: عبد الله أبو عوض ____________________</div>
          <div>توقيع المدير المالي: ____________________</div>
        </div>
      </div>`;
  } else {
    let html='';
    shops.forEach(st=>{
      const d=getStoreData(st);
      const s=d.sales.filter(x=>inRange(x.date,from,to));
      const e=d.expenses.filter(x=>inRange(x.date,from,to));
      const ts=calcTotals(s), te=calcTotals(e);
      const net=(ts.cs+ts.bs)-(te.cs+te.bs);
      html += `
        <div class="page">
          <h2 style="margin:0 0 8px">تقرير فترة — ${stores[st]}</h2>
          <div class="hint">الفترة: <b>${from}</b> → <b>${to}</b> — تاريخ الطباعة: <b>${fmtDatePretty(todayISO())}</b></div>
          <div class="separator"></div>
          <table><thead><tr><th>المؤشر</th><th>القيمة</th></tr></thead><tbody>
            <tr><td>مبيعات كاش</td><td>${ts.cs}</td></tr>
            <tr><td>مبيعات بنك</td><td>${ts.bs}</td></tr>
            <tr><td>مصروفات كاش</td><td>${te.cs}</td></tr>
            <tr><td>مصروفات بنك</td><td>${te.bs}</td></tr>
            <tr><td><b>الصافي</b></td><td><b>${net}</b></td></tr>
          </tbody></table>
          <div style="margin-top:40px;display:flex;justify-content:space-between">
            <div>توقيع المالك: عبد الله أبو عوض ____________________</div>
            <div>توقيع المدير المالي: ____________________</div>
          </div>
        </div>`;
    });
    qs('#rangeWrap').innerHTML = html;
  }
}

/* تسوية اليوم لصندوق المالك */
function updateOwnerBalanceUI(){
  const O=getOwner();
  const ins = O.ledger.filter(x=>x.type==='in').reduce((a,b)=>a+Number(b.amount||0),0);
  const outs= O.ledger.filter(x=>x.type==='out').reduce((a,b)=>a+Number(b.amount||0),0);
  qs('#ownerBalanceVal').textContent = (ins - outs);
}
function settleDay(){
  const day = (qs('#todayInput').value || todayISO());
  const d   = getStoreData();
  const cashSales = d.sales.filter(x=>x.date===day && x.type==='كاش').reduce((a,b)=>a+Number(b.amount||0),0);
  const cashExp   = d.expenses.filter(x=>x.date===day && x.type==='كاش').reduce((a,b)=>a+Number(b.amount||0),0);
  const net = cashSales - cashExp;
  const O=getOwner();

  // احذف أي تسوية سابقة لنفس اليوم ولنفس المحل
  for(let i=O.ledger.length-1;i>=0;i--){
    const e=O.ledger[i];
    if(e.date===day && e.type==='in' && String(e.note||'').includes(`ترحيل كاش اليوم من ${stores[currentStore]}`)){
      O.ledger.splice(i,1);
    }
  }
  if(net>0){
    O.ledger.push({id:uid(),date:day,type:'in',amount:+net, note:`ترحيل كاش اليوم من ${stores[currentStore]}`});
    saveOwner(O);
    updateOwnerBalanceUI();
    alert('تم تثبيت التسوية ✅');
  }else{
    saveOwner(O);
    updateOwnerBalanceUI();
    alert('لا يوجد كاش فائض لهذا اليوم.');
  }
}

/* السُلف */
function renderLoans(){
  const L=getLoans();
  const names=Object.keys(L.people);
  if(!names.length){ qs('#loansWrap').innerHTML='<div class="hint">لا توجد سلف بعد</div>'; return; }
  const rows = names.map(n=>`<tr><td>${n}</td><td>${L.people[n].balance||0}</td></tr>`).join('');
  qs('#loansWrap').innerHTML = `<table><thead><tr><th>الاسم</th><th>الرصيد</th></tr></thead><tbody>${rows}</tbody></table>`;
}
function addLoan(){
  const name=(qs('#loanPerson').value||'').trim();
  const amt=parseFloat(qs('#loanAmount').value||'0');
  if(!name||!amt){ alert('أدخل اسم ومبلغ صحيح'); return; }
  const L=getLoans();
  if(!L.people[name]) L.people[name]={balance:0,history:[]};
  L.people[name].balance += amt;
  L.people[name].history.push({id:uid(),date:todayISO(),type:'in',amount:amt,note:'سلفة للمحل'});
  saveLoans(L);
  qs('#loanPerson').value=''; qs('#loanAmount').value='';
  renderLoans();
}
function payLoan(){
  const name=(qs('#loanPayPerson').value||'').trim();
  const amt=parseFloat(qs('#loanPayAmount').value||'0');
  const src=qs('#loanPaySource').value; // store/owner
  if(!name||!amt){ alert('أدخل اسم ومبلغ صحيح'); return; }
  const L=getLoans();
  if(!L.people[name]){ alert('لا يوجد هذا المسلف'); return; }
  L.people[name].balance -= amt;
  L.people[name].history.push({id:uid(),date:todayISO(),type:'out',amount:amt,note:`سداد من ${src==='store'?'كاش المحل':'صندوق المالك'}`});
  saveLoans(L);

  if(src==='store'){
    const d=getStoreData();
    d.expenses.push({id:uid(),date:todayISO(),type:'كاش',desc:'سداد سلفة',amount:amt,note:name});
    saveStoreData(d);
  }else{
    const O=getOwner();
    O.ledger.push({id:uid(),date:todayISO(),type:'out',amount:amt,note:`سداد سلفة: ${name}`});
    saveOwner(O);
    updateOwnerBalanceUI();
  }
  qs('#loanPayPerson').value=''; qs('#loanPayAmount').value='';
  renderLoans(); renderLists(); renderOwnerStatement();
}

/* التجار */
function renderSuppliers(){
  const S=getSuppliers();
  const names=Object.keys(S.people);
  if(!names.length){ qs('#supWrap').innerHTML='<div class="hint">لا يوجد تجار بعد</div>'; return; }
  const rows = names.map(n=>`<tr><td>${n}</td><td>${S.people[n].balance||0}</td></tr>`).join('');
  qs('#supWrap').innerHTML = `<table><thead><tr><th>التاجر</th><th>الرصيد (مديونية)</th></tr></thead><tbody>${rows}</tbody></table>`;
}
function addSupplierInvoice(){
  const name=(qs('#supName').value||'').trim();
  const amt=parseFloat(qs('#supInvoice').value||'0');
  if(!name||!amt){ alert('أدخل اسم وقيمة فاتورة صحيحة'); return; }
  const S=getSuppliers();
  if(!S.people[name]) S.people[name]={balance:0,history:[]};
  S.people[name].balance += amt;
  S.people[name].history.push({id:uid(),date:todayISO(),type:'invoice',amount:amt,note:'فاتورة مشتريات'});
  saveSuppliers(S);
  qs('#supName').value=''; qs('#supInvoice').value='';
  renderSuppliers();
}
function paySupplier(){
  const name=(qs('#supPayName').value||'').trim();
  const amt=parseFloat(qs('#supPayAmount').value||'0');
  const src=qs('#supPaySource').value; // store/owner/bank
  if(!name||!amt){ alert('أدخل اسم ومبلغ صحيح'); return; }
  const S=getSuppliers();
  if(!S.people[name]){ alert('لا يوجد هذا التاجر'); return; }
  S.people[name].balance -= amt;
  S.people[name].history.push({id:uid(),date:todayISO(),type:'pay',amount:amt,note:`دفعة من ${src==='store'?'كاش المحل':(src==='owner'?'صندوق المالك':'البنك')}`});
  saveSuppliers(S);

  if(src==='store'){
    const d=getStoreData();
    d.expenses.push({id:uid(),date:todayISO(),type:'كاش',desc:`دفعة تاجر (${name})`,amount:amt,note:'من كاش المحل'});
    saveStoreData(d);
    renderLists();
  }else if(src==='owner'){
    const O=getOwner();
    O.ledger.push({id:uid(),date:todayISO(),type:'out',amount:amt,note:`دفعة تاجر (${name})`});
    saveOwner(O);
    updateOwnerBalanceUI();
  }else{
    const d=getStoreData();
    d.expenses.push({id:uid(),date:todayISO(),type:'بنك',desc:`دفعة تاجر (${name})`,amount:amt,note:'من البنك'});
    saveStoreData(d);
    renderLists();
  }
  qs('#supPayName').value=''; qs('#supPayAmount').value='';
  renderSuppliers(); renderOwnerStatement();
}

/* صندوق المالك + كشف + شهري */
function renderOwnerStatement(){
  const from=(qs('#of_from').value||todayISO().slice(0,8)+'01');
  const to  =(qs('#of_to').value  ||todayISO());
  const O=getOwner();
  const rows = O.ledger.filter(x=>inRange(x.date,from,to));
  const ins  = sum(rows, x=>x.type==='in'? Number(x.amount||0):0);
  const outs = sum(rows, x=>x.type==='out'?Number(x.amount||0):0);
  const tbl  = rows.length ? rows.map(e=>`<tr><td>${e.date}</td><td>${e.type==='in'?'تحصيل':'صرف'}</td><td>${e.amount}</td><td>${e.note||''}</td></tr>`).join('') : `<tr><td colspan="4">لا توجد حركات</td></tr>`;
  qs('#ownerWrap').innerHTML = `
    <div class="page">
      <h2 style="margin:0 0 8px">كشف صندوق المالك</h2>
      <div class="hint">الفترة: <b>${from}</b> → <b>${to}</b> — تاريخ الطباعة: <b>${fmtDatePretty(todayISO())}</b></div>
      <div class="separator"></div>
      <table><thead><tr><th>التاريخ</th><th>النوع</th><th>المبلغ</th><th>الملاحظة</th></tr></thead><tbody>${tbl}</tbody></table>
      <div style="margin-top:8px"><b>تحصيل:</b> ${ins} — <b>صرف:</b> ${outs} — <b>الرصيد:</b> ${ins-outs}</div>
      <div style="margin-top:40px;display:flex;justify-content:space-between">
        <div>توقيع المالك: عبد الله أبو عوض ____________________</div>
        <div>توقيع المدير المالي: ____________________</div>
      </div>
    </div>`;
  updateOwnerBalanceUI();
}
function generateMonthly(){
  const ym = (qs('#m_month').value || todayISO().slice(0,7)); // YYYY-MM
  const from = ym+'-01';
  const to   = ym+'-31';
  let allSales=[], allExp=[];
  Object.keys(stores).forEach(st=>{
    const d=getStoreData(st);
    allSales = allSales.concat(d.sales.filter(x=>x.date.slice(0,7)===ym));
    allExp   = allExp  .concat(d.expenses.filter(x=>x.date.slice(0,7)===ym));
  });
  const ts=calcTotals(allSales), te=calcTotals(allExp);
  const net=(ts.cs+ts.bs)-(te.cs+te.bs);
  const O=getOwner();
  const rows=O.ledger.filter(x=>x.date.slice(0,7)===ym);
  const ins = sum(rows,x=>x.type==='in'?Number(x.amount||0):0);
  const outs= sum(rows,x=>x.type==='out'?Number(x.amount||0):0);

  qs('#monthlyWrap').innerHTML = `
    <div class="page">
      <h2 style="margin:0 0 8px">تقرير شهري مجمّع — ${ym}</h2>
      <div class="hint">يشمل كل المحلات + صندوق المالك — تاريخ الطباعة: <b>${fmtDatePretty(todayISO())}</b></div>
      <div class="separator"></div>
      <table><thead><tr><th>المؤشر</th><th>القيمة</th></tr></thead><tbody>
        <tr><td>مبيعات كاش</td><td>${ts.cs}</td></tr>
        <tr><td>مبيعات بنك</td><td>${ts.bs}</td></tr>
        <tr><td>مصروفات كاش</td><td>${te.cs}</td></tr>
        <tr><td>مصروفات بنك</td><td>${te.bs}</td></tr>
        <tr><td><b>صافي (المحلات)</b></td><td><b>${net}</b></td></tr>
        <tr><td>تحصيلات صندوق المالك</td><td>${ins}</td></tr>
        <tr><td>مصروفات صندوق المالك</td><td>${outs}</td></tr>
        <tr><td><b>رصيد صندوق المالك خلال الشهر</b></td><td><b>${ins-outs}</b></td></tr>
      </tbody></table>
      <div style="margin-top:40px;display:flex;justify-content:space-between">
        <div>توقيع المالك: عبد الله أبو عوض ____________________</div>
        <div>توقيع المدير المالي: ____________________</div>
      </div>
    </div>`;
}

/* نسخ احتياطي */
function exportBackup(){
  const payload={
    version:"final-1",
    at:new Date().toISOString(),
    stores:{
      store1:JSON.parse(localStorage.getItem('store1')||'{"sales":[],"expenses":[]}'),
      store2:JSON.parse(localStorage.getItem('store2')||'{"sales":[],"expenses":[]}'),
      store3:JSON.parse(localStorage.getItem('store3')||'{"sales":[],"expenses":[]}
