<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© â€” Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</title>
<meta name="theme-color" content="#2b7bff"/>
<link rel="manifest" href="./manifest.webmanifest"/>

<style>
:root{
  --blue:#2b7bff; --blue-soft:#eaf3ff; --line:#e5e7eb; --card:#fff;
  --danger:#dc3545; --ok:#16a34a; --muted:#64748b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Tahoma,Arial,sans-serif;background:var(--blue-soft);color:#0f172a}
header{position:sticky;top:0;z-index:10;background:var(--blue);color:#fff;padding:10px 14px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
header h1{margin:0;font-size:18px}
header .sub{opacity:.95;font-size:13px}
header .owner-badge{margin-top:6px;font-size:14px;color:#eaf5ff;background:rgba(255,255,255,.12);display:inline-block;padding:6px 10px;border-radius:10px}
main{padding:12px;max-width:1150px;margin:auto;padding-bottom:160px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 1px 6px rgba(0,0,0,.04)}
h3{margin:6px 0 10px}
.row{display:flex;flex-wrap:wrap;gap:10px}
.col{flex:1;min-width:200px}
label{font-size:13px;color:#111}
input,select,textarea,button{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:16px;background:#fff}
textarea{min-height:70px;resize:vertical}
button{border:none;cursor:pointer}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border-radius:12px;padding:10px 14px;font-size:14px}
.btn-primary{background:var(--blue);color:#fff}
.btn-outline{background:#fff;border:1px solid var(--line);color:#111}
.btn-danger{background:var(--danger);color:#fff}
.btn-ok{background:var(--ok);color:#fff}
.hint{font-size:12px;color:var(--muted)}
.list .item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 0;border-bottom:1px dashed var(--line)}
.list .item:last-child{border-bottom:none}
.list .meta{flex:1}
.kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
.kpi .box{background:#f3f7ff;border:1px solid #e3ecff;border-radius:12px;padding:10px;text-align:center}
.kpi .box b{display:block;font-size:16px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--line);padding:8px;text-align:center;font-size:14px}
th{background:#f8fbff}
.tabs{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--line);display:flex}
.tab{flex:1}
.tab button{width:100%;background:#fff;border:none;padding:12px 0}
.tab.active{background:#f0f6ff}
.tag{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px}
.subtle{background:#f9fbff;border:1px solid #eef2ff;border-radius:12px;padding:10px;margin-top:8px}
.separator{height:1px;background:var(--line);margin:8px 0}
@media print{
  header,nav.tabs,.print-hide{display:none !important}
  body{background:#fff}
  .card{box-shadow:none;border:none;padding:0;margin:0}
  .page{page-break-after:always;margin-bottom:30px}
}
</style>
</head>
<body>
<header class="print-hide">
  <h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© â€” Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</h1>
  <div class="sub">Ø§Ù„Ù…Ø§Ù„Ùƒ: <b>Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶</b></div>
  <div class="owner-badge">Ø±ØµÙŠØ¯ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ: <b id="ownerBalanceVal">0</b></div>
</header>

<main>
  <!-- Ø´Ø±ÙŠØ· ØªØ­ÙƒÙ… Ø£Ø¹Ù„Ù‰ -->
  <div class="card print-hide">
    <div class="row">
      <div class="col">
        <label>Ø§Ù„Ù…Ø­Ù„</label>
        <select id="storeSelect" onchange="changeStore()">
          <option value="store1">Ø±ÙˆØ§Ù† Ø¨ÙŠØ¨ÙŠ</option>
          <option value="store2">Ø¬Ù†ØªÙ„ Ø¨ÙŠØ¨ÙŠ Ø¹Ø¨ÙˆØ¯</option>
          <option value="store3">Ø¨Ø³Ø·Ø©</option>
        </select>
      </div>
      <div class="col">
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</label>
        <input type="date" id="todayInput"/>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button class="btn btn-primary" onclick="settleDay()">ØªØ³ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ… Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</button>
      </div>
    </div>
    <div class="hint">ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª â€” Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø² + ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ â€œØ§Ù„Ù…Ø§Ù„Ùƒâ€.</div>
  </div>

  <!-- Ø¥Ø¯Ø®Ø§Ù„ -->
  <section class="card" data-tab="input">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
    <div class="row">
      <div class="col"><input type="number" id="saleAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
      <div class="col"><select id="saleType"><option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option><option value="Ø¨Ù†Ùƒ">Ø¨Ù†Ùƒ</option></select></div>
      <div class="col"><input type="text" id="saleNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ/Ø§Ù„ØµÙ†Ù/Ø¬ÙˆØ§Ù„)"></div>
      <div class="col"><button class="btn btn-ok" onclick="addSale()">â• Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ¹</button></div>
    </div>
    <div id="recentSales" class="list"></div>

    <h3 style="margin-top:18px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„)</h3>
    <div class="row">
      <div class="col"><input type="text" id="expenseDesc" placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ"></div>
      <div class="col"><input type="number" id="expenseAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
      <div class="col"><input type="text" id="expenseNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
      <!-- Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
      <div class="col">
        <select id="expenseBenefType">
          <option value="">â€” Ø¬Ù‡Ø© Ù…Ø³ØªÙÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€”</option>
          <option value="supplier">ØªØ§Ø¬Ø±</option>
          <option value="loan">Ù…Ø³Ù„Ù</option>
        </select>
      </div>
      <div class="col">
        <input type="text" id="expenseBenefName" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±/Ø§Ù„Ù…Ø³Ù„Ù (Ø¥Ù† ÙˆØ¬Ø¯)">
      </div>
      <div class="col"><button class="btn btn-ok" onclick="addExpense()">â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button></div>
    </div>
    <div id="recentExpenses" class="list"></div>
  </section>

  <!-- ÙŠÙˆÙ…ÙŠ -->
  <section class="card" data-tab="daily">
    <h3>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
    <div class="row print-hide">
      <div class="col"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="r_date"></div>
      <div class="col"><label>Ø§Ù„Ù…Ø­Ù„</label>
        <select id="r_store">
          <option value="store1">Ø±ÙˆØ§Ù† Ø¨ÙŠØ¨ÙŠ</option>
          <option value="store2">Ø¬Ù†ØªÙ„ Ø¨ÙŠØ¨ÙŠ Ø¹Ø¨ÙˆØ¯</option>
          <option value="store3">Ø¨Ø³Ø·Ø©</option>
        </select>
      </div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="generateDaily()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection('dailyWrap')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button></div>
    </div>
    <div id="dailyWrap"></div>
  </section>

  <!-- ÙØªØ±Ø© / Ù…Ø¬Ù…Ù‘Ø¹ -->
  <section class="card" data-tab="range">
    <h3>ØªÙ‚Ø±ÙŠØ± ÙØªØ±Ø© / Ù…Ø¬Ù…Ù‘Ø¹</h3>
    <div class="row print-hide">
      <div class="col"><label>Ù…Ù†</label><input type="date" id="f_from"></div>
      <div class="col"><label>Ø¥Ù„Ù‰</label><input type="date" id="f_to"></div>
      <div class="col"><label>Ø§Ù„Ù†Ù…Ø·</label><select id="f_mode"><option value="per">Ù…Ù†ÙØµÙ„ Ù„ÙƒÙ„ Ù…Ø­Ù„</option><option value="all">Ù…Ø¬Ù…Ù‘Ø¹ Ù„Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø©</option></select></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="generateRange()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection('rangeWrap')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button></div>
    </div>
    <div id="rangeWrap"></div>
  </section>

  <!-- Ø§Ù„Ø³Ù„Ù -->
  <section class="card" data-tab="loans">
    <h3>Ø§Ù„Ø³ÙÙ„Ù (ÙƒØ§Ø´ ÙÙ‚Ø·)</h3>
    <div class="row">
      <div class="col"><input type="text" id="loanPerson" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙØ³Ù„Ù"></div>
      <div class="col"><input type="number" id="loanAmount" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù„ÙØ© (+)"></div>
      <div class="col"><button class="btn btn-ok" onclick="addLoan()">â• Ø¥Ø¶Ø§ÙØ© Ø³Ù„ÙØ©</button></div>
    </div>
    <div class="row">
      <div class="col"><input type="text" id="loanPayPerson" placeholder="Ø§Ø®ØªØ±/Ø§ÙƒØªØ¨ Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø³Ø¯Ø§Ø¯"></div>
      <div class="col"><input type="number" id="loanPayAmount" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø¯Ø§Ø¯ (âˆ’)"></div>
      <div class="col"><select id="loanPaySource"><option value="store">Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„</option><option value="owner">Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</option></select></div>
      <div class="col"><button class="btn btn-primary" onclick="payLoan()">ğŸ’¸ ØªØ³Ø¬ÙŠÙ„ Ø³Ø¯Ø§Ø¯</button></div>
    </div>
    <div id="loansWrap" class="subtle" style="margin-top:8px"></div>
  </section>

  <!-- Ø§Ù„ØªØ¬Ø§Ø± -->
  <section class="card" data-tab="suppliers">
    <h3>Ø§Ù„ØªÙØ¬Ø§Ø±</h3>
    <div class="row">
      <div class="col"><input type="text" id="supName" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±"></div>
      <div class="col"><input type="number" id="supInvoice" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (ØªØ²ÙŠØ¯ Ø§Ù„Ø¯ÙŠÙ†)"></div>
      <div class="col"><button class="btn btn-ok" onclick="addSupplierInvoice()">â• ØªØ³Ø¬ÙŠÙ„ ÙØ§ØªÙˆØ±Ø©</button></div>
    </div>
    <div class="row">
      <div class="col"><input type="text" id="supPayName" placeholder="Ø§Ø®ØªØ±/Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø¯ÙØ¹"></div>
      <div class="col"><input type="number" id="supPayAmount" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø© (ÙŠÙ‚Ù„Ù„ Ø§Ù„Ø¯ÙŠÙ†)"></div>
      <div class="col"><select id="supPaySource">
        <option value="store">Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„</option>
        <option value="owner">Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</option>
        <option value="bank">Ù…Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ</option>
      </select></div>
      <div class="col"><button class="btn btn-primary" onclick="paySupplier()">ğŸ’³ ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©</button></div>
    </div>
    <div id="supWrap" class="subtle" style="margin-top:8px"></div>
  </section>

  <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ -->
  <section class="card" data-tab="owner">
    <h3>ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ â€” ÙƒØ´Ù ÙÙˆØ±ÙŠ ÙˆØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ</h3>
    <div class="row print-hide">
      <div class="col"><label>Ù…Ù†</label><input type="date" id="of_from"></div>
      <div class="col"><label>Ø¥Ù„Ù‰</label><input type="date" id="of_to"></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="renderOwnerStatement()">Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ´Ù</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection('ownerWrap')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button></div>
    </div>
    <div id="ownerWrap"></div>

    <div class="subtle print-hide" style="margin-top:12px">
      <h4>ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ Ù…Ø¬Ù…Ù‘Ø¹ (ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª + ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ)</h4>
      <div class="row">
        <div class="col"><label>Ø§Ù„Ø´Ù‡Ø±</label><input type="month" id="m_month"></div>
        <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="generateMonthly()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</button></div>
        <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection('monthlyWrap')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button></div>
      </div>
      <div id="monthlyWrap"></div>
    </div>

    <div class="subtle print-hide" style="margin-top:12px">
      <h4>Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h4>
      <div class="row">
        <div class="col"><button class="btn btn-outline" onclick="exportBackup()">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button></div>
        <div class="col">
          <label for="importFile" class="btn btn-ok" style="display:inline-block;cursor:pointer;text-align:center">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø©</label>
          <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importBackup(this.files[0])"/>
        </div>
      </div>
      <div class="hint">ØªØ´Ù…Ù„ Ø§Ù„Ù†Ø³Ø®Ø©: Ø§Ù„Ù…Ø­Ù„Ø§ØªØŒ Ø§Ù„Ø³Ù„ÙØŒ Ø§Ù„ØªØ¬Ø§Ø±ØŒ ÙˆØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ.</div>
    </div>
  </section>
</main>

<nav class="tabs print-hide">
  <div class="tab active"><button onclick="showTab('input')">Ø¥Ø¯Ø®Ø§Ù„</button></div>
  <div class="tab"><button onclick="showTab('daily')">ÙŠÙˆÙ…ÙŠ</button></div>
  <div class="tab"><button onclick="showTab('range')">ÙØªØ±Ø©/Ù…Ø¬Ù…Ù‘Ø¹</button></div>
  <div class="tab"><button onclick="showTab('loans')">Ø³ÙÙ„Ù</button></div>
  <div class="tab"><button onclick="showTab('suppliers')">ØªÙØ¬Ø§Ø±</button></div>
  <div class="tab"><button onclick="showTab('owner')">Ø§Ù„Ù…Ø§Ù„Ùƒ</button></div>
</nav>

<script>
/* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ===== */
const stores={store1:"Ø±ÙˆØ§Ù† Ø¨ÙŠØ¨ÙŠ",store2:"Ø¬Ù†ØªÙ„ Ø¨ÙŠØ¨ÙŠ Ø¹Ø¨ÙˆØ¯",store3:"Ø¨Ø³Ø·Ø©"};let currentStore="store1";
const qs=s=>document.querySelector(s), qsa=s=>Array.from(document.querySelectorAll(s));
const todayISO=()=>new Date().toISOString().slice(0,10);
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,7);
const inRange=(iso,from,to)=>{const d=new Date(iso+"T00:00:00");return d>=new Date(from+"T00:00:00")&&d<=new Date(to+"T00:00:00");}
const sum=(arr,fn)=>arr.reduce((a,b)=>a+fn(b),0);
function fmtDatePretty(iso){const d=new Date(iso+"T00:00:00");const days=["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];const pad=n=>String(n).padStart(2,"0");return `${days[d.getDay()]} ${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}

/* ===== ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ ===== */
function getStoreData(store=currentStore){return JSON.parse(localStorage.getItem(store)||'{"sales":[],"expenses":[]}')}
function saveStoreData(data,store=currentStore){localStorage.setItem(store,JSON.stringify(data))}
function getOwner(){return JSON.parse(localStorage.getItem('owner_fund')||'{"ledger":[]}')}
function saveOwner(v){localStorage.setItem('owner_fund',JSON.stringify(v))}
function getLoans(){return JSON.parse(localStorage.getItem('loans')||'{"people":{}}')}
function saveLoans(v){localStorage.setItem('loans',JSON.stringify(v))}
function getSuppliers(){return JSON.parse(localStorage.getItem('suppliers')||'{"people":{}}')}
function saveSuppliers(v){localStorage.setItem('suppliers',JSON.stringify(v))}

/* ===== ÙˆØ§Ø¬Ù‡Ø© ÙˆØªØ¨ÙˆÙŠØ¨Ø§Øª ===== */
function changeStore(){currentStore=qs('#storeSelect').value;renderLists()}
function showTab(name){
  qsa('[data-tab]').forEach(el=>el.style.display=(el.getAttribute('data-tab')===name?'block':'none'));
  const order=['input','daily','range','loans','suppliers','owner'];
  qsa('.tabs .tab').forEach((t,i)=>t.classList.toggle('active',order[i]===name));
  if(name==='input')renderLists();
  if(name==='owner')renderOwnerStatement();
  if(name==='loans')renderLoans();
  if(name==='suppliers')renderSuppliers();
}
function printSection(){window.print()}

/* ===== Ø¥Ø¯Ø®Ø§Ù„ ===== */
function addSale(){
  const a=parseFloat(qs('#saleAmount').value||'0'), t=qs('#saleType').value, n=(qs('#saleNote').value||'').trim();
  if(!a){alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');return}
  const d=getStoreData(); d.sales.push({id:uid(),date:todayISO(),type:t,amount:a,note:n}); saveStoreData(d);
  qs('#saleAmount').value=''; qs('#saleNote').value=''; renderLists();
}

/* ===== Ù…ØµØ§Ø±ÙŠÙ (Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„) + Ø±Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹ ØªØ§Ø¬Ø±/Ù…Ø³Ù„Ù ===== */
function _deductSupplier(name, amt) {
  const S = getSuppliers();
  if (!S.people) S.people = {};
  if (!S.people[name]) S.people[name] = { balance: 0, history: [] };
  S.people[name].balance -= amt; // ÙŠÙ†Ù‚Øµ Ø¯ÙŠÙ†Ù‡
  S.people[name].history.push({ id: uid(), date: todayISO(), type: 'pay', amount: amt, note: 'Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡ (Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„)' });
  saveSuppliers(S);
  renderSuppliers?.();
}
function _undeductSupplier(name, amt) {
  const S = getSuppliers();
  if (!S.people || !S.people[name]) return;
  S.people[name].balance += amt; // Ø¹ÙƒØ³ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
  S.people[name].history.push({ id: uid(), date: todayISO(), type: 'revert', amount: amt, note: 'Ø¥Ù„ØºØ§Ø¡ Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡' });
  saveSuppliers(S);
  renderSuppliers?.();
}
function _deductLoan(name, amt) {
  const L = getLoans();
  if (!L.people) L.people = {};
  if (!L.people[name]) L.people[name] = { balance: 0, history: [] };
  L.people[name].balance -= amt;
  L.people[name].history.push({ id: uid(), date: todayISO(), type: 'out', amount: amt, note: 'Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡ (Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„)' });
  saveLoans(L);
  renderLoans?.();
}
function _undeductLoan(name, amt) {
  const L = getLoans();
  if (!L.people || !L.people[name]) return;
  L.people[name].balance += amt;
  L.people[name].history.push({ id: uid(), date: todayISO(), type: 'revert', amount: amt, note: 'Ø¥Ù„ØºØ§Ø¡ Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬Ù‘Ù‡' });
  saveLoans(L);
  renderLoans?.();
}

function addExpense(){
  const desc=(qs('#expenseDesc').value||'').trim();
  const a=parseFloat(qs('#expenseAmount').value||'0');
  const n=(qs('#expenseNote').value||'').trim();
  const bType = qs('#expenseBenefType') ? qs('#expenseBenefType').value : '';
  const bName = (qs('#expenseBenefName') ? qs('#expenseBenefName').value : '').trim();

  if(!desc||!a){alert('Ø£Ø¯Ø®Ù„ ÙˆØµÙ ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­');return}
  const d=getStoreData();
  const exp={id:uid(),date:todayISO(),type:'ÙƒØ§Ø´',desc,amount:a,note:n,benefType:bType||null,benefName:bName||null};
  d.expenses.push(exp); saveStoreData(d);

  // Ø®ØµÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø©
  if (bType && bName){
    if (bType==='supplier') _deductSupplier(bName,a);
    if (bType==='loan')     _deductLoan(bName,a);
  }

  // ØµØ§Ù…Øª
  qs('#expenseDesc').value=''; qs('#expenseAmount').value=''; if(qs('#expenseNote')) qs('#expenseNote').value='';
  if(qs('#expenseBenefType')) qs('#expenseBenefType').value='';
  if(qs('#expenseBenefName')) qs('#expenseBenefName').value='';
  renderLists(); renderOwnerStatement?.();
}
function deleteExpense(id){
  const d=getStoreData(); const i=d.expenses.findIndex(x=>x.id===id); if(i===-1) return;
  const exp=d.expenses[i];
  if (exp.benefType && exp.benefName && exp.amount){
    if (exp.benefType==='supplier') _undeductSupplier(exp.benefName, Number(exp.amount));
    if (exp.benefType==='loan')     _undeductLoan(exp.benefName, Number(exp.amount));
  }
  d.expenses.splice(i,1); saveStoreData(d);
  renderLists(); renderOwnerStatement?.();
}
function deleteSale(id){const d=getStoreData();const i=d.sales.findIndex(x=>x.id===id);if(i>-1){d.sales.splice(i,1);saveStoreData(d);renderLists()}}

function renderLists(){
  const d=getStoreData();
  const rs=d.sales.slice(-30).reverse(), re=d.expenses.slice(-30).reverse();
  qs('#recentSales').innerHTML=rs.length?rs.map(v=>`<div class="item"><div class="meta">${v.date} â€” <span class="tag">${v.type}</span> ${v.note?('â€” <i>'+v.note+'</i>'):''}</div><div><b>${v.amount}</b></div><div><button class="btn btn-danger" onclick="deleteSale('${v.id}')">Ø­Ø°Ù</button></div></div>`).join(''):'<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯</div>';
  qs('#recentExpenses').innerHTML=re.length?re.map(v=>{
    const tag = `<span class="tag">${v.type}</span>`;
    const link = (v.benefType && v.benefName) ? ` â€” <b>Ù…ÙˆØ¬Ù‘Ù‡ Ø¥Ù„Ù‰: ${v.benefType==='supplier'?'ØªØ§Ø¬Ø±':'Ù…Ø³Ù„Ù'} (${v.benefName})</b>` : '';
    return `<div class="item"><div class="meta">${v.date} â€” ${tag} â€” ${v.desc}${link} ${v.note?('â€” <i>'+v.note+'</i>'):''}</div><div><b>${v.amount}</b></div><div><button class="btn btn-danger" onclick="deleteExpense('${v.id}')">Ø­Ø°Ù</button></div></div>`;
  }).join(''):'<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ø¨Ø¹Ø¯</div>';
}

/* ===== ØªÙ‚Ø§Ø±ÙŠØ± ===== */
function calcTotals(entries,typeKey='type'){const cs=entries.filter(x=>x[typeKey]==='ÙƒØ§Ø´').reduce((a,b)=>a+Number(b.amount||0),0);const bs=entries.filter(x=>x[typeKey]==='Ø¨Ù†Ùƒ').reduce((a,b)=>a+Number(b.amount||0),0);return{cs,bs}}
function generateDaily(){
  const date=qs('#r_date').value||todayISO();const store=qs('#r_store').value||currentStore;
  const d=JSON.parse(localStorage.getItem(store)||'{"sales":[],"expenses":[]}');
  const s=d.sales.filter(x=>x.date===date), e=d.expenses.filter(x=>x.date===date);
  const ts=calcTotals(s), te=calcTotals(e);
  const salesRows=s.map(x=>`<tr><td>${x.date}</td><td>${x.type}</td><td>${x.amount}</td><td>${x.note||''}</td></tr>`).join('')||'<tr><td colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª</td></tr>';
  const expRows=e.map(x=>`<tr><td>${x.date}</td><td>${x.type}</td><td>${x.desc}</td><td>${x.amount}</td><td>${(x.benefType&&x.benefName)?(x.benefType==='supplier'?'ØªØ§Ø¬Ø±: ':'Ù…Ø³Ù„Ù: ')+x.benefName:(x.note||'')}</td></tr>`).join('')||'<tr><td colspan="5">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ</td></tr>';
  qs('#dailyWrap').innerHTML=`<div class="page"><h2 style="margin:0 0 8px">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ â€” ${stores[store]}</h2><div class="hint">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: <b>${fmtDatePretty(date)}</b> â€” ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <b>${fmtDatePretty(todayISO())}</b></div><div class="separator"></div><div class="kpi"><div class="box"><b>${ts.cs}</b>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</div><div class="box"><b>${ts.bs}</b>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</div><div class="box"><b>${te.cs}</b>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</div><div class="box"><b>${te.bs}</b>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</div></div><h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead><tbody>${salesRows}</tbody></table><h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª/Ø±Ø¨Ø·</th></tr></thead><tbody>${expRows}</tbody></table><div style="margin-top:16px;display:flex;gap:10px;justify-content:flex-end"><div><b>Ø§Ù„ØµØ§ÙÙŠ:</b> ${(ts.cs+ts.bs)-(te.cs+te.bs)}</div></div><div style="margin-top:40px;display:flex;justify-content:space-between"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ ____________________</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: ____________________</div></div></div>`;
}
function generateRange(){
  const from=qs('#f_from').value||todayISO().slice(0,8)+'01', to=qs('#f_to').value||todayISO(), mode=qs('#f_mode').value||'per';
  const shops=Object.keys(stores);
  if(mode==='all'){
    let allSales=[],allExp=[];shops.forEach(st=>{const d=getStoreData(st);allSales=allSales.concat(d.sales.filter(x=>inRange(x.date,from,to)));allExp=allExp.concat(d.expenses.filter(x=>inRange(x.date,from,to)))});const ts=calcTotals(allSales), te=calcTotals(allExp);const net=(ts.cs+ts.bs)-(te.cs+te.bs);
    qs('#rangeWrap').innerHTML=`<div class="page"><h2 style="margin:0 0 8px">ØªÙ‚Ø±ÙŠØ± Ù…Ø¬Ù…Ù‘Ø¹ â€” ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª</h2><div class="hint">Ø§Ù„ÙØªØ±Ø©: <b>${from}</b> â†’ <b>${to}</b> â€” ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <b>${fmtDatePretty(todayISO())}</b></div><div class="separator"></div><table><thead><tr><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead><tbody><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</td><td>${ts.cs}</td></tr><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</td><td>${ts.bs}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</td><td>${te.cs}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</td><td>${te.bs}</td></tr><tr><td><b>Ø§Ù„ØµØ§ÙÙŠ</b></td><td><b>${net}</b></td></tr></tbody></table><div style="margin-top:40px;display:flex;justify-content:space-between"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ ____________________</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: ____________________</div></div></div>`;
  }else{
    let html='';shops.forEach(st=>{const d=getStoreData(st);const s=d.sales.filter(x=>inRange(x.date,from,to)), e=d.expenses.filter(x=>inRange(x.date,from,to));const ts=calcTotals(s), te=calcTotals(e);const net=(ts.cs+ts.bs)-(te.cs+te.bs);
      html+=`<div class="page"><h2 style="margin:0 0 8px">ØªÙ‚Ø±ÙŠØ± ÙØªØ±Ø© â€” ${stores[st]}</h2><div class="hint">Ø§Ù„ÙØªØ±Ø©: <b>${from}</b> â†’ <b>${to}</b> â€” ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <b>${fmtDatePretty(todayISO())}</b></div><div class="separator"></div><table><thead><tr><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead><tbody><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</td><td>${ts.cs}</td></tr><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</td><td>${ts.bs}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</td><td>${te.cs}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</td><td>${te.bs}</td></tr><tr><td><b>Ø§Ù„ØµØ§ÙÙŠ</b></td><td><b>${net}</b></td></tr></tbody></table><div style="margin-top:40px;display:flex;justify-content:space-between"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ ____________________</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: ____________________</div></div></div>`;
    });qs('#rangeWrap').innerHTML=html;
  }
}

/* ===== ØªØ³ÙˆÙŠØ© ÙŠÙˆÙ…ÙŠØ© Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ (Ù„Ø§ ØªØªÙƒØ±Ø± Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ù…Ø­Ù„) ===== */
function updateOwnerBalanceUI(){const O=getOwner();const ins=O.ledger.filter(x=>x.type==='in').reduce((a,b)=>a+Number(b.amount||0),0);const outs=O.ledger.filter(x=>x.type==='out').reduce((a,b)=>a+Number(b.amount||0),0);qs('#ownerBalanceVal').textContent=(ins-outs)}
function settleDay(){
  const day=(qs('#todayInput').value||todayISO()), d=getStoreData();
  const cashSales=d.sales.filter(x=>x.date===day && x.type==='ÙƒØ§Ø´').reduce((a,b)=>a+Number(b.amount||0),0);
  const cashExp  =d.expenses.filter(x=>x.date===day && x.type==='ÙƒØ§Ø´').reduce((a,b)=>a+Number(b.amount||0),0);
  const net=cashSales-cashExp; const O=getOwner();
  // Ø§Ù…Ø³Ø­ Ø£ÙŠ ØªØ³ÙˆÙŠØ© Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ù…Ø­Ù„
  for(let i=O.ledger.length-1;i>=0;i--){const e=O.ledger[i];if(e.date===day && e.type==='in' && String(e.note||'').includes(`ØªØ±Ø­ÙŠÙ„ ÙƒØ§Ø´ Ø§Ù„ÙŠÙˆÙ… Ù…Ù† ${stores[currentStore]}`)){O.ledger.splice(i,1)}}
  if(net>0){O.ledger.push({id:uid(),date:day,type:'in',amount:+net,note:`ØªØ±Ø­ÙŠÙ„ ÙƒØ§Ø´ Ø§Ù„ÙŠÙˆÙ… Ù…Ù† ${stores[currentStore]}`});}
  saveOwner(O); updateOwnerBalanceUI();
}

/* ===== Ø§Ù„Ø³Ù„Ù ===== */
function renderLoans(){const L=getLoans(), names=Object.keys(L.people||{});if(!names.length){qs('#loansWrap').innerHTML='<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù„Ù Ø¨Ø¹Ø¯</div>';return}const rows=names.map(n=>`<tr><td>${n}</td><td>${L.people[n].balance||0}</td></tr>`).join('');qs('#loansWrap').innerHTML=`<table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th></tr></thead><tbody>${rows}</tbody></table>`}
function addLoan(){const name=(qs('#loanPerson').value||'').trim(), amt=parseFloat(qs('#loanAmount').value||'0');if(!name||!amt){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­');return}const L=getLoans();if(!L.people)L.people={};if(!L.people[name])L.people[name]={balance:0,history:[]};L.people[name].balance+=amt;L.people[name].history.push({id:uid(),date:todayISO(),type:'in',amount:amt,note:'Ø³Ù„ÙØ© Ù„Ù„Ù…Ø­Ù„'});saveLoans(L);qs('#loanPerson').value='';qs('#loanAmount').value='';renderLoans()}
function payLoan(){const name=(qs('#loanPayPerson').value||'').trim(), amt=parseFloat(qs('#loanPayAmount').value||'0'), src=qs('#loanPaySource').value;if(!name||!amt){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­');return}const L=getLoans();if(!L.people||!L.people[name]){alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ù„Ù');return}L.people[name].balance-=amt;L.people[name].history.push({id:uid(),date:todayISO(),type:'out',amount:amt,note:`Ø³Ø¯Ø§Ø¯ Ù…Ù† ${src==='store'?'ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„':'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ'}`});saveLoans(L);if(src==='store'){const d=getStoreData();d.expenses.push({id:uid(),date:todayISO(),type:'ÙƒØ§Ø´',desc:'Ø³Ø¯Ø§Ø¯ Ø³Ù„ÙØ©',amount:amt,note:name});saveStoreData(d)}else{const O=getOwner();O.ledger.push({id:uid(),date:todayISO(),type:'out',amount:amt,note:`Ø³Ø¯Ø§Ø¯ Ø³Ù„ÙØ©: ${name}`});saveOwner(O);updateOwnerBalanceUI()}qs('#loanPayPerson').value='';qs('#loanPayAmount').value='';renderLoans();renderLists();renderOwnerStatement()}

/* ===== Ø§Ù„ØªØ¬Ø§Ø± ===== */
function renderSuppliers(){const S=getSuppliers(), names=Object.keys(S.people||{});if(!names.length){qs('#supWrap').innerHTML='<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ø§Ø± Ø¨Ø¹Ø¯</div>';return}const rows=names.map(n=>`<tr><td>${n}</td><td>${S.people[n].balance||0}</td></tr>`).join('');qs('#supWrap').innerHTML=`<table><thead><tr><th>Ø§Ù„ØªØ§Ø¬Ø±</th><th>Ø§Ù„Ø±ØµÙŠØ¯ (Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©)</th></tr></thead><tbody>${rows}</tbody></table>`}
function addSupplierInvoice(){const name=(qs('#supName').value||'').trim(), amt=parseFloat(qs('#supInvoice').value||'0');if(!name||!amt){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙ‚ÙŠÙ…Ø© ÙØ§ØªÙˆØ±Ø© ØµØ­ÙŠØ­Ø©');return}const S=getSuppliers();if(!S.people)S.people={};if(!S.people[name])S.people[name]={balance:0,history:[]};S.people[name].balance+=amt;S.people[name].history.push({id:uid(),date:todayISO(),type:'invoice',amount:amt,note:'ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª'});saveSuppliers(S);qs('#supName').value='';qs('#supInvoice').value='';renderSuppliers()}
function paySupplier(){const name=(qs('#supPayName').value||'').trim(), amt=parseFloat(qs('#supPayAmount').value||'0'), src=qs('#supPaySource').value;if(!name||!amt){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­');return}const S=getSuppliers();if(!S.people||!S.people[name]){alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø±');return}S.people[name].balance-=amt;S.people[name].history.push({id:uid(),date:todayISO(),type:'pay',amount:amt,note:`Ø¯ÙØ¹Ø© Ù…Ù† ${src==='store'?'ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„':(src==='owner'?'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ':'Ø§Ù„Ø¨Ù†Ùƒ')}`});saveSuppliers(S);if(src==='store'){const d=getStoreData();d.expenses.push({id:uid(),date:todayISO(),type:'ÙƒØ§Ø´',desc:`Ø¯ÙØ¹Ø© ØªØ§Ø¬Ø± (${name})`,amount:amt,note:'Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„'});saveStoreData(d);renderLists()}else if(src==='owner'){const O=getOwner();O.ledger.push({id:uid(),date:todayISO(),type:'out',amount:amt,note:`Ø¯ÙØ¹Ø© ØªØ§Ø¬Ø± (${name})`});saveOwner(O);updateOwnerBalanceUI()}else{const d=getStoreData();d.expenses.push({id:uid(),date:todayISO(),type:'Ø¨Ù†Ùƒ',desc:`Ø¯ÙØ¹Ø© ØªØ§Ø¬Ø± (${name})`,amount:amt,note:'Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ'});saveStoreData(d);renderLists()}qs('#supPayName').value='';qs('#supPayAmount').value='';renderSuppliers();renderOwnerStatement()}

/* ===== ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ + ÙƒØ´Ù + Ø´Ù‡Ø±ÙŠ ===== */
function renderOwnerStatement(){
  const from=(qs('#of_from').value||todayISO().slice(0,8)+'01'), to=(qs('#of_to').value||todayISO());
  const O=getOwner(); const rows=O.ledger.filter(x=>inRange(x.date,from,to));
  const ins=sum(rows,x=>x.type==='in'?Number(x.amount||0):0), outs=sum(rows,x=>x.type==='out'?Number(x.amount||0):0);
  const tbl=rows.length?rows.map(e=>`<tr><td>${e.date}</td><td>${e.type==='in'?'ØªØ­ØµÙŠÙ„':'ØµØ±Ù'}</td><td>${e.amount}</td><td>${e.note||''}</td></tr>`).join(''):`<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª</td></tr>`;
  qs('#ownerWrap').innerHTML=`<div class="page"><h2 style="margin:0 0 8px">ÙƒØ´Ù ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</h2><div class="hint">Ø§Ù„ÙØªØ±Ø©: <b>${from}</b> â†’ <b>${to}</b> â€” ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <b>${fmtDatePretty(todayISO())}</b></div><div class="separator"></div><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead><tbody>${tbl}</tbody></table><div style="margin-top:8px"><b>ØªØ­ØµÙŠÙ„:</b> ${ins} â€” <b>ØµØ±Ù:</b> ${outs} â€” <b>Ø§Ù„Ø±ØµÙŠØ¯:</b> ${ins-outs}</div><div style="margin-top:40px;display:flex;justify-content:space-between"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ ____________________</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: ____________________</div></div></div>`;
  updateOwnerBalanceUI();
}
function generateMonthly(){
  const ym=(qs('#m_month').value||todayISO().slice(0,7));
  let allSales=[],allExp=[];
  Object.keys(stores).forEach(st=>{
    const d=getStoreData(st);
    allSales=allSales.concat(d.sales.filter(x=>x.date.slice(0,7)===ym));
    allExp=allExp.concat(d.expenses.filter(x=>x.date.slice(0,7)===ym));
  });
  const ts=calcTotals(allSales), te=calcTotals(allExp), net=(ts.cs+ts.bs)-(te.cs+te.bs);
  const O=getOwner(); const rows=O.ledger.filter(x=>x.date.slice(0,7)===ym);
  const ins=sum(rows,x=>x.type==='in'?Number(x.amount||0):0), outs=sum(rows,x=>x.type==='out'?Number(x.amount||0):0);
  qs('#monthlyWrap').innerHTML=`<div class="page"><h2 style="margin:0 0 8px">ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ Ù…Ø¬Ù…Ù‘Ø¹ â€” ${ym}</h2><div class="hint">ÙŠØ´Ù…Ù„ ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª + ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ â€” ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <b>${fmtDatePretty(todayISO())}</b></div><div class="separator"></div><table><thead><tr><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead><tbody><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</td><td>${ts.cs}</td></tr><tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</td><td>${ts.bs}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</td><td>${te.cs}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</td><td>${te.bs}</td></tr><tr><td><b>ØµØ§ÙÙŠ (Ø§Ù„Ù…Ø­Ù„Ø§Øª)</b></td><td><b>${net}</b></td></tr><tr><td>ØªØ­ØµÙŠÙ„Ø§Øª ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</td><td>${ins}</td></tr><tr><td>Ù…ØµØ±ÙˆÙØ§Øª ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</td><td>${outs}</td></tr><tr><td><b>Ø±ØµÙŠØ¯ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø®Ù„Ø§Ù„ Ø§Ù„Ø´Ù‡Ø±</b></td><td><b>${ins-outs}</b></td></tr></tbody></table><div style="margin-top:40px;display:flex;justify-content:space-between"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ ____________________</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: ____________________</div></div></div>`;
}

/* ===== Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ===== */
function exportBackup(){
  const payload={
    version:"smart-final-1",
    at:new Date().toISOString(),
    stores:{
      store1:JSON.parse(localStorage.getItem('store1')||'{"sales":[],"expenses":[]}'),
      store2:JSON.parse(localStorage.getItem('store2')||'{"sales":[],"expenses":[]}'),
      store3:JSON.parse(localStorage.getItem('store3')||'{"sales":[],"expenses":[]}'),
    },
    loans:getLoans(), suppliers:getSuppliers(), owner_fund:getOwner()
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a=document.createElement("a"); const ts=new Date(); const pad=n=>String(n).padStart(2,'0');
  a.href=URL.createObjectURL(blob); a.download=`backup-${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}-${pad(ts.getHours())}${pad(ts.getMinutes())}.json`;
  document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
}
function importBackup(file){
  if(!file){alert("Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©");return}
  const r=new FileReader();
  r.onload=e=>{try{
    const data=JSON.parse(e.target.result);
    if(!data||!data.stores)throw new Error("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
    localStorage.setItem('store1',JSON.stringify(data.stores.store1||{"sales":[],"expenses":[]}));
    localStorage.setItem('store2',JSON.stringify(data.stores.store2||{"sales":[],"expenses":[]}));
    localStorage.setItem('store3',JSON.stringify(data.stores.store3||{"sales":[],"expenses":[]}));
    localStorage.setItem('owner_fund',JSON.stringify(data.owner_fund||{"ledger":[]}));
    localStorage.setItem('loans',JSON.stringify(data.loans||{"people":{}}));
    localStorage.setItem('suppliers',JSON.stringify(data.suppliers||{"people":{}}));
    renderLists(); renderLoans(); renderSuppliers(); renderOwnerStatement(); updateOwnerBalanceUI();
  }catch(err){alert("ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: "+err.message)}};
  r.readAsText(file);
}

/* ===== ØªÙ‡ÙŠØ¦Ø© ===== */
document.addEventListener('DOMContentLoaded',()=>{
  const t=todayISO();
  ['todayInput','r_date','of_from','f_from'].forEach(id=>{const x=qs('#'+id); if(x) x.value=t;});
  const x1=qs('#of_to'); if(x1) x1.value=t;
  const x2=qs('#f_to');  if(x2) x2.value=t;
  showTab('input'); renderLists(); renderLoans(); renderSuppliers(); renderOwnerStatement(); updateOwnerBalanceUI();
});
</script>

<!-- ØªØ³Ø¬ÙŠÙ„ Service Worker -->
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js")
      .then(()=>console.log("âœ… Service Worker Registered"))
      .catch((err)=>console.error("âŒ SW Registration Failed:", err));
  });
}
</script>
</body>
</html>
