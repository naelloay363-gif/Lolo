<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>نظام المحاسبة — نسخة نهائية مضغوطة</title><meta name="theme-color" content="#58a8ff"/><style>
:root{--b:#58a8ff;--bs:#eaf3ff;--ln:#e5e7eb;--card:#fff;--d:#dc3545;--ok:#16a34a;--m:#64748b;--ink:#0f172a}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:Tahoma,Arial,sans-serif;background:var(--bs);color:var(--ink)}
header{position:sticky;top:0;z-index:5;background:var(--b);color:#fff;padding:10px 12px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
header h1{margin:0 0 2px;font-size:18px}
.owner{margin-top:6px;font-size:13px;background:rgba(255,255,255,.15);display:inline-block;padding:6px 10px;border-radius:10px}
main{padding:10px;max-width:1200px;margin:auto;padding-bottom:140px}
.card{background:var(--card);border:1px solid var(--ln);border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 1px 6px rgba(0,0,0,.04)}
h3{margin:6px 0 10px}
.row{display:flex;flex-wrap:wrap;gap:8px}.col{flex:1;min-width:190px}
label{font-size:12px;color:#111}
input,select,textarea,button{width:100%;padding:8px 10px;border:1px solid var(--ln);border-radius:12px;font-size:14px;background:#fff}
textarea{min-height:70px;resize:vertical}
button{border:none;cursor:pointer}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border-radius:12px;padding:9px 12px;font-size:13px}
.p{background:var(--b);color:#fff}.o{background:#fff;border:1px solid var(--ln)}.g{background:var(--ok);color:#fff}.r{background:var(--d);color:#fff}
.hint{font-size:12px;color:var(--m)}
.list .it{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 0;border-bottom:1px dashed var(--ln)}
.list .it:last-child{border-bottom:none}
.badge{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:11px}
.kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
.kpi .box{background:#f3f7ff;border:1px solid #e3ecff;border-radius:12px;padding:10px;text-align:center}.kpi .box b{display:block;font-size:16px}
table{width:100%;border-collapse:collapse;margin-top:8px}th,td{border:1px solid var(--ln);padding:6px;text-align:center;font-size:13px}th{background:#f8fbff}
.tabs{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--ln);display:flex}.tab{flex:1}.tab button{width:100%;background:#fff;border:none;padding:12px 0}.tab.active{background:#f0f6ff}
.subtle{background:#f9fbff;border:1px solid #eef2ff;border-radius:12px;padding:10px;margin-top:8px}
.sep{height:1px;background:var(--ln);margin:8px 0}
@media print{header,nav.tabs,.pr{display:none!important}body{background:#fff}.card{box-shadow:none;border:none;padding:0;margin:0}.page{page-break-after:always;margin-bottom:30px}}
</style></head><body>
<header class="pr"><h1>نظام المحاسبة</h1><div>المالك: <b>عبد الله أبو عوض</b></div><div class="owner">رصيد صندوق المالك: <b id="ownerBal">0</b></div></header>
<main>
<div class="card pr"><div class="row">
  <div class="col"><label>المحل</label><select id="storeSel" onchange="chgStore()"><option value="s1">روان بيبي</option><option value="s2">جنتل بيبي عبود</option><option value="s3">بسطة</option></select></div>
  <div class="col"><label>تاريخ اليوم</label><input type="date" id="today"></div>
  <div class="col"><label>&nbsp;</label><button class="btn p" onclick="settleOne()">تسوية اليوم (المحل)</button></div>
  <div class="col"><label>&nbsp;</label><button class="btn g" onclick="settleAll()">تسوية مجمّعة (كل المحلات)</button></div>
</div>
<div class="row"><div class="col"><label>معاينة يوم</label><input type="date" id="aggDay"></div><div class="col"><label>&nbsp;</label><button class="btn o" onclick="previewAgg()">معاينة تحصيل كل محل</button></div></div>
<div id="aggWrap"></div><div class="hint">العمل أوفلاين — الحفظ تلقائي محليًا + الاستيراد/التصدير من تبويب “المالك”.</div></div>

<section class="card" data-tab="input">
  <h3>تسجيل المبيعات</h3><div class="row">
    <div class="col"><input type="number" id="saleAmt" placeholder="المبلغ"></div>
    <div class="col"><select id="saleType"><option>كاش</option><option>بنك</option></select></div>
    <div class="col"><input id="saleNote" placeholder="ملاحظات (اسم/صنف/جوال)"></div>
    <div class="col"><button class="btn g" onclick="addSale()">➕ إضافة بيع</button></div>
  </div><div id="recentSales" class="list"></div>

  <h3 style="margin-top:14px">تسجيل المصاريف (من كاش المحل)</h3><div class="row">
    <div class="col"><input id="expDesc" placeholder="وصف المصروف"></div>
    <div class="col"><input type="number" id="expAmt" placeholder="المبلغ"></div>
    <div class="col"><input id="expNote" placeholder="ملاحظات (اختياري)"></div>
    <div class="col"><select id="expBind"><option value="">— جهة مستفيدة (اختياري) —</option><option value="supplier">تاجر</option><option value="loan">مسلف</option></select></div>
    <div class="col"><input id="expBindName" list="allList" placeholder="اكتب الاسم (اقتراح)"><datalist id="allList"></datalist></div>
    <div class="col"><button class="btn g" onclick="addExpense()">➕ إضافة مصروف</button></div>
  </div><div id="recentExp" class="list"></div>
</section>

<section class="card" data-tab="daily">
  <h3>التقرير اليومي</h3><div class="row pr">
    <div class="col"><label>التاريخ</label><input type="date" id="rDate"></div>
    <div class="col"><label>المحل</label><select id="rStore"><option value="s1">روان بيبي</option><option value="s2">جنتل بيبي عبود</option><option value="s3">بسطة</option></select></div>
    <div class="col"><label>&nbsp;</label><button class="btn p" onclick="reportDaily()">عرض التقرير</button></div>
    <div class="col"><label>&nbsp;</label><button class="btn o" onclick="window.print()">🖨️ طباعة PDF</button></div>
  </div><div id="dailyWrap"></div>
</section>

<section class="card" data-tab="range">
  <h3>تقرير فترة / مجمّع</h3><div class="row pr">
    <div class="col"><label>من</label><input type="date" id="fFrom"></div>
    <div class="col"><label>إلى</label><input type="date" id="fTo"></div>
    <div class="col"><label>النمط</label><select id="fMode"><option value="per">منفصل لكل محل</option><option value="all">مجمّع للمحلات</option></select></div>
    <div class="col"><label>&nbsp;</label><button class="btn p" onclick="reportRange()">عرض التقرير</button></div>
    <div class="col"><label>&nbsp;</label><button class="btn o" onclick="window.print()">🖨️ طباعة PDF</button></div>
  </div><div id="rangeWrap"></div>
</section>

<section class="card" data-tab="loans">
  <h3>السُلف (تفاصيل + كشف)</h3>
  <div class="row"><div class="col"><input id="loanName" placeholder="اسم المُسلف"></div><div class="col"><input type="number" id="loanIn" placeholder="مبلغ السلفة (+)"></div><div class="col"><button class="btn g" onclick="addLoan()">➕ إضافة سلفة (تزيد كاش المحل)</button></div></div>
  <div class="row"><div class="col"><input id="loanPayName" list="loanList" placeholder="اسم المُسلف — سداد"></div><datalist id="loanList"></datalist><div class="col"><input type="number" id="loanOut" placeholder="مبلغ السداد (−)"></div><div class="col"><select id="loanSrc"><option value="store">من كاش المحل</option><option value="owner">من صندوق المالك</option></select></div><div class="col"><button class="btn p" onclick="payLoan()">💸 تسجيل سداد</button></div></div>
  <div class="row pr"><div class="col"><input id="loanStmtName" list="loanList" placeholder="اسم المسلف — كشف"></div><div class="col"><input type="date" id="loanFrom"></div><div class="col"><input type="date" id="loanTo"></div><div class="col"><button class="btn o" onclick="renderLoanStmt()">عرض كشف المسلف</button></div><div class="col"><button class="btn o" onclick="window.print()">🖨️ طباعة كشف</button></div></div>
  <div id="loansWrap" class="subtle"></div><div id="loanStmtWrap"></div>
</section>

<section class="card" data-tab="suppliers">
  <h3>التُجار (تفاصيل + كشف)</h3>
  <div class="row"><div class="col"><input id="supName" placeholder="اسم التاجر"></div><div class="col"><input type="number" id="supInv" placeholder="قيمة الفاتورة (+)"></div><div class="col"><button class="btn g" onclick="addInv()">➕ تسجيل فاتورة</button></div></div>
  <div class="row"><div class="col"><input id="supPayName" list="supList" placeholder="اسم التاجر — سداد"></div><datalist id="supList"></datalist><div class="col"><input type="number" id="supPayAmt" placeholder="مبلغ الدفعة (−)"></div><div class="col"><select id="supSrc"><option value="store">من كاش المحل</option><option value="owner">من صندوق المالك</option><option value="bank">من حساب البنك</option></select></div><div class="col"><button class="btn p" onclick="paySup()">💳 تسجيل دفعة</button></div></div>
  <div class="row pr"><div class="col"><input id="supStmtName" list="supList" placeholder="اسم التاجر — كشف"></div><div class="col"><input type="date" id="supFrom"></div><div class="col"><input type="date" id="supTo"></div><div class="col"><button class="btn o" onclick="renderSupStmt()">عرض كشف التاجر</button></div><div class="col"><button class="btn o" onclick="window.print()">🖨️ طباعة كشف</button></div></div>
  <div id="supWrap" class="subtle"></div><div id="supStmtWrap"></div>
</section>

<section class="card" data-tab="debts">
  <h3>الديون (العملاء)</h3>
  <div class="row"><div class="col"><input id="debtName" placeholder="اسم العميل"></div><div class="col"><input type="number" id="debtAmt" placeholder="قيمة الدين (+)"></div><div class="col"><input id="debtNote" placeholder="ملاحظة (اختياري)"></div><div class="col"><button class="btn g" onclick="addDebt()">➕ إضافة دين</button></div></div>
  <div class="row"><div class="col"><input id="debtPayName" list="debtList" placeholder="اسم العميل — سداد دين"></div><datalist id="debtList"></datalist><div class="col"><input type="number" id="debtPayAmt" placeholder="مبلغ السداد (−)"></div><div class="col"><select id="debtMethod"><option>كاش</option><option>بنك</option></select></div><div class="col"><button class="btn p" onclick="payDebt()">✅ تسجيل سداد دين</button></div></div>
  <div id="debtsWrap" class="subtle"></div>
</section>

<section class="card" data-tab="owner">
  <h3>صندوق المالك — مجمّع/كشف/تسوية/نسخ احتياطي</h3>
  <div class="subtle">
    <h4 style="margin:6px 0">إيداع/سحب</h4>
    <div class="row"><div class="col"><input type="number" id="ownIn" placeholder="مبلغ الإيداع"></div><div class="col"><input id="ownInNote" placeholder="ملاحظة (اختياري)"></div><div class="col"><button class="btn g" onclick="ownerDeposit()">⬆️ إيداع</button></div></div>
    <div class="row"><div class="col"><input type="number" id="ownOut" placeholder="مبلغ السحب"></div>
      <div class="col"><select id="ownBind"><option value="">— ربط (اختياري) —</option><option value="supplier">سداد تاجر</option><option value="loan">سداد مسلف</option></select></div>
      <div class="col"><input id="ownWho" list="ownBindList" placeholder="اكتب الاسم (اقتراح)"><datalist id="ownBindList"></datalist></div>
      <div class="col"><input id="ownOutNote" placeholder="ملاحظة (اختياري)"></div>
      <div class="col"><button class="btn r" onclick="ownerWithdraw()">⬇️ سحب</button></div>
    </div>
  </div>
  <div class="subtle"><h4 style="margin:6px 0">كشف الصندوق (مع الحذف)</h4><div class="row pr"><div class="col"><label>من</label><input type="date" id="ofFrom"></div><div class="col"><label>إلى</label><input type="date" id="ofTo"></div><div class="col"><label>&nbsp;</label><button class="btn p" onclick="renderOwner()">عرض الكشف</button></div><div class="col"><label>&nbsp;</label><button class="btn o" onclick="window.print()">🖨️ طباعة</button></div></div><div id="ownerWrap"></div></div>
  <div class="subtle"><h4 style="margin:6px 0">تقرير شهري مجمّع</h4><div class="row pr"><div class="col"><input type="month" id="mMonth"></div><div class="col"><button class="btn p" onclick="reportMonthly()">إنشاء التقرير</button></div><div class="col"><button class="btn o" onclick="window.print()">🖨️ طباعة</button></div></div><div id="monthlyWrap"></div></div>
  <div class="subtle pr"><h4 style="margin:6px 0">نسخ احتياطي</h4><div class="row"><div class="col"><button class="btn o" onclick="exportBackup()">⬇️ تصدير</button></div><div class="col"><label for="imp" class="btn g" style="display:inline-block;cursor:pointer;text-align:center">⬆️ استيراد</label><input id="imp" type="file" accept="application/json" style="display:none" onchange="importBackup(this.files[0])"/></div></div><div class="hint">يشمل المحلات والسلف والتجار والديون وصندوق المالك.</div></div>
  <div class="subtle"><h4 style="margin:6px 0">تجميع يوم واحد (تفصيل كل محل)</h4><div id="ownerAggWrap"></div></div>
</section>
</main>

<nav class="tabs pr">
  <div class="tab active"><button onclick="tab('input')">إدخال</button></div>
  <div class="tab"><button onclick="tab('daily')">يومي</button></div>
  <div class="tab"><button onclick="tab('range')">فترة/مجمّع</button></div>
  <div class="tab"><button onclick="tab('loans')">سُلف</button></div>
  <div class="tab"><button onclick="tab('suppliers')">تُجار</button></div>
  <div class="tab"><button onclick="tab('debts')">ديون</button></div>
  <div class="tab"><button onclick="tab('owner')">المالك</button></div>
</nav>

<script>
/* أساسيات */
const stores={s1:"روان بيبي",s2:"جنتل بيبي عبود",s3:"بسطة"};let cur="s1";
const qs=s=>document.querySelector(s),qsa=s=>Array.from(document.querySelectorAll(s));
const today=()=>new Date().toISOString().slice(0,10),uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,7);
const inR=(iso,a,b)=>{if(!iso)return false;const d=new Date(iso+"T00:00:00");return(!a||d>=new Date(a+"T00:00:00"))&&(!b||d<=new Date(b+"T00:00:00"));};
const sum=(a,f)=>a.reduce((x,y)=>x+f(y),0),p2=n=>String(n).padStart(2,"0");
function fmt(iso){if(!iso)return"";const d=new Date(iso+"T00:00:00"),days=["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];return `${days[d.getDay()]} ${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`}

/* تخزين */
const getS=(s=cur)=>JSON.parse(localStorage.getItem(s)||'{"sales":[],"expenses":[]}'), setS=(v,s=cur)=>localStorage.setItem(s,JSON.stringify(v));
const getO=()=>JSON.parse(localStorage.getItem("owner_fund")||'{"ledger":[]}'), setO=v=>localStorage.setItem("owner_fund",JSON.stringify(v));
const getL=()=>JSON.parse(localStorage.getItem("loans")||'{"people":{}}'), setL=v=>localStorage.setItem("loans",JSON.stringify(v));
const getSup=()=>JSON.parse(localStorage.getItem("suppliers")||'{"people":{}}'), setSup=v=>localStorage.setItem("suppliers",JSON.stringify(v));
const getD=()=>JSON.parse(localStorage.getItem("debts")||'{"people":{}}'), setD=v=>localStorage.setItem("debts",JSON.stringify(v));

/* اقتراحات أسماء */
function namesSup(){const S=getSup();return S.people?Object.keys(S.people):[]}
function namesLoan(){const L=getL();return L.people?Object.keys(L.people):[]}
function namesDebt(){const D=getD();return D.people?Object.keys(D.people):[]}
function refillLists(){
  const dl=qs("#allList"); if(dl){dl.innerHTML=[...new Set([...namesSup(),...namesLoan()])].map(n=>`<option value="${n}">`).join("")}
  const l1=qs("#loanList"); if(l1){l1.innerHTML=namesLoan().map(n=>`<option value="${n}">`).join("")}
  const l2=qs("#supList"); if(l2){l2.innerHTML=namesSup().map(n=>`<option value="${n}">`).join("")}
  const l3=qs("#debtList"); if(l3){l3.innerHTML=namesDebt().map(n=>`<option value="${n}">`).join("")}
  const l4=qs("#ownBindList"); if(l4){l4.innerHTML=[...namesSup(),...namesLoan()].map(n=>`<option value="${n}">`).join("")}
}
qs("#expBind").addEventListener("change",()=>{const t=qs("#expBind").value,dl=qs("#allList");if(!dl)return;let ns=[];if(t==="supplier")ns=namesSup();else if(t==="loan")ns=namesLoan();else ns=[...new Set([...namesSup(),...namesLoan()])];dl.innerHTML=ns.map(n=>`<option value="${n}">`).join("")});

/* تبويبات */
function chgStore(){cur=qs("#storeSel").value;renderLists()}
function tab(name){qsa("[data-tab]").forEach(el=>el.style.display=(el.getAttribute("data-tab")==name?"block":"none"));const order=["input","daily","range","loans","suppliers","debts","owner"];qsa(".tabs .tab").forEach((t,i)=>t.classList.toggle("active",order[i]===name));if(name==="input"){renderLists();refillLists()}if(name==="owner"){renderOwner();refillLists()}if(name==="loans"){renderLoans()}if(name==="suppliers"){renderSup()}if(name==="debts"){renderDebts()}}

/* إدخال مبيعات */
function addSale(){const a=+qs("#saleAmt").value||0,t=qs("#saleType").value,n=(qs("#saleNote").value||"").trim();if(!a){alert("أدخل مبلغ صحيح");return}const d=getS();d.sales.push({id:uid(),date:today(),type:t,amount:a,note:n,meta:{}});setS(d);qs("#saleAmt").value="";qs("#saleNote").value="";renderLists()}

/* مصاريف + ربط تلقائي */
function addExpense(){const desc=(qs("#expDesc").value||"").trim(),a=+qs("#expAmt").value||0,n=(qs("#expNote").value||"").trim(),bt=qs("#expBind").value,bn=(qs("#expBindName").value||"").trim();if(!desc||!a){alert("أدخل وصف ومبلغ");return}const d=getS();const exp={id:uid(),date:today(),type:"كاش",desc,amount:a,note:n,benefType:bt||null,benefName:bn||null};d.expenses.push(exp);setS(d);
 if(bt&&bn){if(bt==="supplier"){const S=getSup();S.people=S.people||{};S.people[bn]=S.people[bn]||{balance:0,history:[]};S.people[bn].balance-=a;S.people[bn].history.push({id:uid(),date:today(),type:"pay",amount:a,source:"كاش المحل",note:"دفعة (مصروف موجّه)",linkedExpenseId:exp.id});setSup(S);renderSup()}else if(bt==="loan"){const L=getL();L.people=L.people||{};L.people[bn]=L.people[bn]||{balance:0,history:[]};L.people[bn].balance-=a;L.people[bn].history.push({id:uid(),date:today(),type:"out",amount:a,source:"كاش المحل",note:"سداد (مصروف موجّه)",linkedExpenseId:exp.id});setL(L);renderLoans()}}
 qs("#expDesc").value="";qs("#expAmt").value="";qs("#expNote").value="";qs("#expBind").value="";qs("#expBindName").value="";renderLists()}
function delSale(id){if(!confirm("حذف عملية البيع؟"))return;const d=getS();const i=d.sales.findIndex(x=>x.id===id);if(i>-1){d.sales.splice(i,1);setS(d);renderLists()}}
function delExp(id){if(!confirm("حذف المصروف؟ سيتم عكس الربط إن وجد."))return;const d=getS();const i=d.expenses.findIndex(x=>x.id===id);if(i===-1)return;const r=d.expenses[i];if(r.benefType&&r.benefName){if(r.benefType==="supplier"){const S=getSup();if(S.people&&S.people[r.benefName]){S.people[r.benefName].balance+=+r.amount;S.people[r.benefName].history.push({id:uid(),date:today(),type:"revert",amount:r.amount,note:"إلغاء مصروف موجّه"});setSup(S);renderSup()}}else if(r.benefType==="loan"){const L=getL();if(L.people&&L.people[r.benefName]){L.people[r.benefName].balance+=+r.amount;L.people[r.benefName].history.push({id:uid(),date:today(),type:"revert",amount:r.amount,note:"إلغاء مصروف موجّه"});setL(L);renderLoans()}}}d.expenses.splice(i,1);setS(d);renderLists()}
function renderLists(){const d=getS(),rs=d.sales.slice(-40).reverse(),re=d.expenses.slice(-40).reverse();qs("#recentSales").innerHTML=rs.length?rs.map(v=>`<div class="it"><div class="m">${v.date} — <span class="badge">${v.type}</span> ${v.note?("— <i>"+v.note+"</i>"):""}</div><div><b>${v.amount}</b></div><div><button class="btn r" onclick="delSale('${v.id}')">حذف</button></div></div>`).join(""):'<div class="hint">لا توجد مبيعات</div>';qs("#recentExp").innerHTML=re.length?re.map(v=>{const link=(v.benefType&&v.benefName)?` — <b>موجّه: ${v.benefType==="supplier"?"تاجر":"مسلف"} (${v.benefName})</b>`:"";return `<div class="it"><div class="m">${v.date} — <span class="badge">${v.type}</span> — ${v.desc}${link} ${v.note?("— <i>"+v.note+"</i>"):""}</div><div><b>${v.amount}</b></div><div><button class="btn r" onclick="delExp('${v.id}')">حذف</button></div></div>`}).join(""):'<div class="hint">لا توجد مصاريف</div>';refillLists()}

/* تقارير */
function totals(arr,key='type'){return{cs:sum(arr,x=>x[key]==="كاش"?+x.amount:0),bn:sum(arr,x=>x[key]==="بنك"?+x.amount:0)}}
function reportDaily(){const date=qs("#rDate").value||today(),st=qs("#rStore").value||cur,d=JSON.parse(localStorage.getItem(st)||'{"sales":[],"expenses":[]}'),s=d.sales.filter(x=>x.date===date),e=d.expenses.filter(x=>x.date===date),ts=totals(s),te=totals(e);const nc=ts.cs-te.cs,nb=ts.bn-te.bn;const r1=s.map(x=>`<tr><td>${x.date}</td><td>${x.type}</td><td>${x.amount}</td><td>${x.note||""}</td></tr>`).join("")||'<tr><td colspan="4">لا يوجد مبيعات</td></tr>';const r2=e.map(x=>`<tr><td>${x.date}</td><td>${x.type}</td><td>${x.desc}</td><td>${x.amount}</td><td>${(x.benefType&&x.benefName)?(x.benefType==='supplier'?'تاجر: ':'مسلف: ')+x.benefName:(x.note||'')}</td></tr>`).join("")||'<tr><td colspan="5">لا يوجد مصاريف</td></tr>';qs("#dailyWrap").innerHTML=`<div class="page"><h2 style="margin:0 0 6px">التقرير اليومي — ${stores[st]}</h2><div class="hint">تاريخ التقرير: <b>${fmt(date)}</b> — الطباعة: <b>${fmt(today())}</b></div><div class="sep"></div><div class="kpi"><div class="box"><b>${ts.cs}</b>مبيعات كاش</div><div class="box"><b>${ts.bn}</b>مبيعات بنك</div><div class="box"><b>${te.cs}</b>مصروفات كاش</div><div class="box"><b>${te.bn}</b>مصروفات بنك</div></div><h3>تفاصيل المبيعات</h3><table><thead><tr><th>التاريخ</th><th>النوع</th><th>المبلغ</th><th>ملاحظات</th></tr></thead><tbody>${r1}</tbody></table><h3>تفاصيل المصاريف</h3><table><thead><tr><th>التاريخ</th><th>النوع</th><th>الوصف</th><th>المبلغ</th><th>ملاحظات/ربط</th></tr></thead><tbody>${r2}</tbody></table><div style="margin-top:10px;display:flex;gap:14px;justify-content:flex-end"><div><b>صافي الكاش:</b> ${nc}</div><div><b>صافي البنك:</b> ${nb}</div><div><b>إجمالي الصافي:</b> ${nc+nb}</div></div><div style="margin-top:28px;display:flex;justify-content:space-between"><div>توقيع المالك: عبد الله أبو عوض _________</div><div>توقيع المدير المالي: _________</div></div></div>`}
function reportRange(){const f=qs("#fFrom").value||today().slice(0,8)+"01",t=qs("#fTo").value||today(),m=qs("#fMode").value||"per",shops=Object.keys(stores);if(m==="all"){let SS=[],EE=[];shops.forEach(s=>{const d=getS(s);SS=SS.concat(d.sales.filter(x=>inR(x.date,f,t)));EE=EE.concat(d.expenses.filter(x=>inR(x.date,f,t)))});const ts=totals(SS),te=totals(EE),nc=ts.cs-te.cs,nb=ts.bn-te.bn;qs("#rangeWrap").innerHTML=`<div class="page"><h2 style="margin:0 0 6px">تقرير مجمّع — كل المحلات</h2><div class="hint">الفترة: <b>${f}</b> → <b>${t}</b> — الطباعة: <b>${fmt(today())}</b></div><div class="sep"></div><table><thead><tr><th>المؤشر</th><th>القيمة</th></tr></thead><tbody><tr><td>مبيعات كاش</td><td>${ts.cs}</td></tr><tr><td>مبيعات بنك</td><td>${ts.bn}</td></tr><tr><td>مصروفات كاش</td><td>${te.cs}</td></tr><tr><td>مصروفات بنك</td><td>${te.bn}</td></tr><tr><td><b>صافي الكاش</b></td><td><b>${nc}</b></td></tr><tr><td><b>صافي البنك</b></td><td><b>${nb}</b></td></tr><tr><td><b>إجمالي الصافي</b></td><td><b>${nc+nb}</b></td></tr></tbody></table><div style="margin-top:28px;display:flex;justify-content:space-between"><div>توقيع المالك: عبد الله أبو عوض _________</div><div>توقيع المدير المالي: _________</div></div></div>`}else{let H='';shops.forEach(s=>{const d=getS(s),S=d.sales.filter(x=>inR(x.date,f,t)),E=d.expenses.filter(x=>inR(x.date,f,t)),ts=totals(S),te=totals(E),nc=ts.cs-te.cs,nb=ts.bn-te.bn;H+=`<div class="page"><h2 style="margin:0 0 6px">تقرير فترة — ${stores[s]}</h2><div class="hint">الفترة: <b>${f}</b> → <b>${t}</b> — الطباعة: <b>${fmt(today())}</b></div><div class="sep"></div><table><thead><tr><th>المؤشر</th><th>القيمة</th></tr></thead><tbody><tr><td>مبيعات كاش</td><td>${ts.cs}</td></tr><tr><td>مبيعات بنك</td><td>${ts.bn}</td></tr><tr><td>مصروفات كاش</td><td>${te.cs}</td></tr><tr><td>مصروفات بنك</td><td>${te.bn}</td></tr><tr><td><b>صافي الكاش</b></td><td><b>${nc}</b></td></tr><tr><td><b>صافي البنك</b></td><td><b>${nb}</b></td></tr><tr><td><b>إجمالي الصافي</b></td><td><b>${nc+nb}</b></td></tr></tbody></table><div style="margin-top:28px;display:flex;justify-content:space-between"><div>توقيع المالك: عبد الله أبو عوض _________</div><div>توقيع المدير المالي: _________</div></div></div>`});qs("#rangeWrap").innerHTML=H}}
/* معاينة تجميع يوم لكل محل */
function previewAgg(){const day=qs("#aggDay").value||today(),shops=Object.keys(stores);let rows='',TC=0,TB=0;shops.forEach(s=>{const d=getS(s),cs=sum(d.sales.filter(x=>x.date===day&&x.type==="كاش"),x=>+x.amount),bs=sum(d.sales.filter(x=>x.date===day&&x.type==="بنك"),x=>+x.amount),ce=sum(d.expenses.filter(x=>x.date===day&&x.type==="كاش"),x=>+x.amount),be=sum(d.expenses.filter(x=>x.date===day&&x.type==="بنك"),x=>+x.amount),nc=cs-ce,nb=bs-be;TC+=Math.max(0,nc);TB+=Math.max(0,nb);rows+=`<tr><td>${stores[s]}</td><td>${cs}</td><td>${ce}</td><td><b>${nc}</b></td><td>${bs}</td><td>${be}</td><td><b>${nb}</b></td></tr>`});qs("#aggWrap").innerHTML=`<div class="page"><h3 style="margin:0 0 6px">معاينة تحصيل اليوم — ${day}</h3><table><thead><tr><th>المحل</th><th>مبيعات كاش</th><th>مصروفات كاش</th><th>صافي كاش</th><th>مبيعات بنك</th><th>مصروفات بنك</th><th>صافي بنك</th></tr></thead><tbody>${rows}</tbody><tfoot><tr><th>المجموع</th><th colspan="2"></th><th>${TC}</th><th colspan="2"></th><th>${TB}</th></tr></tfoot></table><div class="hint">يُرحَّل للصندوق <b>صافي الكاش فقط</b>.</div></div>`}

/* تسوية صندوق المالك */
function updOwnerUI(){const O=getO(),ins=sum(O.ledger,x=>x.type==='in'?+x.amount:0),outs=sum(O.ledger,x=>x.type==='out'?+x.amount:0);qs("#ownerBal").textContent=(ins-outs)}
function rmSettle(day,scope,storeId=null){const O=getO();for(let i=O.ledger.length-1;i>=0;i--){const e=O.ledger[i],m=e.meta||{};if(e.date===day&&m&&m.kind==='settle'&&m.scope===scope&&(scope==='aggregate'||m.storeId===storeId)){O.ledger.splice(i,1)}}setO(O)}
function settleOne(){const day=qs("#today").value||today(),st=cur,d=getS(st),cs=sum(d.sales.filter(x=>x.date===day&&x.type==="كاش"),x=>+x.amount),bs=sum(d.sales.filter(x=>x.date===day&&x.type==="بنك"),x=>+x.amount),ce=sum(d.expenses.filter(x=>x.date===day&&x.type==="كاش"),x=>+x.amount),be=sum(d.expenses.filter(x=>x.date===day&&x.type==="بنك"),x=>+x.amount),nc=cs-ce,nb=bs-be;rmSettle(day,'single',st);const O=getO();if(nc>0){O.ledger.push({id:uid(),date:day,type:"in",amount:+nc,note:`ترحيل ${stores[st]} — (كاش=${nc} / بنك=${nb})`,meta:{kind:"settle",scope:"single",storeId:st,netCash:nc,netBank:nb}});setO(O);updOwnerUI();alert("تمت تسوية المحل")}else{setO(O);updOwnerUI();alert("لا يوجد كاش فائض")}renderOwner()}
function settleAll(){const day=qs("#today").value||today(),shops=Object.keys(stores);let tot=0,det=[];shops.forEach(s=>{const d=getS(s),cs=sum(d.sales.filter(x=>x.date===day&&x.type==="كاش"),x=>+x.amount),bs=sum(d.sales.filter(x=>x.type==="بنك"&&x.date===day),x=>+x.amount),ce=sum(d.expenses.filter(x=>x.date===day&&x.type==="كاش"),x=>+x.amount),be=sum(d.expenses.filter(x=>x.date===day&&x.type==="بنك"),x=>+x.amount),nc=cs-ce,nb=bs-be;if(nc>0)tot+=nc;det.push({storeId:s,storeName:stores[s],netCash:nc,netBank:nb})});rmSettle(day,'aggregate');const O=getO();if(tot>0){O.ledger.push({id:uid(),date:day,type:"in",amount:+tot,note:`ترحيل مجمّع: `+det.map(d=>`${d.storeName} ك=${d.netCash}/ب=${d.netBank}`).join(" | "),meta:{kind:"settle",scope:"aggregate",detail:det}});setO(O);updOwnerUI();alert("تم ترحيل إجمالي كاش = "+tot)}else{setO(O);updOwnerUI();alert("لا يوجد كاش فائض")}renderOwner()}

/* سلف */
function renderLoans(){const L=getL(),ns=Object.keys(L.people||{});if(!ns.length){qs("#loansWrap").innerHTML='<div class="hint">لا توجد سلف</div>';refillLists();return}
 const rows=ns.map(n=>`<tr><td>${n}</td><td>${L.people[n].balance||0}</td><td><button class="btn r" onclick="delLoanPerson('${n.replace(/'/g,"\\'")}')">🗑 حذف</button></td></tr>`).join("");
 const tx=[];ns.forEach(n=>(L.people[n].history||[]).slice(-50).forEach(h=>tx.push({name:n,...h})));tx.sort((a,b)=>(a.date||"").localeCompare(b.date||"")).reverse();
 const txRows=tx.length?tx.map(h=>`<tr><td>${h.date||""}</td><td>${h.name}</td><td>${h.type==='in'?'سلفة (+)':(h.type==='out'?'سداد (−)':(h.type==='revert'?'إلغاء':''))}</td><td>${h.amount||0}</td><td>${h.note||""}</td></tr>`).join(""):`<tr><td colspan="5">لا حركات</td></tr>`;
 qs("#loansWrap").innerHTML=`<h4>أرصدة</h4><table><thead><tr><th>الاسم</th><th>الرصيد</th><th>إجراء</th></tr></thead><tbody>${rows}</tbody></table><h4 style="margin-top:10px">تفاصيل آخر الحركات</h4><table><thead><tr><th>التاريخ</th><th>الاسم</th><th>النوع</th><th>المبلغ</th><th>ملاحظة</th></tr></thead><tbody>${txRows}</tbody></table>`;refillLists()}
function addLoan(){const n=(qs("#loanName").value||"").trim(),a=+qs("#loanIn").value||0;if(!n||!a){alert("ادخل اسم ومبلغ");return}const L=getL();L.people=L.people||{};L.people[n]=L.people[n]||{balance:0,history:[]};L.people[n].balance+=a;L.people[n].history.push({id:uid(),date:today(),type:"in",amount:a,note:"سلفة للمحل"});setL(L);const d=getS();d.sales.push({id:uid(),date:today(),type:"كاش",amount:a,note:`سلفة من ${n} (غير مبيعات)`,meta:{kind:"loanIn",lender:n}});setS(d);qs("#loanName").value="";qs("#loanIn").value="";renderLoans();renderLists()}
function payLoan(){const n=(qs("#loanPayName").value||"").trim(),a=+qs("#loanOut").value||0,src=qs("#loanSrc").value;if(!n||!a){alert("اسم/مبلغ");return}const L=getL();if(!L.people||!L.people[n]){alert("لا يوجد هذا المسلف");return}L.people[n].balance-=a;L.people[n].history.push({id:uid(),date:today(),type:"out",amount:a,source:(src==='store'?'كاش المحل':'صندوق المالك'),note:`سداد من ${src==='store'?'كاش المحل':'صندوق المالك'}`});setL(L);if(src==='store'){const d=getS();d.expenses.push({id:uid(),date:today(),type:"كاش",desc:`سداد سلفة (${n})`,amount:a,note:"من كاش المحل",benefType:"loan",benefName:n});setS(d);renderLists()}else{const O=getO();O.ledger.push({id:uid(),date:today(),type:"out",amount:a,note:`سداد سلفة (${n})`,meta:{kind:"manual",bindType:"loan",bindName:n}});setO(O);updOwnerUI()}qs("#loanPayName").value="";qs("#loanOut").value="";renderLoans();renderOwner()}
function delLoanPerson(n){if(!confirm(`حذف المسلف "${n}" وكل معاملاته؟`))return;const L=getL();if(L.people&&L.people[n]){delete L.people[n];setL(L);renderLoans();refillLists();alert("تم الحذف")}}
function renderLoanStmt(){const n=(qs("#loanStmtName").value||"").trim(),f=qs("#loanFrom").value||today().slice(0,8)+"01",t=qs("#loanTo").value||today();const L=getL();if(!n||!L.people||!L.people[n]){qs("#loanStmtWrap").innerHTML='<div class="hint">اختر اسم صحيح</div>';return}const h=(L.people[n].history||[]).filter(x=>inR(x.date,f,t));const rows=h.length?h.map(x=>`<tr><td>${x.date}</td><td>${x.type==='in'?'سلفة (+)':'سداد (−)'}</td><td>${x.amount}</td><td>${x.note||''}</td></tr>`).join(""):`<tr><td colspan="4">لا توجد حركات</td></tr>`;qs("#loanStmtWrap").innerHTML=`<div class="page"><h3 style="margin:0 0 6px">كشف حساب — مسلف: ${n}</h3><div class="hint">الفترة: ${f} → ${t}</div><table><thead><tr><th>التاريخ</th><th>النوع</th><th>المبلغ</th><th>ملاحظة</th></tr></thead><tbody>${rows}</tbody></table><div style="margin-top:8px"><b>الرصيد الحالي:</b> ${(L.people[n].balance||0)}</div></div>`}

/* تجار */
function renderSup(){const S=getSup(),ns=Object.keys(S.people||{});if(!ns.length){qs("#supWrap").innerHTML='<div class="hint">لا يوجد تجار</div>';refillLists();return}
 const rows=ns.map(n=>`<tr><td>${n}</td><td>${S.people[n].balance||0}</td><td><button class="btn r" onclick="delSup('${n.replace(/'/g,"\\'")}')">🗑 حذف</button></td></tr>`).join("");
 const tx=[];ns.forEach(n=>(S.people[n].history||[]).slice(-60).forEach(h=>tx.push({name:n,...h})));tx.sort((a,b)=>(a.date||"").localeCompare(b.date||"")).reverse();
 const txRows=tx.length?tx.map(h=>`<tr><td>${h.date||""}</td><td>${h.name}</td><td>${h.type==='invoice'?'فاتورة (+)':(h.type==='pay'?'دفعة (−)':(h.type==='revert'?'إلغاء':''))}</td><td>${h.amount||0}</td><td>${h.note||""}</td></tr>`).join(""):`<tr><td colspan="5">لا حركات</td></tr>`;
 qs("#supWrap").innerHTML=`<h4>أرصدة</h4><table><thead><tr><th>التاجر</th><th>الرصيد (مديونية)</th><th>إجراء</th></tr></thead><tbody>${rows}</tbody></table><h4 style="margin-top:10px">تفاصيل آخر الحركات</h4><table><thead><tr><th>التاريخ</th><th>الاسم</th><th>النوع</th><th>المبلغ</th><th>ملاحظة</th></tr></thead><tbody>${txRows}</tbody></table>`;refillLists()}
function addInv(){const n=(qs("#supName").value||"").trim(),a=+qs("#supInv").value||0;if(!n||!a){alert("اسم/قيمة فاتورة");return}const S=getSup();S.people=S.people||{};S.people[n]=S.people[n]||{balance:0,history:[]};S.people[n].balance+=a;S.people[n].history.push({id:uid(),date:today(),type:"invoice",amount:a,note:"فاتورة مشتريات"});setSup(S);qs("#supName").value="";qs("#supInv").value="";renderSup()}
function paySup(){const n=(qs("#supPayName").value||"").trim(),a=+qs("#supPayAmt").value||0,src=qs("#supSrc").value;if(!n||!a){alert("اسم/مبلغ");return}const S=getSup();if(!S.people||!S.people[n]){alert("لا يوجد هذا التاجر");return}S.people[n].balance-=a;S.people[n].history=S.people[n].history||[];S.people[n].history.push({id:uid(),date:today(),type:"pay",amount:a,source:(src==='store'?'كاش المحل':(src==='owner'?'صندوق المالك':'البنك')),note:`دفعة من ${src==='store'?'كاش المحل':(src==='owner'?'صندوق المالك':'حساب البنك')}`});setSup(S);
 if(src==='store'){const d=getS();d.expenses.push({id:uid(),date:today(),type:"كاش",desc:`دفعة تاجر (${n})`,amount:a,note:"من كاش المحل",benefType:"supplier",benefName:n});setS(d);renderLists()}
 else if(src==='owner'){const O=getO();O.ledger.push({id:uid(),date:today(),type:"out",amount:a,note:`دفعة تاجر (${n})`,meta:{kind:"manual",bindType:"supplier",bindName:n}});setO(O);updOwnerUI()}
 else{const d=getS();d.expenses.push({id:uid(),date:today(),type:"بنك",desc:`دفعة تاجر (${n})`,amount:a,note:"من البنك",benefType:"supplier",benefName:n});setS(d);renderLists()}
 qs("#supPayName").value="";qs("#supPayAmt").value="";renderSup();renderOwner()}
function delSup(n){if(!confirm(`حذف التاجر "${n}" وكل معاملاته؟`))return;const S=getSup();if(S.people&&S.people[n]){delete S.people[n];setSup(S);renderSup();refillLists();alert("تم الحذف")}}
function renderSupStmt(){const n=(qs("#supStmtName").value||"").trim(),f=qs("#supFrom").value||today().slice(0,8)+"01",t=qs("#supTo").value||today();const S=getSup();if(!n||!S.people||!S.people[n]){qs("#supStmtWrap").innerHTML='<div class="hint">اختر اسم تاجر صحيح</div>';return}const h=(S.people[n].history||[]).filter(x=>inR(x.date,f,t));const rows=h.length?h.map(x=>`<tr><td>${x.date}</td><td>${x.type==='invoice'?'فاتورة (+)':'دفعة (−)'}</td><td>${x.amount}</td><td>${x.note||''}</td></tr>`).join(""):`<tr><td colspan="4">لا توجد حركات</td></tr>`;qs("#supStmtWrap").innerHTML=`<div class="page"><h3 style="margin:0 0 6px">كشف حساب — تاجر: ${n}</h3><div class="hint">الفترة: ${f} → ${t}</div><table><thead><tr><th>التاريخ</th><th>النوع</th><th>المبلغ</th><th>ملاحظة</th></tr></thead><tbody>${rows}</tbody></table><div style="margin-top:8px"><b>الرصيد الحالي (مديونية):</b> ${(S.people[n].balance||0)}</div></div>`}

/* ديون (عملاء) */
function renderDebts(){const D=getD(),ns=Object.keys(D.people||{});if(!ns.length){qs("#debtsWrap").innerHTML='<div class="hint">لا توجد ديون</div>';refillLists();return}
 const rows=ns.map(n=>`<tr><td>${n}</td><td>${D.people[n].balance||0}</td><td><button class="btn r" onclick="delDebtor('${n.replace(/\'/g,"\\'")}')">🗑 حذف</button></td></tr>`).join("");
 qs("#debtsWrap").innerHTML=`<table><thead><tr><th>العميل</th><th>الرصيد</th><th>إجراء</th></tr></thead><tbody>${rows}</tbody></table>`}
function addDebt(){const n=(qs("#debtName").value||"").trim(),a=+qs("#debtAmt").value||0,nt=(qs("#debtNote").value||"").trim();if(!n||!a){alert("اسم/قيمة دين");return}const D=getD();D.people=D.people||{};D.people[n]=D.people[n]||{balance:0,history:[]};D.people[n].balance+=a;D.people[n].history.push({id:uid(),date:today(),type:"debt",amount:a,note:nt||"دين مبيعات"});setD(D);qs("#debtName").value="";qs("#debtAmt").value="";qs("#debtNote").value="";renderDebts();refillLists()}
function payDebt(){const n=(qs("#debtPayName").value||"").trim(),a=+qs("#debtPayAmt").value||0,m=qs("#debtMethod").value;if(!n||!a){alert("اسم/مبلغ");return}const D=getD();if(!D.people||!D.people[n]){alert("لا يوجد هذا العميل");return}D.people[n].balance-=a;D.people[n].history.push({id:uid(),date:today(),type:"pay",amount:a,note:`سداد دين (${m})`});setD(D);const d=getS();d.sales.push({id:uid(),date:today(),type:m,amount:a,note:`تحصيل دين من ${n}`,meta:{kind:"debtCollection"}});setS(d);qs("#debtPayName").value="";qs("#debtPayAmt").value="";renderDebts();renderLists()}
function delDebtor(n){if(!confirm(`حذف العميل "${n}" وكل سجلاته؟`))return;const D=getD();if(D.people&&D.people[n]){delete D.people[n];setD(D);renderDebts();refillLists();alert("تم الحذف")}}

/* صندوق المالك: إيداع/سحب/حذف/كشف */
function ownerDeposit(){const a=+qs("#ownIn").value||0,nt=(qs("#ownInNote").value||"").trim();if(!a){alert("أدخل قيمة إيداع");return}const O=getO();O.ledger.push({id:uid(),date:today(),type:"in",amount:a,note:nt||"إيداع يدوي",meta:{kind:"manual"}});setO(O);updOwnerUI();qs("#ownIn").value="";qs("#ownInNote").value="";renderOwner()}
function ownerWithdraw(){const a=+qs("#ownOut").value||0,bt=qs("#ownBind").value,who=(qs("#ownWho").value||"").trim(),nt=(qs("#ownOutNote").value||"").trim();if(!a){alert("أدخل قيمة السحب");return}const O=getO();O.ledger.push({id:uid(),date:today(),type:"out",amount:a,note:nt||(bt?(`سحب — سداد ${bt==='supplier'?'تاجر':'مسلف'} (${who})`):"سحب"),meta:{kind:"manual",bindType:bt||"",bindName:who||""}});setO(O);updOwnerUI();
 if(bt&&who){if(bt==='supplier'){const S=getSup();S.people=S.people||{};S.people[who]=S.people[who]||{balance:0,history:[]};S.people[who].balance-=a;S.people[who].history.push({id:uid(),date:today(),type:"pay",amount:a,source:"صندوق المالك",note:"دفعة (من صندوق المالك)"});setSup(S);renderSup()}else{const L=getL();L.people=L.people||{};L.people[who]=L.people[who]||{balance:0,history:[]};L.people[who].balance-=a;L.people[who].history.push({id:uid(),date:today(),type:"out",amount:a,source:"صندوق المالك",note:"سداد (من صندوق المالك)"});setL(L);renderLoans()}}
 qs("#ownOut").value="";qs("#ownOutNote").value="";qs("#ownBind").value="";qs("#ownWho").value="";renderOwner()}
function delOwner(id){if(!confirm("حذف هذا القيد من صندوق المالك؟ سيتم عكس الربط إن وجد."))return;const O=getO();const i=O.ledger.findIndex(e=>e.id===id);if(i===-1)return;const e=O.ledger[i],m=e.meta||{};if(e.type==="out"&&m.kind==="manual"&&m.bindType&&m.bindName){if(m.bindType==="supplier"){const S=getSup();if(S.people&&S.people[m.bindName]){S.people[m.bindName].balance+=+e.amount;S.people[m.bindName].history.push({id:uid(),date:today(),type:"revert",amount:e.amount,note:"إلغاء سحب من الصندوق"});setSup(S)}}else if(m.bindType==="loan"){const L=getL();if(L.people&&L.people[m.bindName]){L.people[m.bindName].balance+=+e.amount;L.people[m.bindName].history.push({id:uid(),date:today(),type:"revert",amount:e.amount,note:"إلغاء سحب من الصندوق"});setL(L)}}}O.ledger.splice(i,1);setO(O);updOwnerUI();renderOwner()}
function renderOwner(){const f=qs("#ofFrom").value||today().slice(0,8)+"01",t=qs("#ofTo").value||today(),O=getO(),rows=O.ledger.filter(x=>inR(x.date,f,t)),ins=sum(rows,x=>x.type==='in'?+x.amount:0),outs=sum(rows,x=>x.type==='out'?+x.amount:0);const tbl=rows.length?rows.map(e=>`<tr><td>${e.date}</td><td>${e.type==='in'?'تحصيل':'صرف'}</td><td>${e.amount}</td><td>${e.note||''}</td><td class="pr"><button class="btn r" onclick="delOwner('${e.id}')">حذف</button></td></tr>`).join(""):`<tr><td colspan="5">لا توجد حركات</td></tr>`;qs("#ownerWrap").innerHTML=`<div class="page"><h2 style="margin:0 0 6px">كشف صندوق المالك</h2><div class="hint">الفترة: <b>${f}</b> → <b>${t}</b> — الطباعة: <b>${today()}</b></div><div class="sep"></div><table><thead><tr><th>التاريخ</th><th>النوع</th><th>المبلغ</th><th>الملاحظة</th><th class="pr">إجراء</th></tr></thead><tbody>${tbl}</tbody></table><div style="margin-top:8px"><b>تحصيل:</b> ${ins} — <b>صرف:</b> ${outs} — <b>الرصيد:</b> ${ins-outs}</div><div style="margin-top:26px;display:flex;justify-content:space-between"><div>توقيع المالك: عبد الله أبو عوض _________</div><div>توقيع المدير المالي: _________</div></div></div>`;updOwnerUI(); renderOwnerAgg()}
function renderOwnerAgg(){const d=qs("#today").value||today(),shops=Object.keys(stores);let R='',tc=0,tb=0;shops.forEach(s=>{const S=getS(s),cs=sum(S.sales.filter(x=>x.date===d&&x.type==="كاش"),x=>+x.amount),bs=sum(S.sales.filter(x=>x.date===d&&x.type==="بنك"),x=>+x.amount),ce=sum(S.expenses.filter(x=>x.date===d&&x.type==="كاش"),x=>+x.amount),be=sum(S.expenses.filter(x=>x.date===d&&x.type==="بنك"),x=>+x.amount),nc=cs-ce,nb=bs-be;tc+=Math.max(0,nc);tb+=Math.max(0,nb);R+=`<tr><td>${stores[s]}</td><td>${cs}</td><td>${ce}</td><td><b>${nc}</b></td><td>${bs}</td><td>${be}</td><td><b>${nb}</b></td></tr>`});qs("#ownerAggWrap").innerHTML=`<table><thead><tr><th>المحل</th><th>مبيعات كاش</th><th>مصروفات كاش</th><th>صافي كاش</th><th>مبيعات بنك</th><th>مصروفات بنك</th><th>صافي بنك</th></tr></thead><tbody>${R}</tbody><tfoot><tr><th>المجموع</th><th colspan="2"></th><th>${tc}</th><th colspan="2"></th><th>${tb}</th></tr></tfoot></table><div class="hint">الصندوق يستقبل صافي الكاش فقط.</div>`}

/* شهري */
function reportMonthly(){const ym=(qs("#mMonth").value||today().slice(0,7));let SS=[],EE=[];Object.keys(stores).forEach(s=>{const d=getS(s);SS=SS.concat(d.sales.filter(x=>x.date.slice(0,7)===ym));EE=EE.concat(d.expenses.filter(x=>x.date.slice(0,7)===ym))});const ts=totals(SS),te=totals(EE),nc=ts.cs-te.cs,nb=ts.bn-te.bn;const O=getO(),rows=O.ledger.filter(x=>x.date.slice(0,7)===ym),ins=sum(rows,x=>x.type==='in'?+x.amount:0),outs=sum(rows,x=>x.type==='out'?+x.amount:0);qs("#monthlyWrap").innerHTML=`<div class="page"><h2 style="margin:0 0 6px">تقرير شهري مجمّع — ${ym}</h2><div class="hint">يشمل كل المحلات + صندوق المالك — الطباعة: <b>${today()}</b></div><div class="sep"></div><table><thead><tr><th>المؤشر</th><th>القيمة</th></tr></thead><tbody><tr><td>مبيعات كاش</td><td>${ts.cs}</td></tr><tr><td>مبيعات بنك</td><td>${ts.bn}</td></tr><tr><td>مصروفات كاش</td><td>${te.cs}</td></tr><tr><td>مصروفات بنك</td><td>${te.bn}</td></tr><tr><td><b>صافي الكاش</b></td><td><b>${nc}</b></td></tr><tr><td><b>صافي البنك</b></td><td><b>${nb}</b></td></tr><tr><td><b>إجمالي الصافي</b></td><td><b>${nc+nb}</b></td></tr><tr><td>تحصيلات صندوق المالك</td><td>${ins}</td></tr><tr><td>مصروفات صندوق المالك</td><td>${outs}</td></tr><tr><td><b>رصيد صندوق المالك خلال الشهر</b></td><td><b>${ins-outs}</b></td></tr></tbody></table><div style="margin-top:26px;display:flex;justify-content:space-between"><div>توقيع المالك: عبد الله أبو عوض _________</div><div>توقيع المدير المالي: _________</div></div></div>`}

/* نسخ احتياطي */
function exportBackup(){const payload={version:"final-packed-1",at:new Date().toISOString(),stores:{s1:getS("s1"),s2:getS("s2"),s3:getS("s3")},loans:getL(),suppliers:getSup(),debts:getD(),owner_fund:getO()};const blob=new Blob([JSON.stringify(payload)],{type:"application/json"});const a=document.createElement("a"),ts=new Date();a.href=URL.createObjectURL(blob);a.download=`backup-${ts.getFullYear()}${p2(ts.getMonth()+1)}${p2(ts.getDate())}-${p2(ts.getHours())}${p2(ts.getMinutes())}.json`;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(a.href),800)}
function importBackup(file){if(!file){alert("اختر ملف النسخة");return}const r=new FileReader();r.onload=e=>{try{const data=JSON.parse(e.target.result);if(!data||!data.stores)throw new Error("ملف غير صالح");localStorage.setItem("s1",JSON.stringify(data.stores.s1||{"sales":[],"expenses":[]}));
localStorage.setItem("s2",JSON.stringify(data.stores.s2||{"sales":[],"expenses":[]}));
localStorage.setItem("s3",JSON.stringify(data.stores.s3||{"sales":[],"expenses":[]}));
localStorage.setItem("owner_fund",JSON.stringify(data.owner_fund||{"ledger":[]}));
localStorage.setItem("loans",JSON.stringify(data.loans||{"people":{}}));
localStorage.setItem("suppliers",JSON.stringify(data.suppliers||{"people":{}}));
localStorage.setItem("debts",JSON.stringify(data.debts||{"people":{}}));
renderLists();renderLoans();renderSup();renderDebts();renderOwner();updOwnerUI();refillLists()}catch(err){alert("تعذر الاستيراد: "+err.message)}};r.readAsText(file)}

/* تهيئة + PWA */
document.addEventListener("DOMContentLoaded",()=>{const t=today();["today","rDate","ofFrom","fFrom","aggDay"].forEach(id=>{const x=qs("#"+id);if(x)x.value=t});const x1=qs("#ofTo");if(x1)x1.value=t;const x2=qs("#fTo");if(x2)x2.value=t;tab("input");renderLists();renderLoans();renderSup();renderDebts();renderOwner();updOwnerUI();refillLists();
 const manifest={"name":"نظام المحاسبة","short_name":"المحاسبة","start_url":"./","display":"standalone","background_color":"#eaf3ff","theme_color":"#58a8ff","icons":[{"src":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='256' height='256'%3E%3Crect width='100%25' height='100%25' fill='%2358a8ff'/%3E%3Ctext x='50%25' y='55%25' text-anchor='middle' font-size='120' fill='white'%3E%F0%9F%93%8A%3C/text%3E%3C/svg%3E","sizes":"256x256","type":"image/svg+xml"}]};const mblob=new Blob([JSON.stringify(manifest)],{type:"application/manifest+json"}),murl=URL.createObjectURL(mblob);const link=document.createElement("link");link.rel="manifest";link.href=murl;document.head.appendChild(link);
 if("serviceWorker" in navigator){const sw=`const C='acc-pwa-v1',A=['./',''];self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll(A)).then(()=>self.skipWaiting()))});self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});self.addEventListener('fetch',e=>{const r=e.request;e.respondWith(caches.match(r).then(m=>m||fetch(r).then(res=>{if(r.method==='GET'&&new URL(r.url).origin===location.origin){const cp=res.clone();caches.open(C).then(c=>c.put(r,cp))}return res}).catch(()=>caches.match('./'))))});`;const swb=new Blob([sw],{type:"text/javascript"}),swu=URL.createObjectURL(swb);navigator.serviceWorker.register(swu).catch(console.error)}})
</script>
</body></html>
